5A - Env2Jax
```{r}

#group <- 'E' #can change to other mouse groups too

samples <- c('J','E','JEJ', 'JEE')

#FOR SOME REASon, pre FMT stops after generating associations, just keep running last few lines

for (i in 1:length(samples)) {
  set.seed(123)
  print(samples[i])
  
    group <- samples[i]
    
#Need to duplicate df to mirror heatmap
PrevalentSet <-
  rbind(
  read.csv(
     paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
        filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>%
    #filter(Order_OTU1 == 'Bacteroidia' | Order_OTU1 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU1, Order_OTU1) %>% distinct(),
     read.csv(
       paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
            filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>%
    #filter(Order_OTU2 == 'Bacteroidia'  | Order_OTU2 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU2, Order_OTU2) %>% distinct() %>%
   rename(c("OTU1ColorName"="OTU2ColorName", "OTU2ColorName"="OTU1ColorName", "Class_OTU1"="Class_OTU2", "Order_OTU1"="Order_OTU2"))) %>%
  mutate(Zscore = ifelse(is.infinite(Zscore), max(Zscore[!is.infinite(Zscore)], na.rm = TRUE), Zscore)) %>% ungroup() %>% mutate(Zscore = log2_signed(Zscore))


temp <- read.csv("../misc/bugColors_MapsSeq.csv")
bugColors<- setNames(c(scales::hue_pal()(length(unique(temp$X)))), c(levels(as.factor(temp$X)))) 

PrevalentSet.cast <- PrevalentSet %>%
  filter(OTU1ColorName != 'NA') %>% 
  select(OTU1ColorName, OTU2ColorName, Zscore) %>% distinct() %>% 
  reshape2::dcast(OTU1ColorName~OTU2ColorName)

#clustering
PrevalentSet.cast.matrix <- as.matrix(PrevalentSet.cast[, -c(1)])
#PrevalentSet.cast.matrix[is.infinite(PrevalentSet.cast.matrix)] <- 50

#replace NAs NOT NECESSARY IF USING PROXY COMMAND
PrevalentSet.cast.matrix <- ifelse(is.na(PrevalentSet.cast.matrix), 0 , PrevalentSet.cast.matrix)


#continue with clustering
rownames(PrevalentSet.cast.matrix) <- PrevalentSet.cast$OTU1ColorName

#Calculate correlation of zscore and compute distance
disttest <- dist(sqrt(2*(1-as.matrix(cor(PrevalentSet.cast.matrix)))))

# cluster using ward.D2
clustres <- hclust(disttest,"ward.D2")

#get subgroups 
branchcuts <- cutree(clustres, k = 4) %>% cbind(., order=clustres$order) %>% as.data.frame() %>% rownames_to_column('temp') %>% separate(temp, sep = '>', into = c('waste', 'OTU')) %>% select(-waste) %>% rename(subgroup='.')



PrevalentSet.cast$order <- clustres$order
PrevalentSet.cast.dendro <- as.dendrogram(clustres) #create dendrogram

#which clustering method strongest...
# methods to assess 
#m <- c( "average", "single", "complete", "ward")
#names(m) <- c( "average", "single", "complete", "ward")

# function to compute coefficient
#ac <- function(x) {
#  cluster::agnes(PrevalentSet.cast.matrix, method = x)$ac
#}

#map_dbl(m, ac)
####ward strongest clusterer


# Create dendro
dendro.plot <- ggdendro::ggdendrogram(data = PrevalentSet.cast.dendro, 
                            rotate=FALSE) + 
                  coord_flip() + scale_y_reverse() + scale_x_reverse() + 
                  theme(axis.line = element_blank(),
                        axis.text = element_blank()) + theme_void()


# Preview the plot
print(dendro.plot)
#write out if need be
PrevalentSet.cast.long <- reshape2::melt(PrevalentSet.cast, id = c("OTU1ColorName", "order")) %>% distinct()

#reorder
#PrevalentSet.cast.order <- order.dendrogram(PrevalentSet.cast.dendro)
PrevalentSet.cast.long$OTU1ColorName <- factor(x = PrevalentSet.cast.long$OTU1ColorName,
                               levels = PrevalentSet.cast$OTU1ColorName[PrevalentSet.cast$order], 
                               ordered = TRUE)

temp <- PrevalentSet.cast.long %>% 
          select(OTU1ColorName, OTU2ColorName=variable, Zscore = 'value') %>% 
          left_join(., 
            (PrevalentSet %>% 
               select(OTU1ColorName, OTU2ColorName, Significant, 
                      Class_OTU1)), 
            by = c("OTU1ColorName", "OTU2ColorName")) %>% 
          left_join(., select(PrevalentSets, OTU1, OTU1ColorName)) %>% distinct() %>%
          left_join(., select(otumapping, OTU1=OTU, log2FoldChange, emergence)) %>% distinct() %>%
    mutate(Zscore = replace_na(Zscore, 0))

xyz <- (PrevalentSet.cast %>% select(OTU1ColorName,order) %>% mutate(OTU1ColorName= as.factor(OTU1ColorName)) %>% arrange(order))$OTU1ColorName

ordered_OTU1_names <- rownames(PrevalentSet.cast.matrix)[PrevalentSet.cast$order]
print(ordered_OTU1_names)

# Assuming ordered_otu1_names is a list of vectors
extracted_list <- lapply(ordered_OTU1_names, function(x) str_extract(x, "(?<=>)[^<]+"))

# Convert the list to a data frame
df <- data.frame(OTU = unlist(extracted_list))

# Add the 'group' column. Assuming the group variable is already defined.
df$MouseGroup <- group

# Write to CSV
write.csv(df, paste("../tables/dendrogram_order_", group, ".csv", sep = ''), row.names = FALSE)


temp$OTU1ColorName <- factor(temp$OTU1ColorName, levels = xyz)
temp$OTU2ColorName <- factor(temp$OTU2ColorName, levels = xyz)


y_min <- round(min(temp$Zscore, na.rm = T),digits = -1)
y_max <- round(max(temp$Zscore, na.rm = T),digits = -1)

clustr <- temp %>% 
                 ggplot(aes(x = OTU1ColorName, y = OTU2ColorName, fill = Zscore)) +
  geom_tile(color = 'white') +
  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0, breaks = seq(y_min, y_max, by = (y_max-y_min)/5)) + #,limits=c(-.5,.5)) +
  theme_cowplot() +
  #scale_y_discrete(limits = xyz) +
  #scale_x_discrete(limits = xyz) +
  scale_y_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  labs(fill = "Co-Assoc.\nScore")  +
  xlab("OTU X") +
  ylab("OTU Y") +
  geom_point(data=function(x){x[temp$Significant == TRUE, ]},size=.3,color="black", fill = 'black')



corplot_fam <- PrevalentSet %>% select(OTU1ColorName, Class_OTU1) %>% distinct() %>%
  ggplot(., aes(OTU1ColorName, y = 1, fill = Class_OTU1)) +
  geom_tile(color = 'black') +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) +
  scale_fill_manual(values = bugColors) +
  theme_clean() + 
    theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  theme(legend.position = "right")

corplot_fam

order_info <- rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])

corplot_fc <-  temp %>% select(OTU1ColorName, emergence) %>% na.omit() %>% distinct() %>%
  ggplot(., aes(OTU1ColorName, y = 1, fill = emergence)) +
  geom_tile(color = 'black') +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_fill_manual(values = c('#000000','#ff0000', 'grey80')) +
  theme_cowplot() +
    theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  theme(legend.position = "right")

corplot_fc

ggsave(paste("../figs/fig5/", group, "/emergence_mapSeq_", group, ".pdf",sep = ''), corplot_fc,width = 6, height = 1.5)

#OTU1 missing from these...
corplot_type <- data.frame(OTU1ColorName = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) %>%
  left_join(., select(PrevalentSets, OTU1ColorName, OTU1Type) %>% distinct(), by = 'OTU1ColorName') %>%
    mutate(OTU1Type= ifelse(OTU1ColorName == "<b style='color:#377EB8'>Otu1", 'Shared Taxa', OTU1Type)) %>%
  ggplot(.,aes(OTU1ColorName, y = 1, fill = OTU1Type)) +
                 geom_tile(color = 'black') + theme_void() +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_fill_manual(values = c('#377EB8', '#E41A1C','#828382')) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 8),
    axis.text.y = ggtext::element_markdown(size = 8)) +
  labs(fill = "Class", x = "OTU 1") 
corplot_type

#print out subgroups for J and E on JEJ loop
if (group == 'JEJ') {
  
  for (group_iteration in c('J', 'E')) {
    
    group <- group_iteration

    subgroup_type <- data.frame(OTU1ColorName = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) %>%
       left_join(., select(PrevalentSets, OTU1ColorName, OTU=OTU1) %>% distinct(), by = 'OTU1ColorName') %>% 
       mutate(OTU= ifelse(OTU1ColorName == "<b style='color:#377EB8'>Otu1", 'Otu1', OTU)) %>%
       left_join(., filter(subgroups, MouseGroup == group)) %>% na.omit() %>% mutate(subgroup = paste('Subgroup', subgroup)) %>%
       ggplot(.,aes(OTU1ColorName, y = 1, fill = subgroup)) +
                    geom_tile(color = 'black') + theme_void() +
    scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
       scale_fill_manual(values = c('#3b4d81', '#8967ac','#5aadc5', '#54b948')) +
       labs(x='', y='', fill='Spatial Subgroup') +
      theme_void() +
       theme(
         axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 8),
         axis.text.y = element_blank(),
         axis.line = element_blank(),
         axis.ticks = element_blank(), legend.position = 'top') +
       labs(fill = "Class", x = "OTU 1") + facet_wrap(~MouseGroup,nrow = 2)

    # subgroup_type
    ggsave(paste("../figs/fig5/JEJ/subgroup_mapSeq_", group, ".pdf",sep = ''), subgroup_type,width = 4.5, height = 3)
    
  }

} else {
  message("The group variable is not 'JEJ'. Function execution stopped.")
}


ggsave(paste("../figs/fig5/", group, "/type_mapSeq_", group, ".pdf",sep = ''), corplot_type, 
       width = 6, height = 1.5)

cowplot::plot_grid(dendro.plot, clustr, corplot_fam, nrow = 1, rel_widths = c(.25, 1, 1))



ggsave(paste("../figs/fig5/", group, "/5AMaPSSeq_order_noclust1_", group, ".pdf",sep = ''), width = 15, height = 5.5)

}
```
