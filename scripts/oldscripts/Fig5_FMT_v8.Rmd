---
title: "fig5_PolysaccharideMuribac"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(tidytext)
library(cowplot)
#library(proxy)

#source("CompteSpearmanCorrelationAndMelt.R")

#Function to Convert to a pseudo log scale to wherein negative values may be "logged" i.e. log2(-8) = -3:

ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")


options(stringsAsFactors = F)
options(scipen = 10000)

subgroups <- read.csv('../tables/OTUSubgroups.csv') %>% mutate(subgroup =as.factor(subgroup))

CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/ProcessedResults/CorrectedDataFrame.csv") %>% 
                separate(col = Sample,     #split into column
                       into = c('date', 'MouseGroup', 'Mouse_num', 'replicate'),
                       sep = '-', remove = F) %>% 
                select(-date)  #remove unnecessary date file
  

Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/ProcessedResults/tax.csv") %>% select(-ends_with('conf'))

otumapping <- read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/DeSeq_OTU_dynamics.csv")

```


verify Prevalent sets
```{}

group <- 'J'
PrevalentSet <-
  rbind(
  read.csv(
     paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
        filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>% #filter group specific
       # filter(OTU1 %in% otus.to.keep & OTU2 %in% otus.to.keep) %>% #filter for ones in jax or E

    #filter(Order_OTU1 == 'Bacteroidia' | Order_OTU1 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU1, Order_OTU1, MouseGroup) %>% distinct(),
     read.csv(
       paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
            filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>% #filter group-specific
           # filter(OTU1 %in% otus.to.keep & OTU2 %in% otus.to.keep) %>% #filter for ones in jax or E
    #filter(Order_OTU2 == 'Bacteroidia'  | Order_OTU2 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU2, Order_OTU2,MouseGroup) %>% distinct() %>%
   rename(c("OTU1ColorName"="OTU2ColorName", "OTU2ColorName"="OTU1ColorName", "Class_OTU1"="Class_OTU2", "Order_OTU1"="Order_OTU2"))) #%>%


```
Subset OTUs over .1% in J or E DEPRECATED DO LATER
```{r}

temp <- CorrectedData %>% filter(MouseGroup == 'J' | MouseGroup == 'E') %>% 
  select(OTU, Count, MouseGroup) %>% 
  group_by(OTU, MouseGroup) %>% mutate(OTU_Count = sum(Count)) %>% 
  ungroup %>% select(-Count) %>% distinct() %>%
  group_by(MouseGroup) %>% mutate(OTU_relabd = (OTU_Count/sum(OTU_Count))*100) %>% 
  filter(OTU_relabd > .2) %>% select(OTU) %>% distinct()

print(paste('# OTUs in J:', nrow(filter(temp, MouseGroup == 'J'))))
print(paste('# OTUs in E:',nrow(filter(temp, MouseGroup == 'E'))))

otus.to.keep <- unique(temp$OTU)

```

### NOTES ###
This time was a bit tricky, I had to do a few data transformations since not so strong associations as last time (probably for the best)
1) log-modulus transform Z scores so everything is log2 of its absolute values (negative coassociations can't be logged normally)
2) replace NA values in Matrix with 0s
3) subset OTUs that appear in mouse particles over 0.5% abundance

#Assemble all prevalent sets
```{r}

PrevalentSets <- rbind((read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_J.csv") %>% 
  mutate(MouseGroup = 'Jax')),
(read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_E.csv") %>% 
  mutate(MouseGroup = 'Env')),
(read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_JEJ.csv") %>% 
  mutate(MouseGroup = 'Env2Jax')), 
  (read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_JEE.csv") %>% 
  mutate(MouseGroup = 'Jax2Env'))) %>% 
  select(-X) %>% mutate(MouseGroup = as.factor(MouseGroup)) %>%
    group_by(MouseGroup) %>% 
  mutate(Zscore = ifelse(is.infinite(Zscore), max(Zscore[!is.infinite(Zscore)]), Zscore)) %>% ungroup()

#Bound Zscores if negative
#PrevalentSets$Zscore[PrevalentSets$Zscore < -1e6] <- -16

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Class_OTU1)))), c(levels(as.factor(PrevalentSets$Class_OTU1)))) 

write.csv(bugColors,"../misc/bugColors_MapsSeq_redo.csv", quote = F, row.names = T)

```

Find OTUs to keep
```{r}

# Assuming J, E, JEE, JEJ are vectors/lists you want to iterate over. 
groups <- c("J", "E", "JEE", "JEJ")

# Create a list to hold the results for each group
otus_to_keep_list <- list()

for (group_name in groups) {
  temp <- CorrectedData %>% 
    filter(MouseGroup == group_name) %>%
    select(OTU, Count) %>%
    group_by(OTU) %>%
    mutate(OTU_Count = sum(Count)) %>%
    ungroup() %>%
    select(-Count) %>%
    distinct() %>%
    mutate(OTU_relabd = (OTU_Count / sum(OTU_Count)) * 100) %>%
    filter(OTU_relabd > 0.1) %>%
    select(OTU) %>%
    distinct()

#remove donor taxa for recipient analysis
if (group_name == "J") {
  exclusion_data <- PrevalentSets %>% select(OTU1, OTU1Type) %>%
                      distinct() %>%
                      filter(OTU1Type != 'Recipient Taxa')
  temp <- anti_join(temp, exclusion_data, by = c('OTU' = "OTU1")) %>% filter(OTU != 'Otu1')
}

  #remove recipient taxa for recipient analysis
  if (group_name == "E") {
  exclusion_data <- PrevalentSets %>% select(OTU1, OTU1Type) %>%
                      distinct() %>%
                      filter(OTU1Type != 'Donor Taxa')
  temp <- anti_join(temp, exclusion_data, by = c('OTU' = "OTU1")) %>% filter(OTU != 'Otu1') #gotta manually remove Otu1 since oesn't show up in OTU1 column
}

   print(paste("# OTUs in", group_name, ":", nrow(temp)))
   
   otus_to_keep_list[[group_name]] <- unique(temp$OTU)

 }

# If you want to access the result for a particular group, say 'E':
result_for_E <- otus_to_keep_list[["E"]]

```


5A - Env2Jax
```{r}

#group <- 'E' #can change to other mouse groups too

samples <- c('J','E','JEJ', 'JEE')
#samples <- c('JEJ')

#FOR SOME REASon, pre FMT stops after generating associations, just keep running last few lines

for (i in 1:length(samples)) {
  set.seed(123)
  print(samples[i])
  
    group <- samples[i]
    
#Need to duplicate df to mirror heatmap
PrevalentSet <-
  rbind(
  read.csv(
     paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
        filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>% #filter group specific
        #filter(OTU1 %in% otus.to.keep & OTU2 %in% otus.to.keep) %>% #filter for ones in jax or E

    #filter(Order_OTU1 == 'Bacteroidia' | Order_OTU1 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU1, Order_OTU1) %>% distinct(),
     read.csv(
       paste("../experiments/20230516_FMT_MaPS-Seq2/processed_data/PrevalentSet_noclust1_",group, ".csv", sep = '')) %>%
           filter(OTU1 %in% otus_to_keep_list[[group]] & OTU2 %in% otus_to_keep_list[[group]]) %>% #filter group-specific
           # filter(OTU1 %in% otus.to.keep & OTU2 %in% otus.to.keep) %>% #filter for ones in jax or E
    #filter(Order_OTU2 == 'Bacteroidia'  | Order_OTU2 == 'Clostridia') %>%
    select(OTU1ColorName, OTU2ColorName, Zscore, Significant, Class_OTU2, Order_OTU2) %>% distinct() %>%
   rename(c("OTU1ColorName"="OTU2ColorName", "OTU2ColorName"="OTU1ColorName", "Class_OTU1"="Class_OTU2", "Order_OTU1"="Order_OTU2"))) %>%
  mutate(Zscore = ifelse(is.infinite(Zscore), max(Zscore[!is.infinite(Zscore)], na.rm = TRUE), Zscore)) %>% ungroup() %>% mutate(Zscore = sign(Zscore) * log2(1 + abs(Zscore))) #%>% #log-modulus transformation
#  filter(OTU1ColorName != "<b style='color:#828382'>Otu1" & OTU2 != 'Otu1')
  #%>% na.omit() #%>%
  #mutate(Zscore_p = 2*pnorm(abs(Zscore), lower.tail=FALSE),
   #      Zscore_padj = p.adjust(Zscore_p, method = 'fdr'),
    #     Significance = ifelse(Zscore_padj < .05, TRUE, FALSE)) %>%
  



#temp <- read.csv("../misc/bugColors_MapsSeq.csv")
#bugColors<- setNames(c(scales::hue_pal()(length(unique(temp$X)))), c(levels(as.factor(temp$X)))) 

PrevalentSet.cast <- PrevalentSet %>%
  filter(OTU1ColorName != 'NA') %>% 
  select(OTU1ColorName, OTU2ColorName, Zscore) %>% distinct() %>% 
  reshape2::dcast(OTU1ColorName~OTU2ColorName)

#clustering
PrevalentSet.cast.matrix <- as.matrix(PrevalentSet.cast[, -c(1)])
#PrevalentSet.cast.matrix[is.infinite(PrevalentSet.cast.matrix)] <- 50

#replace NAs NOT NECESSARY IF USING PROXY COMMAND
PrevalentSet.cast.matrix <- ifelse(is.na(PrevalentSet.cast.matrix), 0 , PrevalentSet.cast.matrix)


#continue with clustering
rownames(PrevalentSet.cast.matrix) <- PrevalentSet.cast$OTU1ColorName

#adapt matrix for to exclude missing values
correlation_matrix <- cor(PrevalentSet.cast.matrix, use = "pairwise.complete.obs", method = 'spearman') 

#Calculate correlation of zscore and compute distance
#disttest <- dist(sqrt(2*(1-as.matrix(cor(correlation_matrix))))) #what miles gave me, cluster by correlation of correlations...
#disttest <-  stats::dist(sqrt(2*(1-as.matrix(correlation_matrix)))) #cluster by transformed correlation
disttest <- stats::dist(as.matrix(correlation_matrix))  #cluster by correlation matrix
#disttest <- stats::dist(as.matrix(PrevalentSet.cast.matrix))  #cluster by regular matrix

  # cluster using ward.D2
clustres <- hclust(disttest,"ward.D2")

#get subgroups 
branchcuts <- cutree(clustres, k = 4)#%>% cbind(., order=clustres$order) %>% as.data.frame() %>% rownames_to_column('temp') %>% separate(temp, sep = '>', into = c('waste', 'OTU')) %>% select(-waste) %>% rename(subgroup='.')



PrevalentSet.cast$order <- clustres$order
PrevalentSet.cast.dendro <- as.dendrogram(clustres) #create dendrogram

#which clustering method strongest...
# methods to assess 
#m <- c( "average", "single", "complete", "ward")
#names(m) <- c( "average", "single", "complete", "ward")

# function to compute coefficient
#ac <- function(x) {
#  cluster::agnes(PrevalentSet.cast.matrix, method = x)$ac
#}

#map_dbl(m, ac)
####ward strongest clusterer


# Create dendro
dendro.plot <- ggdendro::ggdendrogram(data = PrevalentSet.cast.dendro, 
                            rotate=FALSE) + 
                  coord_flip() + scale_y_reverse() + scale_x_reverse() + 
                  theme(axis.line = element_blank(),
                        axis.text = element_blank()) + theme_void()

### new stuff

dendro_data <- ggdendro::dendro_data(PrevalentSet.cast.dendro)

dendro_plot <- ggplot() + 
  geom_segment(data=ggdendro::segment(dendro_data), 
               aes(x=x, y=y, xend=xend, yend=yend)) +coord_flip() + scale_y_reverse() + scale_x_reverse() + 
                  theme(axis.line = element_blank(),
                        axis.text = element_blank()) + theme_void()
#####

# Preview the plot
print(dendro.plot)
#write out if need be
PrevalentSet.cast.long <- reshape2::melt(PrevalentSet.cast, id = c("OTU1ColorName", "order")) %>% distinct()

#reorder
#PrevalentSet.cast.order <- order.dendrogram(PrevalentSet.cast.dendro)
PrevalentSet.cast.long$OTU1ColorName <- factor(x = PrevalentSet.cast.long$OTU1ColorName,
                               levels = PrevalentSet.cast$OTU1ColorName[PrevalentSet.cast$order], 
                               ordered = TRUE)

temp <- PrevalentSet.cast.long %>% 
          select(OTU1ColorName, OTU2ColorName=variable, Zscore = 'value') %>% 
          left_join(., 
            (PrevalentSet %>% 
               select(OTU1ColorName, OTU2ColorName, Significant, 
                      Class_OTU1)), 
            by = c("OTU1ColorName", "OTU2ColorName")) %>% 
          left_join(., select(PrevalentSets, OTU1, OTU1ColorName, OTU1Type)) %>% distinct() %>%
          left_join(., select(otumapping, OTU1=OTU, log2FoldChange, emergence)) %>% distinct() %>%
    mutate(Zscore = replace_na(Zscore, 0))

xyz <- (PrevalentSet.cast %>% select(OTU1ColorName,order) %>% mutate(OTU1ColorName= as.factor(OTU1ColorName)) %>% arrange(order))$OTU1ColorName

ordered_OTU1_names <- rownames(PrevalentSet.cast.matrix)[PrevalentSet.cast$order]
print(ordered_OTU1_names)

# Assuming ordered_otu1_names is a list of vectors
extracted_list <- lapply(ordered_OTU1_names, function(x) str_extract(x, "(?<=>)[^<]+"))

# Convert the list to a data frame
df <- data.frame(OTU = unlist(extracted_list))

# Add the 'group' column. Assuming the group variable is already defined.
df$MouseGroup <- group

# Write to CSV
write.csv(df, paste("../tables/dendrogram_order_", group, ".csv", sep = ''), row.names = FALSE)


#heatmap
#y_min <- round(min(temp$Zscore, na.rm = T),digits = -1)
#y_max <- round(max(temp$Zscore, na.rm = T),digits = -1)
y_min <- floor(min(temp$Zscore, na.rm = T))
y_max <- ceiling(max(temp$Zscore, na.rm = T))

clustr <- temp %>% #mutate(Zscore = sign(Zscore) * log2(1 + abs(Zscore))) %>%
                 ggplot(aes(x = OTU1ColorName, y = OTU2ColorName, fill = Zscore)) +
  geom_tile(color = 'white') +
  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0, breaks = seq(y_min, y_max, by = (y_max-y_min)/5)) + #,limits=c(-.5,.5)) +
  theme_cowplot() +
  #scale_y_discrete(limits = xyz) +
  #scale_x_discrete(limits = xyz) +
  scale_y_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 9),
    axis.text.y = ggtext::element_markdown(size = 9)) +
  labs(fill = "Co-Assoc.\nScore")  +
  xlab("OTU X") +
  ylab("OTU Y") +
  geom_point(data=function(x){x[temp$Significant == TRUE, ]},size=.3,color="black", fill = 'black')



corplot_fam <- PrevalentSet %>% select(OTU1ColorName, Class_OTU1) %>% distinct() %>%
  ggplot(., aes(OTU1ColorName, y = 1, fill = Class_OTU1)) +
  geom_tile(color = 'black') +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) +
  scale_fill_manual(values = bugColors) +
  theme_cowplot() + 
    theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  theme(legend.position = "right")

corplot_fam

#order_info <- rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])

corplot_fc <-  temp %>% select(OTU1ColorName, emergence) %>% na.omit() %>% distinct() %>% 
  left_join(PrevalentSet,.) %>% select(OTU1ColorName,emergence) %>% distinct() %>%
  ggplot(., aes(OTU1ColorName, y = 1, fill=factor(emergence, levels = c('unchanged', 'depleted', 'enriched')))) +
  geom_tile(color = 'black') +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_fill_manual(values = c('gray80','#000000','#ff0000')) +
  labs(fill = 'Emergence') +
  theme_cowplot() +
    theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  theme(legend.position = "right")

corplot_fc

ggsave(paste("../figs/fig5/", group, "/emergence_mapSeq_", group, ".pdf",sep = ''), corplot_fc,width = 6, height = 1.5)

#OTU1 missing from these...
corplot_type <- data.frame(OTU1ColorName = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) %>%
  left_join(., select(PrevalentSets, OTU1ColorName, OTU1Type) %>% distinct(), by = 'OTU1ColorName') %>%
    mutate(OTU1Type= ifelse(OTU1ColorName == "<b style='color:#377EB8'>Otu1", 'Shared Taxa', OTU1Type)) %>%
  ggplot(.,aes(OTU1ColorName, y = 1, fill = OTU1Type)) +
                 geom_tile(color = 'black') + theme_void() +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
  scale_fill_manual(values = c('#377EB8', '#E41A1C','#828382')) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 8),
    axis.text.y = ggtext::element_markdown(size = 8)) +
  labs(fill = "Class", x = "OTU 1") 
corplot_type


#print out subgroups for J and E on JEJ loop
if (group == 'JEJ') {
  
  for (group_iteration in c('J', 'E')) {
    
    iter <- group_iteration

    subgroup_type <- data.frame(OTU1ColorName = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) %>%
       left_join(., select(PrevalentSets, OTU1ColorName, OTU=OTU1) %>% distinct(), by = 'OTU1ColorName') %>% 
       mutate(OTU= ifelse(OTU1ColorName == "<b style='color:#828382'>Otu1", 'Otu1', OTU)) %>%
       left_join(., filter(subgroups, MouseGroup == iter)) %>% na.omit() %>%
       ggplot(.,aes(OTU1ColorName, y = 1, fill = subgroup)) +
                    geom_tile(color = 'black') + theme_void() +
    scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1ColorName[PrevalentSet.cast$order])) +
       scale_fill_manual(values = c('#3b4d81', '#8967ac','#5aadc5', '#54b948')) +
       labs(x='', y='', fill='Spatial Subgroup') +
      theme_void() +
       theme(
         axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 8),
         axis.text.y = element_blank(),
         axis.line = element_blank(),
         axis.ticks = element_blank(), legend.position = 'top') +
       labs(fill = "Class", x = "OTU 1") + facet_wrap(~MouseGroup,nrow = 2)

    # subgroup_type
    ggsave(paste("../figs/fig5/JEJ/subgroup_mapSeq_", iter, ".pdf",sep = ''), subgroup_type,width = 4.5, height = 3)
    
  }

} else {
  message("The group variable is not 'JEJ'. Function execution stopped.")
}


ggsave(paste("../figs/fig5/", group, "/type_mapSeq_", group, ".pdf",sep = ''), corplot_type, 
       width = 6, height = 1.5)

bars <- cowplot::plot_grid(corplot_fam, corplot_fc, nrow = 2)

temp_dendro <- dendro_plot + theme(plot.margin = unit(c(-.3, .5, 1.6, 1), "cm"))

cowplot::plot_grid(temp_dendro, clustr, bars, nrow = 1, rel_widths = c(.25, 1, 1))



ggsave(paste("../figs/fig5/", group, "/5AMaPSSeq_order_noclust1_", group, ".pdf",sep = ''), width = 15, height = 5.5)

}
```

```{r}
#interesting for later.... Colonizing OTUs are not most abundant
temp <- data.frame(OTU1ColorName = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) %>%
  left_join(., select(PrevalentSets, MouseGroup, OTU1ColorName, OTU1, OTU1Type, InstancesOTU1)) %>% distinct() %>% filter(MouseGroup == group) %>% 
  left_join(., otumapping, by = c('OTU1' = 'OTU')) %>% distinct() %>% 
  left_join(., read.csv("../tables/Instances_MaPS-Seq.csv") %>% select('OTU1'='OTU',MouseGroup,prop_OTU) %>% filter(MouseGroup == group)) %>%
  ggplot(.,aes(OTU1ColorName)) +
       # geom_tile(aes(y=1, fill = log10(prop_OTU))) +
       geom_bar(color = 'black', stat = 'identity', aes(y = log10(prop_OTU))) + theme_minimal() +
    scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast$order])) +
  viridis::scale_fill_viridis() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 8),
    axis.text.y = element_blank(), plot.background = element_blank(), 
    axis.ticks = element_blank()) +
  labs(fill = "Class", x = "OTU 1") 

temp

ggsave(paste("../figs/fig5/", group, "/abundance_", group, ".pdf",sep = ''), width = 6, height = 1.5)



```


abundance of different subgroups?
```{r}

temp <- read.csv('../tables/OTUSubgroups.csv') %>% 
      mutate(OTU = paste('Otu', OTU, sep = '')) %>% 
      left_join(read.csv("../tables/Instances_MaPS-Seq.csv")) 

temp %>% #mutate(prop_OTU = log10(prop_OTU/100)) %>%
    ggplot(., aes(MouseGroup, prop_OTU, fill = MouseGroup)) + 
  geom_boxplot() + geom_jitter() + facet_wrap(~subgroup, scales = 'free') + theme_cowplot()


#subgroup 2 is significant
wilcox.test(filter(temp, MouseGroup == 'Env' & subgroup == '2')$prop_OTU,
            filter(temp, MouseGroup == 'Jax' & subgroup == '2')$prop_OTU, alternative = 'greater')

wilcox.test(filter(temp, MouseGroup == 'Jax' & subgroup == '4')$prop_OTU,
            filter(temp, MouseGroup == 'Env' & subgroup == '4')$prop_OTU, alternative = 'greater')

```

#5c? Make network diagram of mean bacteroides interactions, show present nodes arranged in auto


FOR BACTEROIDALES   Jax (A) COLOR_FLIPPED
```{r}

library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Family_OTU1)))), c(levels(as.factor(PrevalentSets$Family_OTU1))))

#average interactions 
mean_interactions <- PrevalentSets %>%
  filter(zpadjusted < .01) %>% 
  mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, Zscore, zpadjusted,interaction,MouseGroup, 
         Class_OTU1, Family_OTU1, Class_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Count OTU instances
Instances <- rbind(PrevalentSets %>% select(MouseGroup, OTU1, Instances=InstancesOTU1) %>% distinct(),
                   PrevalentSets %>% select(MouseGroup, OTU1=OTU2, Instances=InstancesOTU2) %>% distinct()) %>% 
  group_by(MouseGroup, OTU1) %>% mutate(total_instances = (sum(Instances))) %>% ungroup() %>% 
  select(OTU1, MouseGroup, total_instances) %>% distinct() %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1))

#Let's try when we count instances immediately
Instances_new <- read.csv("../tables/Instances_MaPS-Seq.csv") %>% 
    select(OTU1=OTU, prop_OTU, MouseGroup, Order, Family, alpha) %>%
    mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% distinct()


#tbl_nodes[unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1),]
#unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1)


# Create data frame for edges

cluster_network <- PrevalentSets %>% #left_join(., Instances, by = c("OTU1", "MouseGroup")) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) #only significant interactions




#Make dummy edges
tbl_edges_all <- cluster_network %>% 
  filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
    select(OTU1, OTU2, Class_OTU1,Class_OTU2) %>% 
    #mutate(interaction = 1) %>% 
    distinct()

edges <- rbind(select(tbl_edges_all,OTU1, Class_OTU1), select(tbl_edges_all, OTU1=OTU2, Class_OTU1=Class_OTU2)) %>% distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
  filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, Class_OTU1) %>%
  distinct() %>% left_join(edges,.) %>%   
  mutate(OTU1 = as.numeric(OTU1)) %>%
  arrange(OTU1) %>% mutate(OTU1 = as.character(OTU1)) %>% distinct()
# %>%filter(OTU1 != '81' & OTU1 != '84') #remove OTUs in Env but not others...




# - FMT


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Jax' & Significant == T) %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in -FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
  left_join(., filter(Instances_new, MouseGroup == 'Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#How many negative interactions from 28, 21, or 76?
nrow(filter(filter(tbl_edges, interaction == 'Negative'), OTU1== 28 | OTU2 == 28))
nrow(filter(filter(tbl_edges, interaction == 'Negative'), OTU1== 21 | OTU2 == 21))
nrow(filter(filter(tbl_edges, interaction == 'Negative'), OTU1== 76 | OTU2 == 76))
nrow(filter(filter(tbl_edges, interaction == 'Negative'), OTU1== 62 | OTU2 == 62))
nrow(filter(filter(tbl_edges, interaction == 'Negative'), OTU1== 99 | OTU2 == 99))



#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
        delete_vertices(., V(.)$name == 28 | V(.)$name == 62 | V(.)$name == 84)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.001, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue', 'firebrick')) + #FLIPPED
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  labs(color = 'Order', 
         title = "Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
a
# Env

#Get nodes found in Env



#Now layer edges for Env
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env' & Significant == T) %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in Env

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env'))



#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data. remove OTU not found in Env2jax or Jax
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>%
        delete_vertices(., V(.)$name == 28 | V(.)$name == 62 | V(.)$name == 84)


#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
b

# +FMT

#Now layer edges for +FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env2Jax' & Significant == T) %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in +FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env2Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>%
        delete_vertices(., V(.)$name == 28 | V(.)$name == 62 | V(.)$name == 84)


#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.01, 2)
                       ) +
      scale_edge_color_manual(values = c('navyblue', 'firebrick')) + #FLIPPED
    #scale_edge_color_manual(values = c('firebrick')) + #add 'navyblue' if necessary
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env2Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 


c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
c

leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Zscore), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Family_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    

temp <- cowplot::plot_grid(a,c,b,  nrow = 1)
temp
ggsave("../figs/fig5/5E_InteractionNetworks.png", width = 8,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks.pdf", width = 8,height = 2.8)

cowplot::plot_grid(leg)
ggsave("../figs/fig5/5E_InteractionNetworks_leg.png", width = 14,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_leg.pdf", width = 14,height = 2.8)
cowplot::plot_grid(temp, leg, nrow = 2)
```


FOR Clostridia
```{r}

library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Family_OTU1)))), c(levels(as.factor(PrevalentSets$Family_OTU1))))

#average interactions 
mean_interactions <- PrevalentSets %>%
  filter(zpadjusted < .01) %>% 
  mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, Zscore, zpadjusted,interaction,MouseGroup, 
         Class_OTU1, Family_OTU1, Class_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Count OTU instances
Instances <- rbind(PrevalentSets %>% select(MouseGroup, OTU1, Instances=InstancesOTU1) %>% distinct(),
                   PrevalentSets %>% select(MouseGroup, OTU1=OTU2, Instances=InstancesOTU2) %>% distinct()) %>% 
  group_by(MouseGroup, OTU1) %>% mutate(total_instances = (sum(Instances))) %>% ungroup() %>% 
  select(OTU1, MouseGroup, total_instances) %>% distinct() %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1))

#Let's try when we count instances immediately
Instances_new <- read.csv("../tables/Instances_MaPS-Seq.csv") %>% 
    select(OTU1=OTU, prop_OTU, MouseGroup, Order, Family, alpha) %>%
    mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% distinct()


#tbl_nodes[unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1),]
#unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1)


# Create data frame for edges

cluster_network <- PrevalentSets %>% #left_join(., Instances, by = c("OTU1", "MouseGroup")) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) #only significant interactions





#Make dummy edges
tbl_edges_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
    select(OTU1, OTU2, Class_OTU1,Class_OTU2) %>% 
    #mutate(interaction = 1) %>% 
    distinct()

edges <- rbind(select(tbl_edges_all,OTU1, Class_OTU1), select(tbl_edges_all, OTU1=OTU2, Class_OTU1=Class_OTU2)) %>% distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
  select(OTU1, Class_OTU1) %>%
  distinct() %>% left_join(edges,.) %>%   
  mutate(OTU1 = as.numeric(OTU1)) %>%
  arrange(OTU1) %>% mutate(OTU1 = as.character(OTU1)) %>% distinct()



# - FMT


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Jax' & Significant == T) %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in -FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
  left_join(., filter(Instances_new, MouseGroup == 'Jax'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.001, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  labs(color = 'Order', 
         title = "Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
a
# Env

#Get nodes found in Env



#Now layer edges for Env
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env' & Significant == T) %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in Env

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)
#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
b

# +FMT

#Now layer edges for +FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env2Jax'& Significant == T) %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, Zscore, zpadjusted) %>% 
    mutate(interaction = ifelse(Zscore > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/zpadjusted)) %>%
    select(OTU1, OTU2, interaction, Zscore) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in +FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env2Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)
#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(Zscore)*.001, 
                       alpha = abs(Zscore), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((Zscore)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env2Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 


c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
c

leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Zscore), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Family_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    

temp <- cowplot::plot_grid(a,c,b,  nrow = 1)
temp
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno.png", width = 8,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno.pdf", width = 8,height = 2.8)

cowplot::plot_grid(leg)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno_leg.png", width = 14,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno_leg.pdf", width = 14,height = 2.8)
cowplot::plot_grid(temp, leg, nrow = 2)
```





Are interactions occuring between Env taxa or Env-recipient or recipient-recipient
```{r}

#uncomment lines to separate engrafted vs unengrafted microbes
temp <- PrevalentSets %>% 
  filter(Significant == T) %>% 
  mutate(interaction_type = ifelse(Zscore > 0, 'Positive', 'Negative')) %>%
  select(MouseGroup, OTU1Type, OTU2Type,OTU1, OTU2,Class_OTU1, Class_OTU2, interaction_type) %>%
  mutate(interaction = NA) %>% 
  distinct() %>%
  mutate(interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Donor Taxa', 'Env-Env', interaction),
         interaction = ifelse(OTU1Type == 'Recipient Taxa' & OTU2Type == 'Recipient Taxa', 'Jax-Jax', interaction),
         interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Recipient Taxa', 'Env-Jax', interaction),
         interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Shared Taxa', 'Env-shared', interaction),
         interaction = ifelse(OTU1Type == 'Recipient Taxa' & OTU2Type == 'Shared Taxa', 'Jax-shared', interaction),
         interaction = ifelse(OTU1Type == 'Shared Taxa' & OTU2Type == 'Shared Taxa', 'shared-shared', interaction)) %>% na.omit() 


#how many interactions for each?
num_ints <- (temp %>% group_by(MouseGroup, interaction_type) %>% 
  mutate(num_interactions = n()) %>% ungroup %>%
  select(MouseGroup, num_interactions,interaction_type) %>% distinct()) %>% group_by(MouseGroup) %>% mutate(prop_interactions = num_interactions/sum(num_interactions)) %>% ungroup()
num_ints

temp$interaction <- factor(temp$interaction, levels=c("Env-Env", "Jax-Jax", "Env-Jax", "Env-shared", "Jax-shared", "shared-shared")) 
#What types of interactions do we see

#Normalized interactions
temp %>% left_join(., num_ints) %>% group_by(interaction, interaction_type, MouseGroup) %>% 
  mutate(num_type_interactions = n(), 
         scaled_interactions = num_type_interactions/num_interactions) %>% ungroup() %>%
  select(MouseGroup, scaled_interactions, interaction_type, interaction) %>% distinct() %>%
  ggplot(., aes(x=interaction, y=scaled_interactions, fill =interaction_type)) + 
  geom_bar(stat = 'identity', position = 'stack') + 
  scale_fill_manual(values = c('#f7941d','#27aae1')) +
  labs(x= 'Co-association Pair', y = 'Proportion of Co-associations', fill = 'Co-association') +
  theme_clean() + 
  facet_wrap(~MouseGroup, nrow = 3, strip.position = 'right') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 16),
        axis.text.y = element_text(size=16, color = 'black'),
        axis.title.x.bottom = element_text(size = 16,color = 'black'),
        axis.title.y.left = element_text(size = 16,color = 'black'),
        legend.position = 'right')

ggsave("../figs/s6/s6_ALLInteractionCounts.png", width = 5, height = 5)
ggsave("../figs/s6/s6_ALLInteractionCounts.pdf", width = 5, height = 5)

#Sheer # of interactions
temp %>% #filter(interaction != 'Env-Env' & interaction != 'Env-recipient' & interaction != 'recipient-recipient') %>% 
  ggplot(., aes(x=interaction, fill =interaction_type)) + 
  geom_bar(stat = 'count', position = 'stack') + 
  scale_fill_manual(values = c('#f7941d','#27aae1')) +
  labs(x= 'Co-association pair', y = '# of Interactions', 
       fill = 'Interaction Type') +
  theme_clean() + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')), nrow = 3, strip.position = 'top', scales = 'free_y') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 10),
        axis.text.y = element_text(size=10, color = 'black'),
        axis.title.x.bottom = element_text(size = 12,color = 'black'),
        axis.title.y.left = element_text(size = 12,color = 'black'),
        legend.position = 'right', strip.text = element_text(size = 12))

ggsave("../figs/s7/s7_ALLInteractionCounts.png", width = 5, height = 5)
ggsave("../figs/s7/s7_ALLInteractionCounts.pdf", width = 5, height = 5)
#ggsave("../figs/fig5/5X_InteractionCounts.png", width = 5, height = 2.5)
#ggsave("../figs/fig5/5X_InteractionCounts.pdf", width = 5, height = 2.5)

```

What is distribution of number of interactions amongst OTUs?
```{r}
df <- rbind(
  temp %>% select(MouseGroup, 'OTU'=OTU1),
  temp %>% select(MouseGroup, 'OTU'=OTU2)) %>% 
  group_by(MouseGroup, OTU) %>% mutate(num_OTU_interactions = n()) %>% 
  ungroup %>% distinct() 
  
  
ggplot(df, aes(num_OTU_interactions, fill = MouseGroup)) + 
  geom_histogram(bins = 10, color = 'black') + facet_wrap(~MouseGroup) + theme_cowplot() + geom_density()
  
```


Interesting, preFMT - specific communities don't interact much! Universal microbes do interact in all communities. Env microbes also are able to interact with shared bugs, who are these interactors?


Now let's do Class split by interaction type
```{r}

temp_2 <- rbind(select(temp, MouseGroup, OTU1, OTU2, Class_OTU1, Class_OTU2, interaction_type), 
  (select(temp, MouseGroup, 'OTU1'='OTU2', 'OTU2'='OTU1', 'Class_OTU2'='Class_OTU1', 'Class_OTU1'='Class_OTU2', interaction_type))) %>% distinct() %>% 
  group_by(MouseGroup, Class_OTU1, Class_OTU2, interaction_type) %>% 
  mutate(num_interactors = n()) %>% ungroup() %>% select(-OTU1, -OTU2) %>% 
  mutate(num_interactors = as.numeric(num_interactors)) %>% distinct() %>%
  mutate(num_interactors = ifelse(Class_OTU1 == Class_OTU2, num_interactors/2, num_interactors)) #since made mirror, need to remove the ones that are duplicates

#get coordinates for background
grid <- rbind(data.frame(Class_OTU1=temp$Class_OTU1), data.frame(Class_OTU1=temp$Class_OTU2)) %>% 
  distinct() %>% 
  mutate(merge = 'merge')

grid <- rbind(mutate(grid, MouseGroup='Jax'),
      mutate(grid, MouseGroup='Env2Jax'),
      mutate(grid, MouseGroup='Env'))

grid <- left_join(grid, grid, by = c('merge', 'MouseGroup')) %>% 
  dplyr::rename('Class_OTU1'='Class_OTU1.x', 'Class_OTU2'='Class_OTU1.y') %>% 
  left_join(., temp_2, 
              by = c('Class_OTU1', 'Class_OTU2', 'MouseGroup')) 

#add scaler
scaled_temp_2 <- temp_2 %>% select(Class_OTU1, Class_OTU2, MouseGroup, num_interactors, interaction_type) %>%
  left_join(.,
            read.csv("../tables/MaPS-Seq_ClassCounts.csv") %>% 
              rename('Class_OTU1' = 'Class', 'num_class_1' = 'num_class'), by = c('MouseGroup', 'Class_OTU1')) %>% left_join(., 
            read.csv("../tables/MaPS-Seq_ClassCounts.csv") %>% 
              rename('Class_OTU2' = 'Class', 'num_class_2' = 'num_class'), by = c('MouseGroup', 'Class_OTU2')) %>% 
        mutate(num_mates = ifelse(Class_OTU1 == Class_OTU2, (num_class_1*num_class_2)-1, num_class_1*num_class_2),
               scaled_num_interactors = num_interactors/num_mates) %>% na.omit                                                                                                                       



#scaled_temp_2 
temp_2 %>% filter(interaction_type == 'Negative') %>%
 distinct() %>%
  distinct() %>%
   ggplot(., aes(x=Class_OTU1, y = Class_OTU2)) +
    geom_tile(data = grid, aes(x=Class_OTU1, y = Class_OTU2), color = 'black', fill = NA) +
  geom_tile(aes(fill = num_interactors), color = 'black') +
    scale_fill_gradient(low='lightblue', high='navyblue') +
facet_grid(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env'))) +
  labs(fill = '# of - associations') +
  theme_cowplot() +     
 # geom_text(aes(label=paste(signif(scaled_num_interactors, 2)*100, '%', sep = '')), 
  #              size = 2.5, color = 'white') +
   geom_text(aes(label=num_interactors), 
                size = 2.5, color = 'white') +
  labs(y = 'Class', x = 'Class', title = 'Interactions with Shared Taxa') +
    theme(axis.text.x = element_text(size=9,color = 'black', 
                                     angle = 45, hjust = 1), 
        axis.text.y = element_text(size=9, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=10,color = 'black'),
        legend.title = element_text(size = 12, hjust = .5,color = 'black'),
        legend.position = 'bottom',
        strip.background = element_blank())
        

ggsave("../figs/fig5/5D_ClassInteractions_neg.pdf", width = 7.5, height = 4)

#scaled_temp_2 
temp_2 %>% filter(interaction_type == 'Positive') %>%
 distinct() %>%# filter(MouseGroup != 'Env') %>%
  distinct() %>%
   ggplot(., aes(x=Class_OTU1, y = Class_OTU2)) +
    geom_tile(data = grid, aes(x=Class_OTU1, y = Class_OTU2), color = 'black', fill = NA) +
  geom_tile(aes(fill = num_interactors), color = 'black') +
  facet_grid(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env'))) +
  labs(fill = '# of + associations') +
    scale_fill_gradient(low='#FFCCCB', high='firebrick3') +
  theme_cowplot() + 
     geom_text(aes(label=num_interactors), 
                size = 2.5, color = 'white') +
#geom_text(aes(label=paste(signif(scaled_num_interactors, 2)*100, '%', sep = '')), 
#                size = 2.5, color = 'white') +  
  labs(y = 'Class', x = 'Class', title = 'Associations with Shared Taxa') +
    theme(axis.text.x = element_text(size=9,color = 'black', 
                                     angle = 45, hjust = 1), 
        axis.text.y = element_text(size=9, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=10,color = 'black'),
        legend.title = element_text(size = 12, hjust = .5,color = 'black'),
        legend.position = 'bottom',
        strip.background = element_blank())
        

ggsave("../figs/fig5/5D_ClassInteractions_pos.pdf", width =7.5, height = 4)



##add Class abundance over tile plots

read.csv("../tables/MaPS-Seq_ClassCounts.csv") %>% 
  ggplot(., aes(x=Class, y = num_class)) + 
  geom_bar(color = 'black', fill = 'gray80', stat = 'identity') + 
  labs(y='# OTUs in Class', x= '') + theme_clean() +
  theme(axis.text.y = element_text(size=10),
        axis.text.x = element_blank(),
        axis.title = element_text(size = 12), 
        strip.background = element_blank()) + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')))

ggsave("../figs/fig5/5B.3_ClassOTUCounts.pdf", width = 6, height = 1.25)


```



#Are engrafting microbes the ones with most interactions? Number of interactions within donor predicts success in recipient?

FIGURE 5D

```{r}
#What happens to Env microbes?
group <- 'Env'

engrafted_Envs <- 
  rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == group & zpadjusted < .05) %>% #& OTU1Type != 'Recipient Taxa') %>% 
    select(OTU1, OTU2),
    rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == group & zpadjusted < .05) %>%# & OTU2Type != 'Recipient Taxa') %>% 
    select(OTU1=OTU2, OTU2=OTU1))) %>%  filter(OTU1!=OTU2)%>% distinct() %>% select(OTU1) %>%
  group_by(OTU1) %>% mutate(num_interactions = n()) %>% 
  select(OTU1, num_interactions) %>% 
  left_join(filter(otumapping, OTUType !='NA')%>% select(OTU1=OTU, emergence, OTUType, baseMean,log2FoldChange), .) %>%
  distinct() #%>% 
  #filter(OTU1 %in% otus_to_keep_list[["E"]]) %>% na.omit()


engrafted_Envs$num_interactions[is.na(engrafted_Envs$num_interactions)] <- 0 


#Can look at Env-only OTUs
corr <- cor.test((engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$estimate
pval <-  cor.test((engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$p.value

engrafted_Envs %>% filter(OTUType == 'Donor Taxa') %>%
  ggplot(., aes(x=log2FoldChange, y = num_interactions), color = 'black') +
  #ggplot(., aes(x=baseMean*log2FoldChange, y = num_interactions)) +
  geom_point(size = 2) + geom_smooth(method = 'lm') + theme_cowplot() +# facet_wrap(~OTUType) +
  annotate('text', x = .8, y = 15, label = paste('R2 = ', signif(corr, 2), ', p = ', signif(pval, 2), sep = ''), size = 5) +
  labs(title = '', x = 'Engraftment Efficiency\nin Env2Jax', y = 'Number of interactions in Env')


#But it's better to look at Non-recipient taxa fold change! Includes shared and donor-only taxa
corr <- cor.test((engrafted_Envs %>% filter(OTUType != 'Recipient Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType != 'Recipient Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$estimate
pval <-  cor.test((engrafted_Envs %>% filter(OTUType != 'Recipient Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType != 'Recipient Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$p.value

engrafted_Envs %>% filter(OTUType != 'Recipient Taxa') %>%
  ggplot(., aes(x=log2FoldChange, y = num_interactions), color = 'black') +
  #ggplot(., aes(x=baseMean*log2FoldChange, y = num_interactions)) +
  geom_point(size = 2) + geom_smooth(method = 'lm') + theme_cowplot() +# facet_wrap(~OTUType) +
  annotate('text', x = .8, y = 25, label = paste('R2 = ', signif(corr, 2), ', p = ', signif(pval, 2), sep = ''), size = 5) +
  labs(title = '', x = 'Engraftment Efficiency\nin Env2Jax', y = 'Number of interactions in Env')

ggsave("../figs/fig5/5D_DonorOutcomes_correlations.pdf", width = 3.5, height = 4)


#cor.test((engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$num_interactions, method = 'spearman',exact=FALSE)

#cor.test(engrafted_Envs$baseMean*engrafted_Envs$log2FoldChange, engrafted_Envs$num_interactions, method = 'spearman', exact=FALSE)

```


ABUNDANCE IN ENV2JAX CORRELATED WITH THEIR NUMBER OF INTERACTIONS
```{r}

group <- 'Env2Jax'

engrafted_Envs <- 
  rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == group & zpadjusted < .05) %>%# & OTU1Type != 'Recipient Taxa') %>% 
    select(OTU1, OTU2),
    rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == group & zpadjusted < .05) %>% # & OTU2Type != 'Recipient Taxa') %>% 
    select(OTU1=OTU2, OTU2=OTU1))) %>%  filter(OTU1!=OTU2)%>% distinct() %>% select(OTU1) %>%
  group_by(OTU1) %>% mutate(num_interactions = n()) %>% 
  select(OTU1, num_interactions) %>% left_join(filter(otumapping, OTUType !='NA')%>% select(OTU1=OTU, emergence, OTUType, baseMean,log2FoldChange), .) %>%
  distinct() 

engrafted_Envs$num_interactions[is.na(engrafted_Envs$num_interactions)] <- 0 


engrafted_Envs %>% #filter(OTUType != 'Recipient Taxa') %>%
  ggplot(., aes(factor(emergence, levels = c('depleted', 'unchanged', 'enriched')), 
                                   num_interactions)) + 
  stat_boxplot(geom='errorbar', width = .1) +
  geom_boxplot(notchwidth = .2, outlier.shape = NA, width = .4, fill = 'white') +
    geom_jitter(alpha = .4, aes(color = OTUType), width = .2) + 
    scale_color_manual(values = c('#377EB8', '#E41A1C','#828382')) +
  theme_cowplot() +
  ggsignif::geom_signif(
    comparisons = list(c('depleted', 'unchanged'), 
                       c('unchanged', 'enriched')),
    test = 'wilcox.test',
    y_position = c(19, 42)
  ) +
  labs(x = 'OTU FMT Outcome', y = '# of Interactions in Env2Jax', fill =NA) + 
  theme(axis.text.x = element_text(size=16,color = 'black', angle = 45, hjust = 1), 
        axis.text.y = element_text(size=16, color = 'black'),
        axis.title.x.bottom = element_text(size = 16,color = 'black'),
        axis.title.y.left = element_text(size = 16,color = 'black'),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black')) + 
    theme(
  legend.position = c(0.01, 0.95), 
  legend.justification = c(0, 1),
  legend.background = element_rect(fill="grey90", color=NA),
  legend.key.size = grid::unit(.6, "cm"),  # Increase the key size
  legend.text = element_text(size = 12)     # Adjust text size accordingly, if needed
)

ggsave("../figs/fig5/5Ealt_FMTOutcomes.pdf", width = 3.5, height = 4)


```


Do bacteroides that are shared engraft better?
```{r}

group <- 'Jax'

#need to flip Prevalent sets so interactions go both ways correct
engrafted_Envs <- 
  rbind(PrevalentSets %>% filter(Class_OTU1 == 'Bacteroidia' | Class_OTU2 == 'Bacteroidia') %>% 
  filter(MouseGroup == group & zpadjusted < .05) %>% #& OTU1Type != 'Recipient Taxa') %>% 
    select(OTU1, OTU2),
    rbind(PrevalentSets %>% filter(Class_OTU1 == 'Bacteroidia' | Class_OTU2 == 'Bacteroidia') %>%
  filter(MouseGroup == group & zpadjusted < .05) %>%# & OTU2Type != 'Recipient Taxa') %>% 
    select(OTU1=OTU2, OTU2=OTU1))) %>%  filter(OTU1!=OTU2)%>% distinct() %>% select(OTU1) %>%
  group_by(OTU1) %>% mutate(num_interactions = n()) %>% 
  select(OTU1, num_interactions) %>%
  left_join(filter(otumapping, OTUType !='NA')%>% select(OTU1=OTU, emergence, OTUType, baseMean,log2FoldChange) %>% left_join(., select(Tax_Table, OTU1=OTU, Class)) %>% filter(Class == 'Bacteroidia'), .) %>%
  distinct() 

engrafted_Envs$num_interactions[is.na(engrafted_Envs$num_interactions)] <- 0 

corr <- cor.test((engrafted_Envs %>% filter(OTUType == 'Shared Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$estimate
pval <-  cor.test((engrafted_Envs %>% filter(OTUType == 'Shared Taxa'))$log2FoldChange, (engrafted_Envs %>% filter(OTUType == 'Donor Taxa'))$num_interactions, method = 'spearman',exact=FALSE)$p.value

engrafted_Envs %>% filter(OTUType == 'Shared Taxa') %>%
  ggplot(., aes(x=log2FoldChange, y = num_interactions), color = 'black') +
  #ggplot(., aes(x=baseMean*log2FoldChange, y = num_interactions)) +
  geom_point(size = 2) + geom_smooth(method = 'lm') + theme_cowplot() +# facet_wrap(~OTUType) +
  annotate('text', x = .8, y = 25, label = paste('R2 = ', signif(corr, 2), ', p = ', signif(pval, 2), sep = ''), size = 5) +
  labs(title = 'Shared Bacteroides OTUs', x = 'log2(Fold Change in Recipient)', y = 'Number of interactions in Jax')

```



#Are interactions conserved across FMT
```{r}

#group <- 'Jax'

#need to flip Prevalent sets so interactions go both ways correct
interactions <- 
  rbind(PrevalentSets %>% rename(OTU1=OTU2, OTU2=OTU1, Class_OTU1=Class_OTU2, Class_OTU2=Class_OTU1, OTU1Type=OTU2Type, OTU2Type=OTU1Type),
        PrevalentSets) %>%  filter(OTU1!=OTU2)%>% distinct() %>%
  select(OTU1, OTU2, Class_OTU1, Class_OTU2, OTU1Type, OTU2Type, Significant, Zscore, MouseGroup) %>% 
  mutate(interaction_type = ifelse(Zscore > 0, 'Positive', 'Negative'),
         interaction_type = ifelse(Significant == T, interaction_type, 'None')) %>% filter(Significant == T) %>%
  #select(-Zscore, -Significant) %>% 
 # select(OTU1, OTU2, MouseGroup,  interaction_type)
  distinct()

jax_interactions <- filter(interactions, MouseGroup == 'Jax') %>% rename(jax_interaction_type=interaction_type) %>% 
                    select(OTU1, OTU2, jax_interaction_type) %>% distinct()
env_interactions <- filter(interactions, MouseGroup == 'Env') %>% rename(env_interaction_type=interaction_type) %>% 
                    select(OTU1, OTU2, env_interaction_type) %>% distinct()

postfmt_interactions <- filter(interactions, MouseGroup == 'Env2Jax') %>% 
  rename(env2jax_interaction_type=interaction_type) %>% filter(Significant == T) %>%
                        left_join(., jax_interactions, by = c('OTU1', 'OTU2')) %>%
                        left_join(., env_interactions, by = c('OTU1', 'OTU2')) %>% 
  mutate(jax_interaction_type = ifelse(is.na(jax_interaction_type), 'None', jax_interaction_type),
         env_interaction_type = ifelse(is.na(env_interaction_type), 'None', env_interaction_type)) %>%
          mutate(`Jax` = ifelse(jax_interaction_type == env2jax_interaction_type, T, F),
                 `Env` = ifelse(env_interaction_type == env2jax_interaction_type, T, F),
                 intermicrobiome_conservation = ifelse(env_interaction_type == jax_interaction_type, T, F)) %>%
          mutate(interaction_source = NA,
                 interaction_source = ifelse(Jax == T & Env == T, 'Both', interaction_source),
                 interaction_source = ifelse(Jax == T & Env == F, 'Jax', interaction_source),
                 interaction_source = ifelse(Jax == F & Env == T, 'Env', interaction_source),
                 interaction_source = ifelse(Jax == F & Env == F, 'Neither', interaction_source))  #See where postFMT interactions came from

category_proportions <- table(postfmt_interactions$interaction_source) / nrow(postfmt_interactions)

# Make the plot
ggplot(postfmt_interactions, aes(x = 1, y = value, width = category_proportions)) +
  geom_bar(position = 'stacked') +
  labs(title = "Proportional Boxplot", x = "Category", y = "Value") +
  theme_minimal()


postfmt_interactions %>% 
  select(Class_OTU1, Class_OTU2, `Env`, `Jax`) %>% # add inttermicrobiome_conservation to look at in 
  melt(id.vars = c('Class_OTU1', 'Class_OTU2')) %>%
mutate(`Interaction \nConserved?` = case_when(
    value == TRUE ~ "True",
    value == FALSE ~ "False",
    is.na(value) ~ "Not Observed"
  )) %>%
  mutate(`Interaction \nConserved?` = factor(`Interaction \nConserved?`, levels = c("True", "False", "Not Observed"))) %>%
  ggplot(., aes(variable, fill=`Interaction \nConserved?`)) + geom_bar(stat = 'count') + 
  theme_cowplot() + 
  scale_fill_manual(values = c('#0077be','#ffd700', 'grey60')) +
  theme(axis.text = element_text(size = 16))

ggsave("../figs/fig5/Interaction_Conservation.pdf", width = 4, height = 3.5)  
    #+ 
#  facet_grid(Class_OTU1~Class_OTU2). #uncomment if want to separate by OTU

```


Another way to look at it. Amongst Env2Jax interactions, how many are seen in Env, Jax or both. Correlations between Z scores
```{r}
library(GGally)

interactions <- rbind(PrevalentSets %>% rename(OTU1=OTU2, OTU2=OTU1, Class_OTU1=Class_OTU2, Class_OTU2=Class_OTU1, OTU1Type=OTU2Type, OTU2Type=OTU1Type),
        PrevalentSets) %>%  filter(OTU1!=OTU2)%>% distinct() %>%
  select(OTU1, OTU2, Significant, Zscore, MouseGroup) %>% distinct() 
 
  

zscore_df <- interactions %>% filter(MouseGroup == 'Env2Jax') %>% select(OTU1, OTU2, zscore_postfmt=Zscore) %>%
                          left_join(., interactions %>% filter(MouseGroup == 'Jax') %>% 
                                    select(OTU1, OTU2, zscore_jax=Zscore), 
                                  by = c('OTU1', 'OTU2')) %>%
                        left_join(., interactions %>% filter(MouseGroup == 'Env') %>% 
                                  select(OTU1, OTU2, zscore_env=Zscore), 
                                  by = c('OTU1', 'OTU2')) %>% select(zscore_postfmt, zscore_jax, zscore_env)


a <- ggplot(zscore_df, aes(zscore_env, zscore_jax)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Jax') + theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(zscore_df$zscore_env, zscore_df$zscore_jax, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) #+
     ylim(-3,-.5) + xlim(-3,-1)

b <- ggplot(zscore_df, aes(zscore_postfmt,zscore_jax)) + 
        geom_point() + geom_smooth(method = 'lm',) + 
        labs(y = 'Jax', x = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(zscore_df$zscore_postfmt, zscore_df$zscore_jax, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) #+
        ylim(-3,-.5) + xlim(-3,-1)

c <- ggplot(zscore_df, aes(zscore_env, zscore_postfmt)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(zscore_df$zscore_env, zscore_df$zscore_postfmt, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) #+
         ylim(-3,-.5) + xlim(-3,-1)




plot_grid(c,NULL, a,b, nrow = 2)

```