---
title: "MaPS-Seq_QC_assessment"
output: html_document
date: "2023-05-12"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(cowplot)
library(Seurat)

source("Null Model for Guillaume.R")


ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")
samples <- c("Post FMT", "Pre FMT", "Donor")
temp <- read.csv("../misc/bugColors_MapsSeq.csv")
bugColors<- setNames(c(scales::hue_pal()(length(unique(temp$X)))), c(levels(as.factor(temp$X)))) 


options(stringsAsFactors = F)
options(scipen = 10000)


#zotu <- read_csv("../seq/zotu.csv") 
#tax <- read_csv("../seq/tax.csv")

otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/DeSeq_OTU_dynamics.csv")

CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/ProcessedResults/CorrectedDataFrame.csv") %>%
                separate(col = Sample,     #split into column
                       into = c('date', 'MouseGroup', 'Mouse_num', 'replicate'),
                       sep = '-', remove = F) %>% 
                select(-date)  #remove unnecessary date file
  

Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/ProcessedResults/tax.csv") %>% select(-ends_with('conf'))

#rename tax columns
colnames(Tax_Table) <- gsub("^(.)", "\\U\\1", colnames(Tax_Table), perl = TRUE)


otumapping <- read.csv("../experiments/20230516_FMT_MaPS-Seq2/processed_data/DeSeq_OTU_dynamics.csv")

```

MaPS-Seq Particle processing
```{r}
#set <- samples[1]
  
fulldataset <- CorrectedData %>% 
   # filter(OTU %in% otus.to.keep) %>%
  group_by(Particle) %>% 
          mutate(total_particle_reads = sum(Count),
                 OTU_rel_abd = Count/sum(Count))  %>% 
                                                ungroup() %>%
                                                filter(OTU_rel_abd > .01) %>% 
                                                group_by(Particle) %>% 
                                                mutate(num_OTUs_particle = n()) %>% 
                                                ungroup %>% group_by(Sample) %>% 
                                                mutate(ParticleNumberPerSample = n()) %>%
                                                ungroup() %>%
                                                filter(
                                                       num_OTUs_particle > 2,
                                                       total_particle_reads > 50, #changed from 100, Gary shows 1k+ better?
                                                       total_particle_reads < 10000 #Gary removes in recent analyses
                                                ) %>%
                                                ungroup() %>% 
                                                left_join(., Tax_Table) %>% drop_na() %>%
                  semi_join(., otumapping) 



```

QC for the Gerber lab
```{r}

#Look at distribution of otus per particle in each seq run

fulldataset %>% select(Sample, Particle, num_OTUs_particle) %>% distinct() %>% filter(num_OTUs_particle < 20) %>%
  ggplot(., aes(num_OTUs_particle)) + geom_histogram(binwidth = 1, color = 'black') +# scale_x_log10() + 
  theme_cowplot() + facet_wrap(~Sample, scales = 'free_y')

#look at distribution of otus per particle in each mouse
fulldataset %>%  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
  select(mouse, Particle, num_OTUs_particle) %>% distinct() %>% filter(num_OTUs_particle < 10) %>%
  ggplot(., aes(num_OTUs_particle)) + geom_histogram(binwidth = 1, color = 'black') +# scale_x_log10() + 
  theme_cowplot() + facet_wrap(~mouse, scales = 'free_y') 



#how many particles per sample?
particle_counts <- inner_join(CorrectedData %>% select(MouseGroup, Mouse_num, Particle) %>% distinct() %>% group_by(MouseGroup, Mouse_num) %>% mutate(num_particles_corrected = n()) %>% ungroup() %>% select(MouseGroup, Mouse_num, num_particles_corrected) %>% distinct(),
          fulldataset %>% select(Particle,MouseGroup, Mouse_num) %>% distinct() %>% group_by(MouseGroup, Mouse_num) %>%
            mutate(num_particles_fulldataset = n()) %>%  ungroup() %>%
            select(num_particles_fulldataset,MouseGroup, Mouse_num) %>% distinct(), by = c('MouseGroup', 'Mouse_num')) %>% mutate(mouse = paste(MouseGroup,Mouse_num)) 

a<- particle_counts %>% ggplot(., aes(mouse, y = num_particles_fulldataset)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'filtered', y = 'Particles per Sample') + scale_y_log10()

b<- particle_counts %>% ggplot(., aes(mouse, y = num_particles_corrected)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'raw', y = 'Particles per Sample') + scale_y_log10()

plot_grid(a,b)
ggsave('../experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/figs/ParticlesPerSample.png', width=8, height = 4, bg = 'white')
  
#Total particles examined
nrow(distinct(fulldataset %>% select(Particle)))

#How many reads per sample? Kind of even really
a <- fulldataset %>% 
#CorrectedData %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse) %>% mutate(total_counts = sum(Count)) %>% #filter(MouseGroup == 'E') %>%
  select(mouse, total_counts) %>% distinct() %>% 
  ggplot(., aes(mouse, y = total_counts)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'filtered', y = 'Reads per Sample')

b <- CorrectedData %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse) %>% mutate(total_counts = sum(Count)) %>% #filter(MouseGroup == 'E') %>%
  select(mouse, total_counts) %>% distinct() %>% 
  ggplot(., aes(mouse, y = total_counts)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'raw', y = 'Reads per Sample')

plot_grid(a,b)
ggsave('../experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/figs/readsPerSample.png', width=8, height = 4, bg = 'white')






#how many reads per sample normalized to particles
a <- fulldataset %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse) %>% mutate(total_counts = sum(Count)) %>% #filter(MouseGroup == 'E') %>%
  select(mouse, total_counts) %>% distinct() %>% left_join(.,particle_counts, by = 'mouse') %>% 
  mutate(norm_coverage = total_counts/num_particles_fulldataset) %>%
  ggplot(., aes(mouse, y = norm_coverage)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'filtered', y = 'Reads per Particle')

b <- CorrectedData %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse) %>% mutate(total_counts = sum(Count)) %>% #filter(MouseGroup == 'E') %>%
  select(mouse, total_counts) %>% distinct() %>% left_join(.,particle_counts, by = 'mouse') %>% 
  mutate(norm_coverage = total_counts/num_particles_corrected) %>%
  ggplot(., aes(mouse, y = norm_coverage)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + labs(title = 'raw', y = 'Reads per Particle')

plot_grid(a,b)
ggsave('../experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/figs/readsPerParticle.png', width=8, height = 4, bg = 'white')

```

Now let's look at distributions
```{r}

a <- fulldataset %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse, Particle) %>% mutate(total_counts = sum(Count)) %>% 
  select(mouse, Particle, total_counts) %>% distinct() %>% 
  ggplot(., aes(x = total_counts)) + geom_histogram(binwidth = 100, color = 'black') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + facet_wrap(~mouse, scales = 'free_y') +
  labs(title = 'filtered', x = 'Reads per Particle') + xlim(0,10000)
a
ggsave('../experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/figs/readsPerParticle_dist_fulldataset.png', a, width=8, height = 6, bg = 'white')

b <- CorrectedData %>% 
  mutate(mouse = paste(MouseGroup,Mouse_num)) %>%
    group_by(mouse, Particle) %>% mutate(total_counts = sum(Count)) %>% 
  select(mouse, Particle, total_counts) %>% distinct() %>% 
  ggplot(., aes(x = total_counts)) + geom_histogram(binwidth = 100, color = 'black') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + facet_wrap(~mouse, scales = 'free_y') +
  labs(title = 'raw', x = 'Reads per Particle')

ggsave('../experiments/20230516_FMT_MaPS-Seq2/20230823_MaPSFMT_redo_ProcessingScripts/figs/readsPerParticle_dist_corrected.png', b, width=8, height = 6, bg = 'white')



```

Redo fulldataset by selecting same number of particles
```{r}
#how many particles per sample? 20,023 total if swap min for sum here
#swapped MouseGroup for Sample Here
min_particles <- min((fulldataset %>% select(MouseGroup, Particle) %>% 
      group_by(MouseGroup) %>% distinct() %>% mutate(num_particles = n()) %>% ungroup %>%
      select(MouseGroup, num_particles) %>% distinct %>% filter(num_particles > 500))$num_particles)


#Subset min_particles from each group
set.seed(123)
particle_subset <- fulldataset %>% select(MouseGroup, Particle) %>% distinct() %>%
  group_by(MouseGroup) %>% 
  filter(n() >= 500) %>% #remove samples with fewer than 250 particles, 
  slice_sample(n=min_particles, replace = F) %>% ungroup()

fulldataset <- semi_join(fulldataset, particle_subset, by = c('Particle', 'MouseGroup'))


#now subset reads from those particles
#how many particles per sample?
min_reads <- min((fulldataset %>% select(MouseGroup, Count) %>% 
      group_by(MouseGroup) %>% mutate(num_reads = sum(Count)) %>% ungroup %>%
      select(MouseGroup, num_reads) %>% distinct %>%
        filter(num_reads > 200000))$num_reads)


#Subset reads (3766857 each)
set.seed(123)
fulldataset <- fulldataset %>% uncount(Count) %>% group_by(MouseGroup) %>% 
    filter(n() >= 200000) %>%
    slice_sample(n=min_reads, replace = F) %>% ungroup() %>% group_by(MouseGroup, Particle, OTU) %>% mutate(Count = n()) %>% distinct() %>% ungroup



```

How correlated are Jax vs Env v Env2Jax
```{r}

compare <- fulldataset %>% #filter(day == 0 | day == 30) %>%
  select(OTU, MouseGroup, Count) %>% mutate(Count = ifelse(Count >0, 1,0)) %>%
  group_by(MouseGroup, OTU) %>%
  mutate(count = sum(Count)) %>% ungroup() %>% select(-Count) %>% distinct() %>%
  group_by(MouseGroup) %>%
  mutate(relabd=log10(count/sum(count))) %>% filter(relabd > -3) %>%
  ungroup %>% distinct() 


otu_compare <- data.frame(OTU = unique(compare$OTU))
for (i in 1:length(unique(compare$MouseGroup))){

  group = print(unique(compare$MouseGroup)[i])
    temp <- compare %>% filter(MouseGroup == group) %>% 
      select('OTU', 'relabd')  
    names(temp) <- c('OTU', group)
    otu_compare <- left_join(otu_compare, temp)  
  }

otu_compare <- otu_compare %>% column_to_rownames('OTU')
otu_compare <- replace(otu_compare, is.na(otu_compare), -5)

#pairs(otu_compare, panel = panel.smooth)


stat <- signif(cor.test(otu_compare$E, otu_compare$J, method = 'spearman')$estimate, 3)[[1]]

a <- ggplot(otu_compare, aes(E, J)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Jax') + theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$E, otu_compare$J, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
     ylim(-3,-.5) + xlim(-3,-1)

b <- ggplot(otu_compare, aes(JEJ,J)) + 
        geom_point() + geom_smooth(method = 'lm',) + 
        labs(y = 'Jax', x = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$JEJ, otu_compare$J, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
        ylim(-3,-.5) + xlim(-3,-1)

c <- ggplot(otu_compare, aes(E, JEE)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$E, otu_compare$JEJ, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
         ylim(-3,-.5) + xlim(-3,-1)




plot_grid(c,NULL, a,b, nrow = 2)

#ggsave('../figs/fig5/pairwiseOTUcounts.png', width = 6, height = 6)

```


evaluate full dataset
```{r}


#16S composition plot
plot <- fulldataset %>% select(MouseGroup, Family, Count) %>% 
  mutate(Count = ifelse(Count >0, 1,0)) %>%
  ggplot(.,aes(x=MouseGroup, y = Count, fill = Family)) + geom_bar(stat = 'identity', position = 'fill') + theme_clean()

plotly::ggplotly(plot)


#distribution of species counts

fulldataset %>% select(MouseGroup, OTU, Count) %>% group_by(MouseGroup, OTU) %>% 
  mutate(sum_Count = sum(Count)) %>% select(-Count) %>% distinct() %>% left_join(.,Tax_Table) %>%
  ggplot(., aes(OTU,y=sum_Count, fill = Family)) + geom_bar(stat = 'identity') + 
      facet_wrap(~MouseGroup, nrow = 3, scales = 'free_y') + theme_cowplot()

```


Some quick stats...
```{r}

#how many OTUs per group?
fulldataset %>% select(MouseGroup, OTU) %>% distinct() %>% group_by(MouseGroup) %>% mutate(num_OTUs = n()) %>% ungroup %>% select(-OTU) %>% distinct 

#how about if filter for .1% abundance? 
fulldataset %>% select(OTU, MouseGroup, Count) %>% group_by(OTU, MouseGroup) %>% 
  mutate(totalCount = sum(Count)) %>% select(-Count) %>% ungroup %>% distinct %>% 
  group_by(MouseGroup) %>%
  mutate(rel_abd = totalCount/sum(totalCount)) %>% filter(rel_abd > .001) %>% 
  mutate(num_otu = n()) %>% ungroup %>% select(MouseGroup, num_otu) %>% distinct()

#how about if filter for only OTUs that show up in .1% of particles?
fulldataset %>% select(OTU, MouseGroup) %>% group_by(OTU, MouseGroup) %>% 
  mutate(totalparticleObs = n()) %>%  ungroup %>% distinct %>% 
  group_by(MouseGroup) %>%
  mutate(rel_obs = totalparticleObs/sum(totalparticleObs)) %>% filter(rel_obs > .001) %>% 
  mutate(num_otu = n()) %>% ungroup %>% select(MouseGroup, num_otu) %>% distinct()

#num OTUs per particle
a<- fulldataset %>% select(Particle, OTU, MouseGroup) %>% distinct() %>% group_by(Particle, MouseGroup) %>% mutate(num_otus = n()) %>% ungroup %>% select(-OTU) %>% distinct() %>% 
    ggplot(., aes(num_otus, fill = MouseGroup)) + 
    geom_histogram(position = 'dodge') +
    #geom_density(alpha = .2) + 
    #scale_y_log10() + 
  theme_cowplot() + labs (y= "Density", x = "Number of OTUS per particle")
a

a_1 <-fulldataset %>% select(Particle, OTU, MouseGroup) %>% filter(MouseGroup != 'JEE') %>% distinct() %>% group_by(Particle, MouseGroup) %>% mutate(num_otus = n()) %>% ungroup %>% select(-OTU) %>% distinct() %>% 
  ggplot(., aes(factor(MouseGroup, levels = c('E','J','JEJ')), num_otus)) + 
    stat_boxplot(geom = "errorbar", width = .1) + 
geom_boxplot(outlier.shape = NA) + geom_jitter(alpha = .2, size = .2) +
  ggsignif::geom_signif(
    comparisons = list(c('E', 'JEJ'), 
                       c('JEJ', 'J'),
                       c('E', 'J')),
    map_signif_level = T,
        y_position = c(17, 15, 19),
    test = 'wilcox.test') +
    scale_y_continuous(breaks = c(0,10,20,30))+
   theme_cowplot() + labs(x = 'Mouse Group', y = 'Number of OTUs\nper particle')

a_1

ggsave("../figs/s5/5a_OTUsperParticle.png", a_1, width = 3.5, height = 3.5)
ggsave("../figs/s5/5a_OTUsperParticle.pdf", a_1, width = 3.5, height = 3.5)

fulldataset %>% select(Particle, OTU, MouseGroup) %>% distinct() %>% group_by(Particle, MouseGroup) %>%
    mutate(num_otus = n()) %>% ungroup() %>% select(-OTU) %>% 
    distinct() %>% group_by(MouseGroup) %>% mutate(mean_otus = mean(num_otus)) %>%
    ungroup %>% select(MouseGroup,mean_otus) %>% distinct()


#num Reads per particle
b<-fulldataset %>% select(Particle, MouseGroup, total_particle_reads) %>% distinct() %>%
    #ggplot(., aes(x = MouseGroup, y = total_particle_reads)) + 
    #geom_boxplot() + geom_jitter(alpha = .1) + scale_y_log10() + theme_cowplot() + labs(y="Reads per Particle")
  ggplot(., aes(fill = MouseGroup, x = total_particle_reads)) + geom_density(alpha = .2) + scale_x_log10() + theme_cowplot() + labs(x='Reads per particle', y = 'Density')
b

plot_grid(a,b, nrow = 2, rel_heights = c(.75,1))

#how many particles per sample?
particle_counts <- inner_join(CorrectedData %>% select(Sample, Particle) %>% distinct() %>% group_by(Sample) %>% mutate(num_particles = n()) %>% select(Sample, num_particles) %>% distinct(),
          fulldataset %>% select(Sample, Particle,MouseGroup) %>% distinct() %>% group_by(Sample) %>% mutate(num_particles = n()) %>% select(Sample, num_particles,MouseGroup) %>% distinct(), by = 'Sample')


#Total particles examined
nrow(distinct(fulldataset %>% select(Particle)))

#How many reads per sample? Kind of even really
fulldataset %>% 
#CorrectedData %>%
    group_by(Sample) %>% mutate(total_counts = sum(Count)) %>% filter(MouseGroup == 'E') %>%
  select(Sample, total_counts) %>% distinct() %>% 
  ggplot(., aes(Sample, y = total_counts)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) 

#how many reads per sample normalized to particles
num_particles <- CorrectedData %>% select(Sample, Particle) %>% distinct() %>% group_by(Sample) %>% mutate(num_particles = n()) %>% ungroup %>% select(-Particle) %>% distinct()

fulldataset %>% 
  #CorrectedData %>%
  left_join(., num_particles) %>% group_by(Sample) %>% filter(MouseGroup == 'E') %>%
  mutate(total_counts = sum(Count)) %>%
  mutate(norm_counts = total_counts/num_particles) %>% 
  select(Sample, norm_counts) %>% distinct() %>% 
  ggplot(., aes(Sample, y = norm_counts)) + geom_bar(stat = 'identity') + theme_cowplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) 
  

#How many OTUs per sample?
OTU_counts <- inner_join(CorrectedData %>% select(Sample, OTU) %>% distinct() %>% group_by(Sample) %>% mutate(num_OTUs = n()) %>% select(Sample, num_OTUs) %>% distinct(),
          fulldataset %>% select(Sample, OTU,MouseGroup) %>% distinct() %>% group_by(Sample) %>% mutate(num_OTUs = n()) %>% select(Sample, num_OTUs,MouseGroup) %>% distinct(), by = 'Sample') %>% ungroup() 




#It's not like there's fewer particles, JE mice have fewer OTUs 

a <- ggplot(OTU_counts, aes(MouseGroup, y = num_OTUs.x)) + geom_bar(stat = 'identity')
b <- ggplot(OTU_counts, aes(MouseGroup, y = num_OTUs.y)) + geom_bar(stat = 'identity')
plot_grid(a,b, nrow = 2)


#compare # of particles after filtering, seems pretty equal to me
a <- ggplot(particle_counts, aes(MouseGroup, y = num_particles.x)) + 
  geom_boxplot() + theme_cowplot()
b <- ggplot(particle_counts, aes(MouseGroup, y = num_particles.y)) + 
  geom_boxplot()+ theme_cowplot()
plot_grid(a,b, nrow = 2)

```


#QUICK abundance calculations
```{r}
#fulldataset %>% select(OTU, MouseGroup, Count, Class, Order, Family) %>% 
#  group_by(OTU, MouseGroup) %>% 
#  mutate(Instances_OTU = sum(Count)) %>% ungroup %>% select(-Count) %>% distinct() %>%
#  group_by(MouseGroup) %>% mutate(prop_OTU = Instances_OTU/sum(Instances_OTU)*100) %>% ungroup() %>% 
#  mutate(alpha = ifelse(prop_OTU > .5, 1, .01)) %>% distinct() %>%
#  write.csv(., "../tables/Instances_MaPS-Seq.csv", row.names = F, quote = F)


#This normalizes read counts in each sample, averages between samples for each group
OTUcounts <- fulldataset %>% select(OTU, MouseGroup, Sample, Count, Class, Order, Family) %>%
  mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
  group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% select(-Count) %>%
  group_by(OTU, MouseGroup) %>% mutate(group_Count = mean(norm_Count),
                                       Instances_OTU = sum(group_Count)) %>%
  ungroup %>% select(OTU, MouseGroup, group_Count, Instances_OTU, Class, Order, Family) %>% distinct() %>%
  group_by(MouseGroup) %>% mutate(prop_OTU = Instances_OTU/sum(Instances_OTU)*100) %>% ungroup() %>% 
  mutate(alpha = ifelse(prop_OTU > .5, 1, .01)) 

write.csv(OTUcounts, "../tables/Instances_MaPS-Seq.csv", row.names = F, quote = F)

OTUcounts %>% select(OTU, MouseGroup) %>% group_by(MouseGroup) %>% distinct() %>% mutate(num_OTUs = n()) %>% select(-OTU) %>% distinct()


OTUcounts %>% filter(prop_OTU > .7) %>% select(OTU, MouseGroup) %>% 
          group_by(MouseGroup) %>% distinct() %>% mutate(num_OTUs = n()) %>% 
        select(-OTU) %>% distinct()

#plot correlations between OTUs
OTUcounts %>% select(OTU, MouseGroup, env_count=group_Count) %>% filter(MouseGroup == 'Env') %>% 
  full_join(., OTUcounts %>% select(OTU, MouseGroup, jax_count=group_Count) %>% 
              filter(MouseGroup == 'Env2Jax'), by = 'OTU') %>% 
  mutate_all(~replace_na(.$env_count, 0),~replace_na(.$jax_count, 0)) %>% 
  ggplot(., aes(env_count, jax_count)) + geom_point() + theme_cowplot() + scale_x_log10() + scale_y_log10()


#plot abundance of species
fulldataset %>% select(OTU, MouseGroup, Count) %>% left_join(., Tax_Table) %>% 
  ggplot(.,aes(x=MouseGroup, y = Count, fill = Family)) + geom_bar(stat = 'identity', position = 'fill') + theme_cowplot()

ggsave(filename = "../figs/fig5/Composition.pdf", width = 4, height = 3)

# Create a data frame with the OTUs for each MouseGroup

# Use group_by and summarize to find the shared OTUs
temp <- OTUcounts %>% select(OTU, MouseGroup)
df_shared <-  temp %>%
  group_by(OTU) %>%
  summarize(n_shared = n_distinct(MouseGroup)) %>%
  filter(n_shared > 1)

# Print the results
cat(paste("Shared OTUs between Env and Jax:", intersect(temp$OTU[temp$MouseGroup == "E"], temp$OTU[temp$MouseGroup == "J"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "E"],temp$OTU[temp$MouseGroup == "J"])

cat(paste("Shared OTUs between Env and Env2Jax:", intersect(temp$OTU[temp$MouseGroup == "Env"],temp$OTU[temp$MouseGroup == "JEJ"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "E"],temp$OTU[temp$MouseGroup == "JEE"])

cat(paste("Shared OTUs between Jax and Env2Jax:", intersect(temp$OTU[temp$MouseGroup == "Jax"],temp$OTU[temp$MouseGroup == "JEJ"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "J"],temp$OTU[temp$MouseGroup == "JEJ"])


```

How many species per MouseGroup?
```{r}


read.csv("../tables/Instances_MaPS-Seq.csv") %>% #filter(prop_OTU > .1) %>%
  select(OTU, Class, MouseGroup) %>% distinct() %>% 
  group_by(MouseGroup, Class) %>% mutate(num_class = n()) %>% 
  select(-OTU) %>% distinct() %>% 
  write.csv("../tables/MaPS-Seq_ClassCounts.csv", quote = F, row.names = F)

```


Let's look at aggregate measurements for unfiltered data?
```{r}
  
temp <- CorrectedData %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
   #summarise(unique_count = n_distinct(Particle))
# group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, OTU_count) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% filter(log10_prev > -3) %>%
  ungroup %>% select(OTU, Sample, log10_prev) %>% distinct()  

#temp %>% ggplot(., aes(Sample, OTU, fill = log10_prev)) + geom_tile()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~Sample)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) #add fam data

vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
                         levels = c("Jax","Env", "Env2Jax"))

# Heatmap
heatmap.plot <- vendor.long %>% filter(Class == 'Bacteroidia') %>% 
  ggplot(., aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse', fill ='Relative Abundance',
       y = "OTU") +
 # facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = Class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/bulk_prevalence_MaPS-Seq.pdf",  width = 9, height = 5)

```



Let's look at bulk measurements? Don't exist... Have to do heat map.
```{r}
  
temp <- fulldataset %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
  #filter(Sample != 'J4r2' & Sample != 'E5r2') %>%
    #filter(Sample != 'E8r1' & Sample != 'E8r2') %>%
   #summarise(unique_count = n_distinct(Particle))
 group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, MouseGroup, OTU_count,Class, Order, Family) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% filter(log10_prev > -3) %>%
  ungroup %>% select(OTU, Sample,MouseGroup, log10_prev) %>% distinct()  

#temp %>% ggplot(., aes(Sample, OTU, fill = log10_prev)) + geom_tile()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~Sample)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) %>% #add family data
    left_join(., (select(temp, Sample, MouseGroup) %>% distinct()), by = c('variable'='Sample')) #add vendor data
vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
                         levels = c("J","E", "JEJ"))

# Heatmap
heatmap.plot <- ggplot(data = vendor.long, aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse', fill ='Relative Abundance',
       y = "OTU") +
  facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = Class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/bulk_prevalence_MaPS-Seq.pdf",  width = 9, height = 5)

```



Just Jax and Env heat map?
Let's look at bulk measurements? Don't exist... Have to do heat map.
```{r}
  
temp <- fulldataset %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
   #summarise(unique_count = n_distinct(Particle))
# group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #filter(MouseGroup != 'Env2Jax') %>%
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, MouseGroup, OTU_count,Class, Order, Family) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% 
  ungroup %>% select(OTU, Sample,MouseGroup, log10_prev) %>%
  distinct() %>% group_by(OTU, MouseGroup) %>% mutate(median_prev = mean(log10_prev)) %>% ungroup %>%
  select(MouseGroup, OTU, median_prev) %>% distinct()

temp %>% filter(log10_prev > -2) %>% select(OTU) %>% distinct()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~MouseGroup)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) %>% #add family data
    left_join(., (select(temp, MouseGroup) %>% distinct()), by = c('variable'='MouseGroup')) #add vendor data
vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
#vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
#                         levels = c("Jax","Env", "Env2Jax"))

# Heatmap
heatmap.plot <- ggplot(data = vendor.long, aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2.5) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse (N = 10 / Vendor)', fill ='Relative Abundance',
       y = "OTU") +
 # facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = Class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/old_fig5/SampleHeatmaps.svg",  width = 5, height = 5)

```

