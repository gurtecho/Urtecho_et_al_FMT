---
title: "fig5_PolysaccharideMuribac"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(tidytext)
library(cowplot)
source("CompteSpearmanCorrelationAndMelt.R")


ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")
bugColors <- read.csv('../tables/bugColors.csv')$x

options(stringsAsFactors = F)
options(scipen = 10000)

CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/CorrectedDataFrame.csv")
Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/SilvaTax.csv")
otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/DeSeq_OTU_dynamics.csv")

```



Let's see how cluster proportions shift after treatments

```{r}
plotframe <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/plotframe.csv")

plotframe <- plotframe %>% 
  group_by(Sample) %>% 
  mutate(proportion_cluster = NumberParticles/sum(NumberParticles)) %>% 
  ungroup() %>%
  group_by(MouseGroup, Cluster) %>%
  mutate(musgroup_proportion_cluster = mean(proportion_cluster)) %>% ungroup() %>%
  select(MouseGroup,Cluster, musgroup_proportion_cluster) %>% distinct() %>%
  mutate(noFMT_score = ifelse(MouseGroup == 'Jax',log10(musgroup_proportion_cluster), NA),    
         postFMT_score = ifelse(MouseGroup == 'Env2Jax',log10(musgroup_proportion_cluster), NA),
         Env_score = ifelse(MouseGroup == 'Env',log10(musgroup_proportion_cluster), NA)) %>%
  select(Cluster, noFMT_score, postFMT_score, Env_score) %>% 
  mutate_all(~replace(., is.na(.), -10000000)) %>% #need to replace NA to calculate MAX
  group_by(Cluster) %>%
  mutate(noFMT_score = max(noFMT_score),
         postFMT_score = max(postFMT_score),
         Env_score = max(Env_score)) %>% ungroup() %>% distinct() %>% mutate(delta_fmt = postFMT_score-noFMT_score, Cluster = as.factor(Cluster)) %>% 
    mutate(direction = ifelse(delta_fmt > 0, 'Increase', 'Decrease'))

plotframe[plotframe == -10000000] <- -3   #for samples with filler value, replace with 

ggplot() +
    scale_x_continuous(breaks=seq(-3,2,1)) +
  geom_point(data=plotframe, aes(x = noFMT_score, y = Cluster), color = 'Dodgerblue', shape = 'square', size = 3) +
  geom_point(data=plotframe, aes(x = postFMT_score, y = Cluster), color = 'orange', size = 3) +
  #geom_point(data=plotframe, aes(x = Env_score, y = Cluster), color = 'red', size = 2, shape = 4) +  #add envigo as X
  geom_segment(data=plotframe, aes(x=noFMT_score , y = Cluster, 
                                   xend = postFMT_score, yend = Cluster, color = direction),
                  arrow = arrow(length = unit(0.15, "cm"), type = 'closed'), 
                                lineend = "butt",
                                linejoin = "round") +
  scale_color_manual(values = c("#ff1d25", "#29af7f")) +
  labs(x = 'log10(Relative abundance)', y = 'Cluster', color = 'Delta Abundance') +
  theme_clean() +
      theme(axis.text.x = element_text(size=12,color = 'black'), 
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'bottom')

ggsave("../figs/fig5/ClusterDelta.png",  width = 2.5, height = 4.5)
ggsave("../figs/fig5/ClusterDelta.pdf",  width = 2.5, height = 4.5)



```


#Assemble all prevalent sets
```{r}

PrevalentSets <- rbind((read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Env2Jax.csv") %>% 
  mutate(MouseGroup = 'Env2Jax')),
(read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Jax.csv") %>% 
  mutate(MouseGroup = 'Jax')),
(read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Env.csv") %>% 
  mutate(MouseGroup = 'Env'))) %>% select(-X) %>% mutate(MouseGroup = as.factor(MouseGroup))

#Bound Zscores
PrevalentSets$Zscore[PrevalentSets$Zscore < -1e6] <- -16

```

#5c? Make network diagram of mean bacteroides interactions, show present nodes arranged in auto


FOR BACTEROIDALES   Jax (A) COLOR_FLIPPED
```{r}

library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Family_OTU1)))), c(levels(as.factor(PrevalentSets$Family_OTU1))))

#average interactions 
mean_interactions <- PrevalentSets %>% group_by(MouseGroup, OTU1, OTU2) %>% 
  filter(zpadjusted < .01) %>% 
  mutate(average_corr = mean(Zscore),
         average_sig = mean(zpadjusted),
         interaction = ifelse(average_corr > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, average_corr, average_sig,interaction,MouseGroup, 
         Class_OTU1, Family_OTU1, Class_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Count OTU instances
Instances <- rbind(PrevalentSets %>% select(MouseGroup, OTU1, Instances=InstancesOTU1) %>% distinct(),
                   PrevalentSets %>% select(MouseGroup, OTU1=OTU2, Instances=InstancesOTU2) %>% distinct()) %>% 
  group_by(MouseGroup, OTU1) %>% mutate(total_instances = (sum(Instances))) %>% ungroup() %>% 
  select(OTU1, MouseGroup, total_instances) %>% distinct() %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1))

#Let's try when we count instances immediately
Instances_new <- read.csv("../tables/Instances_MaPS-Seq.csv") %>% 
    select(OTU1=OTU, prop_OTU, MouseGroup, Order, Family, alpha) %>%
    mutate(OTU1 = gsub('Otu', '', .$OTU1))


#tbl_nodes[unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1),]
#unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1)


# Create data frame for edges

cluster_network <- mean_interactions %>% #left_join(., Instances, by = c("OTU1", "MouseGroup")) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) #only significant interactions




#Make dummy edges
tbl_edges_all <- cluster_network %>% 
  filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
    select(OTU1, OTU2, Class_OTU1,Class_OTU2) %>% 
    #mutate(interaction = 1) %>% 
    distinct()

edges <- rbind(select(tbl_edges_all,OTU1, Class_OTU1), select(tbl_edges_all, OTU1=OTU2, Class_OTU1=Class_OTU2)) %>% distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
  filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, Class_OTU1) %>%
  distinct() %>% left_join(edges,.) %>%   
  mutate(OTU1 = as.numeric(OTU1)) %>%
  arrange(OTU1) %>% mutate(OTU1 = as.character(OTU1)) %>% distinct()
# %>%filter(OTU1 != '81' & OTU1 != '84') #remove OTUs in Env but not others...

  



# - FMT


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in -FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
  left_join(., filter(Instances_new, MouseGroup == 'Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 81 | V(.)$name == 84)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.001, 2)
                       ) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) + #FLIPPED
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  labs(color = 'Order', 
         title = "Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
a
# Env

#Get nodes found in Env



#Now layer edges for Env
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in Env

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env'))



#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data. remove OTU not found in Env2jax or Jax
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 81 | V(.)$name == 84)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)


# +FMT

#Now layer edges for +FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in +FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Bacteroidia' & Class_OTU2 == 'Bacteroidia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env2Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 81 | V(.)$name == 84)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env2Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 


c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
c

leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = average_corr), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Family_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    

temp <- cowplot::plot_grid(a,c,b,  nrow = 1)
temp
ggsave("../figs/fig5/5E_InteractionNetworks.png", width = 8,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks.pdf", width = 8,height = 2.8)

cowplot::plot_grid(leg)
ggsave("../figs/fig5/5E_InteractionNetworks_leg.png", width = 14,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_leg.pdf", width = 14,height = 2.8)
cowplot::plot_grid(temp, leg, nrow = 2)
```


FOR Clostridia
```{r}

library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Family_OTU1)))), c(levels(as.factor(PrevalentSets$Family_OTU1))))

#average interactions 
mean_interactions <- PrevalentSets %>% group_by(MouseGroup, OTU1, OTU2) %>% 
  filter(zpadjusted < .01) %>% 
  mutate(average_corr = mean(Zscore),
         average_sig = mean(zpadjusted),
         interaction = ifelse(average_corr > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, average_corr, average_sig,interaction,MouseGroup, 
         Class_OTU1, Family_OTU1, Class_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Count OTU instances
Instances <- rbind(PrevalentSets %>% select(MouseGroup, OTU1, Instances=InstancesOTU1) %>% distinct(),
                   PrevalentSets %>% select(MouseGroup, OTU1=OTU2, Instances=InstancesOTU2) %>% distinct()) %>% 
  group_by(MouseGroup, OTU1) %>% mutate(total_instances = (sum(Instances))) %>% ungroup() %>% 
  select(OTU1, MouseGroup, total_instances) %>% distinct() %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1))

#Let's try when we count instances immediately
Instances_new <- read.csv("../tables/Instances_MaPS-Seq.csv") %>% 
    select(OTU1=OTU, prop_OTU, MouseGroup, Order, Family, alpha) %>%
    mutate(OTU1 = gsub('Otu', '', .$OTU1))


#tbl_nodes[unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1),]
#unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1)


# Create data frame for edges

cluster_network <- mean_interactions %>% #left_join(., Instances, by = c("OTU1", "MouseGroup")) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) #only significant interactions




#Make dummy edges
tbl_edges_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
    select(OTU1, OTU2, Class_OTU1,Class_OTU2) %>% 
    #mutate(interaction = 1) %>% 
    distinct()

edges <- rbind(select(tbl_edges_all,OTU1, Class_OTU1), select(tbl_edges_all, OTU1=OTU2, Class_OTU1=Class_OTU2)) %>% distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
  select(OTU1, Class_OTU1) %>%
  distinct() %>% left_join(edges,.) %>%   
  mutate(OTU1 = as.numeric(OTU1)) %>%
  arrange(OTU1) %>% mutate(OTU1 = as.character(OTU1)) %>% distinct()



# - FMT


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in -FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
  left_join(., filter(Instances_new, MouseGroup == 'Jax'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.001, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  labs(color = 'Order', 
         title = "Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
a
# Env

#Get nodes found in Env



#Now layer edges for Env
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in Env

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)
#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)


# +FMT

#Now layer edges for +FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
      select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in +FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' & Class_OTU2 == 'Clostridia') %>%
   mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env2Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T) %>% 
    delete_vertices(., V(.)$name == 27 | V(.)$name == 49 | V(.)$name == 68 | 
                      V(.)$name == 95 | V(.)$name == 73)
#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  #geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env2Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 


c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
c

leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = average_corr), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Family_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    

temp <- cowplot::plot_grid(a,c,b,  nrow = 1)
temp
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno.png", width = 8,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno.pdf", width = 8,height = 2.8)

cowplot::plot_grid(leg)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno_leg.png", width = 14,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_Lachno_leg.pdf", width = 14,height = 2.8)
cowplot::plot_grid(temp, leg, nrow = 2)
```

For both

```{r}

library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Family_OTU1)))), c(levels(as.factor(PrevalentSets$Family_OTU1))))

#average interactions 
mean_interactions <- PrevalentSets %>% group_by(MouseGroup, OTU1, OTU2) %>% 
  filter(zpadjusted < .01) %>% 
  mutate(average_corr = mean(Zscore),
         average_sig = mean(zpadjusted),
         interaction = ifelse(average_corr > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, average_corr, average_sig,interaction,MouseGroup, 
         Class_OTU1, Family_OTU1, Class_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Count OTU instances
Instances <- rbind(PrevalentSets %>% select(MouseGroup, OTU1, Instances=InstancesOTU1) %>% distinct(),
                   PrevalentSets %>% select(MouseGroup, OTU1=OTU2, Instances=InstancesOTU2) %>% distinct()) %>% 
  group_by(MouseGroup, OTU1) %>% mutate(total_instances = (sum(Instances))) %>% ungroup() %>% 
  select(OTU1, MouseGroup, total_instances) %>% distinct() %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1))

#Let's try when we count instances immediately
Instances_new <- read.csv("../tables/Instances_MaPS-Seq.csv") %>% 
    select(OTU1=OTU, prop_OTU, MouseGroup, Order, Family, alpha) %>%
    mutate(OTU1 = gsub('Otu', '', .$OTU1))


#tbl_nodes[unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1),]
#unique(tbl_nodes$Class_OTU1) %in% unique(PrevalentSet$Class_OTU1)


# Create data frame for edges

cluster_network <- mean_interactions %>% #left_join(., Instances, by = c("OTU1", "MouseGroup")) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) #only significant interactions




#Make dummy edges
tbl_edges_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
    select(OTU1, OTU2, Class_OTU1,Class_OTU2) %>% 
    #mutate(interaction = 1) %>% 
    distinct()

edges <- rbind(select(tbl_edges_all,OTU1, Class_OTU1), select(tbl_edges_all, OTU1=OTU2, Class_OTU1=Class_OTU2)) %>% distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, Class_OTU1) %>%
  distinct() %>% left_join(edges,.) %>%   
  mutate(OTU1 = as.numeric(OTU1)) %>%
  arrange(OTU1) %>% mutate(OTU1 = as.character(OTU1)) %>% distinct()



# - FMT


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in -FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
      mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
      mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
  left_join(., filter(Instances_new, MouseGroup == 'Jax'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')

#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.001, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family, alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  labs(color = 'Order', 
         title = "Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
a
# Env

#Get nodes found in Env



#Now layer edges for Env
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in Env

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
      mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env'))


#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)


# +FMT

#Now layer edges for +FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
  select(OTU1, OTU2, average_corr, average_sig) %>% 
    mutate(interaction = ifelse(average_corr > 0, 'Positive', 'Negative'),
           zpadjusted=log10(1/average_sig)) %>%
    select(OTU1, OTU2, interaction, average_corr) %>%
    #left_join(tbl_edges_all, ., by = c('OTU1','OTU2')) %>%
    replace(is.na(.), 0) %>%
    distinct()


#Get nodes found in +FMT

tbl_nodes <- rbind(cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
      mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1, Family_OTU1)%>% distinct(),
    cluster_network %>% filter(MouseGroup == 'Env2Jax') %>%
    filter(Class_OTU1 == 'Clostridia' | Class_OTU1 == 'Bacteroidia') %>%
    filter(Class_OTU2 == 'Clostridia' | Class_OTU2 == 'Bacteroidia') %>%
      mutate(OTU2 = gsub('Otu', '', .$OTU2)) %>% select(OTU1=OTU2, Family_OTU1=Family_OTU2)%>% distinct()) %>% 
    mutate(alpha = 1) %>% distinct() %>% left_join(., filter(Instances, MouseGroup == 'Jax'), by = 'OTU1') %>%
    select(-MouseGroup) %>% mutate(total_instances = as.numeric(total_instances)) %>%
  left_join(tbl_nodes_all, ., by = 'OTU1') %>% 
  mutate(Family_OTU1 = ifelse(is.na(Family_OTU1), 'Undetermined', Family_OTU1)) %>%
  replace(is.na(.), .01) %>% distinct() %>% select(-alpha) %>%
    left_join(., filter(Instances_new, MouseGroup == 'Env2Jax'))

#Find missing taxa & remove their edges
missing_taxa <- tbl_nodes %>% filter(alpha == .01) %>% select(OTU1) %>% mutate(OTU2=OTU1)

tbl_edges <- tbl_edges %>% anti_join(., missing_taxa, 'OTU1') %>% anti_join(., missing_taxa, 'OTU2')


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(
                      edge_width = abs(average_corr)*.001, 
                       alpha = abs(average_corr), 
                       edge_color = interaction),) +
      scale_edge_width(
                       aes((average_corr)),
                       range = c(.01, 2)
                       ) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
  geom_node_point(aes(size = prop_OTU, alpha = alpha), color = 'black') +
  geom_node_point(aes( size = prop_OTU*.6, color = Family,alpha = alpha)) +
  scale_color_manual(values = bugColors) +
     scale_size(range = c(.001,11)) +
  scale_color_manual(values = bugColors) +
  labs(color = 'Order', 
         title = "Env2Jax") +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 


c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .3, nudge_y = nodes$data$y * .3, check_overlap=FALSE)
c

leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = average_corr), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Family_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    

temp <- cowplot::plot_grid(a,c,b,  nrow = 1)
temp
ggsave("../figs/fig5/5E_InteractionNetworks_baclac.png", width = 8,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_baclac.pdf", width = 8,height = 2.8)

cowplot::plot_grid(leg)
ggsave("../figs/fig5/5E_InteractionNetworks_baclac_leg.png", width = 14,height = 2.8)
ggsave("../figs/fig5/5E_InteractionNetworks_baclac_leg.pdf", width = 14,height = 2.8)
cowplot::plot_grid(temp, leg, nrow = 2)
```



Distribution of the # of interactions per species 
```{}
rbind(edge_count_pre %>% mutate(MouseGroup = 'Jax'),
      edge_count_post %>% mutate(MouseGroup = 'Env2Jax')) %>%
  ggplot(., aes(num_edges, fill = MouseGroup)) + 
    geom_density(alpha = .2) + theme_cowplot() + 
    labs(x = 'Number of Interactions', y = 'Density')

t.test(edge_count_pre$num_edges, edge_count_post$num_edges)

ggsave("../figs/s5/S5X_interactionDistributions.pdf", width = 5, height = 2)
```

How much of microbiome is shared
```{r}

PrevalentSets %>%  #filter(Significant == T) %>% 
  select(OTU1, MouseGroup, OTU1Type) %>% mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% 
  distinct() %>%
  left_join(., Instances_new, by = c('MouseGroup', 'OTU1')) %>% 
  select(OTU1Type, MouseGroup, prop_OTU) %>% 
  ggplot(., aes(MouseGroup, prop_OTU, fill = OTU1Type)) +
  geom_bar(stat='identity') + theme_cowplot()



PrevalentSets %>% filter(Significant == T) %>% 
  select(OTU1, MouseGroup, OTU1Type) %>% distinct() %>% 
  ggplot(., aes(x = factor(MouseGroup, levels = c('Jax', 'Env', 'Env2Jax')),
                fill = OTU1Type)) + 
  labs(x = '', y = 'Number of Interacting Species', fill = 'OTU Type') + 
  geom_bar(stat = 'count') + theme_cowplot()

temp <- PrevalentSets %>% 
  select(MouseGroup, OTU1, OTU2, OTU1Type, OTU2Type, Significant) %>% distinct()

rbind((temp %>% select(MouseGroup, OTU2=OTU1, OTU1=OTU2, OTU2Type=OTU1Type, OTU1Type=OTU2Type, Significant)), temp) %>% distinct() %>%
  group_by(MouseGroup) %>% mutate(grp_interactions = n()) %>% ungroup() %>%
  filter(Significant == T) %>% 
  group_by(MouseGroup, OTU1Type, OTU2Type) %>% 
  mutate(prcnt_interactions = signif(n()/grp_interactions, 3)*100) %>% 
  ungroup() %>% select(MouseGroup, OTU1Type, OTU2Type, prcnt_interactions) %>% 
  distinct() %>% group_by(MouseGroup) %>% 
  mutate(normalized_perc = signif(prcnt_interactions/sum(prcnt_interactions)*100, 3)) %>% 
  ungroup %>%
  ggplot(., aes(OTU1Type, OTU2Type, fill = (normalized_perc))) + geom_tile() +
  geom_text(aes(label = normalized_perc), color = 'white', size = 5, fill = 'black') +
  theme_cowplot() + labs(fill = '% of Interactions') +
  scale_fill_gradientn(colors = pal) +
  facet_wrap(~MouseGroup) + 
  theme(strip.background = element_blank(), 
    strip.text = element_text(size = 14))
    
                              
  


```

Are interactions occuring between Env taxa or Env-recipient or recipient-recipient
```{r}

#uncomment lines to separate engrafted vs unengrafted microbes
temp <- PrevalentSets %>% 
  filter(Significant == T) %>% 
  mutate(interaction_type = ifelse(Zscore > 0, 'Positive', 'Negative')) %>%
  select(MouseGroup, OTU1Type, OTU2Type,OTU1, OTU2,Class_OTU1, Class_OTU2, interaction_type) %>%
  mutate(interaction = NA) %>% 
  distinct() %>%
  mutate(interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Donor Taxa', 'Env-Env', interaction),
         interaction = ifelse(OTU1Type == 'Recipient Taxa' & OTU2Type == 'Recipient Taxa', 'Jax-Jax', interaction),
         interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Recipient Taxa', 'Env-Jax', interaction),
         interaction = ifelse(OTU1Type == 'Donor Taxa' & OTU2Type == 'Shared Taxa', 'Env-shared', interaction),
         interaction = ifelse(OTU1Type == 'Recipient Taxa' & OTU2Type == 'Shared Taxa', 'Jax-shared', interaction),
         interaction = ifelse(OTU1Type == 'Shared Taxa' & OTU2Type == 'Shared Taxa', 'shared-shared', interaction)) %>% na.omit()


#how many interactions for each?
temp %>% group_by(MouseGroup) %>% 
  mutate(num_interactions = n()) %>% ungroup %>%
  select(MouseGroup, num_interactions) %>% distinct()


temp$interaction <- factor(temp$interaction, levels=c("Env-Env", "Jax-Jax", "Env-Jax", "Env-shared", "Jax-shared", "shared-shared")) 
#What types of interactions do we see

temp %>% ggplot(., aes(x=interaction, fill =interaction_type)) + 
  geom_bar(stat = 'count', position = 'stack') + 
  scale_fill_manual(values = c('dodgerblue','firebrick2')) +
  labs(x= 'Interacting Pair', y = '# of Interactions', fill = 'Interaction Type') +
  theme_clean() + 
  facet_wrap(~MouseGroup, nrow = 3, strip.position = 'right') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 16),
        axis.text.y = element_text(size=16, color = 'black'),
        axis.title.x.bottom = element_text(size = 16,color = 'black'),
        axis.title.y.left = element_text(size = 16,color = 'black'),
        legend.position = 'top')

ggsave("../figs/s5/5C_ALLInteractionCounts.png", width = 3.5, height = 5)
ggsave("../figs/s5/5C_ALLInteractionCounts.pdf", width = 3.5, height = 5)

temp %>% filter(interaction != 'Env-Env' & interaction != 'Env-recipient' & interaction != 'recipient-recipient') %>% 
  ggplot(., aes(x=interaction, fill =interaction_type)) + 
  geom_bar(stat = 'count', position = 'stack') + 
  scale_fill_manual(values = c('dodgerblue','firebrick2')) +
  labs(x= 'Interacting Pair', y = '# of Interactions', 
       fill = 'Interaction Type') +
  theme_clean() + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')), nrow = 1, strip.position = 'top') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 10),
        axis.text.y = element_text(size=10, color = 'black'),
        axis.title.x.bottom = element_text(size = 12,color = 'black'),
        axis.title.y.left = element_text(size = 12,color = 'black'),
        legend.position = 'right', strip.text = element_text(size = 12))

#ggsave("../figs/fig5/5X_InteractionCounts.png", width = 5, height = 2.5)
#ggsave("../figs/fig5/5X_InteractionCounts.pdf", width = 5, height = 2.5)

```

What is distribution of number of interactions amongst OTUs?
```{r}
df <- rbind(
  temp %>% select(MouseGroup, 'OTU'=OTU1),
  temp %>% select(MouseGroup, 'OTU'=OTU2)) %>% 
  group_by(MouseGroup, OTU) %>% mutate(num_OTU_interactions = n()) %>% 
  ungroup %>% distinct() 
  
  
ggplot(df, aes(num_OTU_interactions, fill = MouseGroup)) + 
  geom_histogram(bins = 10, color = 'black') + facet_wrap(~MouseGroup) + theme_cowplot() + geom_density()
  
```


Interesting, preFMT - specific communities don't interact much! Universal microbes do interact in all communities. Env microbes also are able to interact with shared bugs, who are these interactors?


Now let's do Class split by interaction type
```{r}

temp_2 <- rbind(select(temp, MouseGroup, OTU1, OTU2, Class_OTU1, Class_OTU2, interaction_type), 
  (select(temp, MouseGroup, 'OTU1'='OTU2', 'OTU2'='OTU1', 'Class_OTU2'='Class_OTU1', 'Class_OTU1'='Class_OTU2', interaction_type))) %>% distinct() %>% 
  group_by(MouseGroup, Class_OTU1, Class_OTU2, interaction_type) %>% 
  mutate(num_interactors = n()) %>% ungroup() %>% select(-OTU1, -OTU2) %>% 
  mutate(num_interactors = as.numeric(num_interactors)) %>% distinct()

#get coordinates for background
grid <- rbind(data.frame(Class_OTU1=temp$Class_OTU1), data.frame(Class_OTU1=temp$Class_OTU2)) %>% 
  distinct() %>% 
  mutate(merge = 'merge')

grid <- rbind(mutate(grid, MouseGroup='Jax'),
      mutate(grid, MouseGroup='Env2Jax'),
      mutate(grid, MouseGroup='Env'))

grid <- left_join(grid, grid, by = c('merge', 'MouseGroup')) %>% 
  dplyr::rename('Class_OTU1'='Class_OTU1.x', 'Class_OTU2'='Class_OTU1.y') %>% 
  left_join(., temp_2, 
             # filter(interaction == 'Env-shared' | interaction == 'Jax-shared'), 
              by = c('Class_OTU1', 'Class_OTU2', 'MouseGroup')) #%>% left_join(., temp_2 %>%  filter(interaction == 'Env-shared' | interaction == 'Jax-shared'), by = 'Class_OTU2') 

temp_2 %>% filter(interaction_type == 'Negative') %>%
 distinct() %>% filter(MouseGroup != 'Env') %>%
  #filter(interaction == 'Env-shared' | interaction == 'recipient-shared') %>%
  group_by(Class_OTU1, Class_OTU2, MouseGroup) %>% mutate(sum_interactions = sum(num_interactors)) %>% select(-num_interactors) %>% distinct() %>%
   ggplot(., aes(x=Class_OTU1, y = Class_OTU2)) +
    geom_tile(data = grid, aes(x=Class_OTU1, y = Class_OTU2), color = 'black', fill = NA) +
  geom_tile(aes(fill = sum_interactions), color = 'black') +
    scale_fill_gradient(low='lightblue', high='navyblue') +
facet_grid(~factor(MouseGroup, levels = c('Jax', 'Env2Jax'))) +
  labs(fill = '# of - associations') +
  theme_cowplot() +     
  geom_text(aes(label=sum_interactions), size = 2.5, color = 'white') +
  labs(y = 'Class', x = 'Class', title = 'Interactions with Shared Taxa') +
    theme(axis.text.x = element_text(size=9,color = 'black', 
                                     angle = 45, hjust = 1), 
        axis.text.y = element_text(size=9, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=10,color = 'black'),
        legend.title = element_text(size = 12, hjust = .5,color = 'black'),
        legend.position = 'bottom',
        strip.background = element_blank())
        

ggsave("../figs/fig5/5D_ClassInteractions_neg.pdf", width = 7.5, height = 4)

temp_2 %>% filter(interaction_type == 'Positive') %>%
 distinct() %>% filter(MouseGroup != 'Env') %>%
  #filter(interaction == 'Env-shared' | interaction == 'recipient-shared') %>%
  group_by(Class_OTU1, Class_OTU2, MouseGroup) %>% 
  mutate(sum_interactions = sum(num_interactors)) %>% select(-num_interactors) %>% distinct() %>%
   ggplot(., aes(x=Class_OTU1, y = Class_OTU2)) +
    geom_tile(data = grid, aes(x=Class_OTU1, y = Class_OTU2), color = 'black', fill = NA) +
  geom_tile(aes(fill = sum_interactions), color = 'black') + 
  facet_grid(~factor(MouseGroup, levels = c('Jax', 'Env2Jax'))) +
  labs(fill = '# of + associations') +
    scale_fill_gradient(low='#FFCCCB', high='firebrick3') +
  theme_cowplot() + 
    geom_text(aes(label=sum_interactions), size = 2.5, color = 'white') +
  labs(y = 'Class', x = 'Class', title = 'Associations with Shared Taxa') +
    theme(axis.text.x = element_text(size=9,color = 'black', 
                                     angle = 45, hjust = 1), 
        axis.text.y = element_text(size=9, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=10,color = 'black'),
        legend.title = element_text(size = 12, hjust = .5,color = 'black'),
        legend.position = 'bottom',
        strip.background = element_blank())
        

ggsave("../figs/fig5/5D_ClassInteractions_pos.pdf", width =7.5, height = 4)

#make axis legend
temp_2 %>% filter(interaction_type == 'Positive') %>%
 distinct() %>% 
  #filter(interaction == 'Env-shared' | interaction == 'recipient-shared') %>%
  group_by(Class_OTU1, Class_OTU2, MouseGroup) %>% 
  mutate(sum_interactions = sum(num_interactors)) %>%
  select(-num_interactors) %>% distinct() %>%
    ggplot(.,aes(Class_OTU1, 1, fill=Class_OTU1)) +
  geom_tile(color = 'white') +
  #scale_fill_manual(values = bugColors) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10)) +
  labs(fill = "Class", x = "OTU 1") + 
  theme(axis.text = element_blank(), legend.position = 'none', axis.title = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(), axis.line = element_blank(), panel.background = element_blank()) 

ggsave("../figs/fig5/5D_ClassInteractions_labels.pdf", width = 1, height = .3)


##add Class abundance over tile plots

read.csv("../tables/MaPS-Seq_ClassCounts.csv") %>% 
  ggplot(., aes(x=Class, y = num_class)) + 
  geom_bar(color = 'black', fill = 'gray80', stat = 'identity') + 
  labs(y='# OTUs in Class', x= '') + theme_cowplot() +
  theme(axis.text.y = element_text(size=10),
        axis.text.x = element_blank(),
        axis.title = element_text(size = 12), 
        strip.background = element_blank()) + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')))

ggsave("../figs/fig5/5B.3_ClassOTUCounts.pdf", width = 6, height = 1.25)


```



Lets add bar raphs counting the total number of each species in each set
```{r}

rbind(PrevalentSets %>% select(OTU=OTU1, Class=Class_OTU1, MouseGroup) %>% distinct(),
      PrevalentSets %>% select(OTU=OTU2, Class=Class_OTU2, MouseGroup) %>% distinct()) %>% distinct() %>%
      group_by(MouseGroup, Class) %>% mutate(class_num = n()) %>% ungroup() %>% select(Class, class_num, MouseGroup) %>% 
      distinct() %>%
      ggplot(., aes(Class, class_num), fill = 'dodgerblue', color = 'gray20') + 
      geom_bar(stat='identity') + facet_wrap(~MouseGroup) + theme_cowplot() + 
      labs('# of unique OTUs') +
      theme(axis.text.x = element_text(angle = 45, hjust = 1), 
          strip.background = element_blank())
 
```

Let's average interactions between all clusters 

```{}

mean_interactions <- PrevalentSets %>% group_by(MouseGroup, OTU1, OTU2) %>% 
  filter(Significant == T) %>% 
  mutate(average_corr = mean(Zscore),
         interaction = ifelse(average_corr > 0, 'Positive', 'Negative')) %>% 
  select(OTU1, OTU2, average_corr,interaction,MouseGroup, 
         Order_OTU1, Family_OTU1, Order_OTU2, Family_OTU2, OTU1Type, OTU2Type)%>% 
  distinct %>% ungroup()

#Distribution of correlations between mouse groups

ggplot(mean_interactions, aes(MouseGroup, fill = MouseGroup, y = average_corr)) +
      geom_boxplot(outlier.shape = NA) + 
      geom_jitter(alpha = .2) + theme_cowplot()

#How do interactions change between microbes?
temp <- inner_join(
mean_interactions %>% filter(MouseGroup == 'Jax') %>% 
  select(OTU1, OTU2, average_corr_pre =average_corr) %>% mutate(pair = paste(OTU1,"_",OTU2, sep = '')),
mean_interactions %>% filter(MouseGroup == 'Env2Jax') %>% 
  select(OTU1, OTU2, average_corr_post =average_corr) %>% mutate(pair = paste(OTU1,"_",OTU2, sep = ''))) %>% mutate()

#temp[is.na(temp)] <- 0

temp %>% select(pair, average_corr_pre, average_corr_post) %>% 
  reshape2::melt() %>%
  ggplot(., aes(x=variable, y = value, group = pair)) + 
  geom_line(alpha = .2) + 
  geom_point(alpha = .2) + theme_cowplot()

filter(temp, average_corr_pre > .1 & average_corr_post < -.3)

```

#Are engrafting microbes the ones with most interactions?

```{r}
#What happens to Env microbes?
engrafted_Envs <- 
  rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == 'Env2Jax' & zpadjusted < .05 & OTU1Type != 'Recipient Taxa') %>% select(OTU1, OTU2),
    rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == 'Env2Jax' & zpadjusted < .05 & OTU2Type != 'Recipient Taxa') %>% select(OTU1=OTU2, OTU2=OTU1))) %>% distinct() %>% filter(OTU1!=OTU2)%>%
  group_by(OTU1) %>% mutate(num_interactions = n()) %>% 
  select(OTU1, num_interactions) %>% left_join(filter(otumapping, OTUType!='Recipient Taxa')%>% select(OTU1=OTU, emergence, OTUType), .) %>%
  distinct() 
engrafted_Envs$num_interactions[is.na(engrafted_Envs$num_interactions)] <- 0 


engrafted_Envs %>% ggplot(., aes(factor(emergence, levels = c('depleted', 'unchanged', 'enriched')), 
                                   num_interactions)) + 
  geom_boxplot(notchwidth = .2, outlier.shape = NA, width = .4, fill = 'white') +
  geom_jitter() + 
  #geom_jitter(aes(color = OTUType)) + 
  theme_cowplot() +
  ggsignif::geom_signif(
    comparisons = list(c('depleted', 'unchanged'), c('unchanged', 'enriched')),
    test = 'wilcox.test',
    y_position = c(8, 22)
  ) +
    ggsignif::geom_signif(
    comparisons = list(c('depleted', 'unchanged'), c('unchanged', 'enriched')),size = NA,
    map_signif_level = T,
    test = 'wilcox.test',
    
    y_position = c(9, 23)
  ) +
  labs(x = 'Env Strain FMT Outcome', y = '# of Interactions', fill =NA) + 
  theme(axis.text.x = element_text(size=16,color = 'black', angle = 45, hjust = 1), 
        axis.text.y = element_text(size=16, color = 'black'),
        axis.title.x.bottom = element_text(size = 16,color = 'black'),
        axis.title.y.left = element_text(size = 16,color = 'black'),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'none') 

ggsave("../figs/fig5/5E_FMTOutcomes.pdf", width = 3, height = 4)


engrafted_rec <- 
  rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == 'Jax' & zpadjusted < .05 & OTU1Type != 'Env Taxa') %>% select(OTU1, OTU2),
    rbind(PrevalentSets %>% #need to flip Prevalent sets so interactions go both ways correct
  filter(MouseGroup == 'Jax' & zpadjusted < .05 & OTU2Type != 'Env Taxa') %>% select(OTU1=OTU2, OTU2=OTU1))) %>% distinct() %>% filter(OTU1!=OTU2)%>%
  group_by(OTU1) %>% mutate(num_interactions = n()) %>% 
  select(OTU1, num_interactions) %>% left_join(filter(otumapping, OTUType!='Env Taxa')%>% select(OTU1=OTU, emergence, OTUType), .) %>%
  distinct()
engrafted_rec$num_interactions[is.na(engrafted_rec$num_interactions)] <- 0 


engrafted_rec %>% ggplot(., aes(factor(emergence, levels = c('depleted', 'unchanged', 'enriched')), 
                                   num_interactions, fill = emergence)) + 
  geom_boxplot(notchwidth = .2, outlier.shape = NULL, width = .4) +
  geom_jitter() + theme_cowplot() +
  ggsignif::geom_signif(
    comparisons = list(c('depleted', 'unchanged'), c('unchanged', 'enriched')),
    map_signif_level = T, 
    test = 'wilcox.test',
    y_position = c(24, 26)
  ) +
  labs(x = 'FMT Outcome', y = '# of Interactions', fill =NA) + 
  theme(axis.text.x = element_text(size=14,color = 'black'), 
        axis.text.y = element_text(size=14, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'none') 
```




==========SUPPLEMENTARY FIGURES HERE=====================


Supplement - How many OTUs per cluster & taxonomy
```{r}

PrevalentSet <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet.csv")

double_set <- rbind(
  PrevalentSets %>% 
    select(MouseGroup, Cluster, OTU1, OTU1Type, InstancesOTU1) %>% 
    distinct(),
  PrevalentSets %>% 
    select(MouseGroup, Cluster, OTU1=OTU2, OTU1Type=OTU2Type, InstancesOTU1=InstancesOTU2) %>% 
    distinct()
)

#number of OTUs colored by Origin
a <- double_set %>% select(MouseGroup, Cluster, OTU1, OTU1Type) %>% 
  distinct() %>% 
  group_by(MouseGroup,Cluster, OTU1Type) %>% mutate(num_OTU_type = n()) %>% 
  ungroup() %>%
  group_by(Cluster,MouseGroup) %>% mutate(num_OTU = n()) %>% ungroup() %>% select(-OTU1) %>% distinct()# %>% 
  ggplot(., aes(x=as.factor(Cluster), num_OTU_type, fill = OTU1Type), fill = 'dodgerblue', color = 'black') + 
  scale_fill_manual(values = c(' gray', '#37b34a', '#7e09d5', '#1b75bb')) +
  geom_bar(stat = 'identity', position = 'stack') + 
  labs(x='Cluster', y = 'No. OTUs', fill = 'OTU Origin') +
  #coord_flip() +
  theme_cowplot() +
    theme(axis.text.x = element_text(size=9,color = 'black', 
                                     angle = 45, hjust = 1), 
        axis.text.y = element_text(size=14, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'top') + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')), 
             scales = 'free_x')
  


#colored by taxonomy, stacked by abundance
b<- double_set %>% 
  select(MouseGroup,Cluster, OTU1, Order_OTU1, InstancesOTU1) %>% distinct() %>% 
  ggplot(., aes(x=as.factor(Cluster),y = InstancesOTU1,),  color = 'black') + 
  geom_bar(stat = 'identity', position = 'fill', aes(fill = Order_OTU1)) + 
  labs(x='Cluster', y = 'Proportion of Cluster', fill = 'Order') +
 # coord_flip() +
  theme_cowplot() +
    theme(axis.text.x = element_text(size=9,color = 'black', angle = 45, hjust = 1), 
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.text = element_text(size=10,color = 'black'),
        legend.title = element_text(size = 12, hjust = .5,color = 'black'),
        legend.position = 'bottom') + facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')), 
             scales = 'free_x')

plot_grid(a,b, nrow = 2)

ggsave("../figs/s5/S5A_ParticleComposition_FMT.png",  width = 10, height = 6)
ggsave("../figs/s5/S5A_ParticleComposition_FMT.pdf",  width = 10, height = 6)


```

Number of counts per clusters
```{r}

PrevalentSets %>% select(Cluster, MouseGroup) %>% 
  ggplot(.,aes(x=Cluster)) +
  geom_bar(stat = 'count', fill = 'dodgerblue', color = 'black') +
  theme_cowplot() +
  scale_x_continuous(breaks = seq(0,max(PrevalentSets$Cluster),1)) +
  theme(
    axis.text = element_text(size = 14),
    strip.background = element_blank(),
    strip.text = element_text(size = 14)) +
  labs(fill = "Order", x = "Cluster", y = '# of Particles') + 
  facet_wrap(~factor(MouseGroup, levels = c('Jax', 'Env2Jax', 'Env')), nrow = 3, scales = 'free_x', strip.position = 'right') 

ggsave(paste("../figs/s5/S5A_ClusterCounts_all.pdf",sep = ''), width = 4.5, height = 12)
ggsave(paste("../figs/s5/S5A_ClusterCounts_all.png",  sep = ''), width = 4.5, height = 12)

#Are microbes that engraft, generally the ones that have high number of interactions?


```


Look at interactions between microbes
```{r}

temp <- PrevalentSets %>% mutate(interaction = NA) %>% 
  filter(Significant == T) %>% 
  #inner_join(., engraftment, by = 'OTU1') %>%
  #select(OTU1Type, OTU2Type, Significance, Sample, Correlation, Cluster, interaction, engrafted) %>%
  select(Order_OTU1, Order_OTU2, zpadjusted, Sample, Zscore, Cluster, interaction, OTU1, OTU2) %>%
  mutate(interaction_type = ifelse(Zscore > 0, 'Positive', 'Negative')) %>%
  mutate(Order_OTU1 = ifelse(Order_OTU1 == '', 'Unknown', Order_OTU1),
         Order_OTU2 = ifelse(Order_OTU2 == '', 'Unknown', Order_OTU2)) %>%
  group_by(Order_OTU1, Order_OTU2) %>% 
  filter(., interaction_type == 'Positive') %>%
    #filter(., interaction_type == 'Negative') %>%
     mutate(num_pos = n()) %>% select(Order_OTU1, Order_OTU2, num_pos) %>% distinct()

print(paste("# positive interactions =", sum(temp$num_pos), sep = ' '))

a <- temp %>% ggplot(., aes(x = Order_OTU1, y = Order_OTU2, fill = log10(as.numeric(num_pos)))) + 
        geom_tile() + 
  theme_cowplot() + geom_text(aes(label = num_pos), color = 'white', size = 6) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_gradientn(colors = pal) + 
  labs(title = "+ Interactions", 
    fill="# of interactions", x = '', y = '')


temp <- PrevalentSets %>% mutate(interaction = NA) %>% 
  filter(Significant == T) %>% 
  #inner_join(., engraftment, by = 'OTU1') %>%
  #select(OTU1Type, OTU2Type, Significance, Sample, Correlation, Cluster, interaction, engrafted) %>%
  select(Order_OTU1, Order_OTU2, Significance, Sample, Correlation, Cluster, interaction) %>%
  mutate(interaction_type = ifelse(Correlation > 0, 'Positive', 'Negative')) %>%
  mutate(Order_OTU1 = ifelse(Order_OTU1 == '', 'Unknown', Order_OTU1),
         Order_OTU2 = ifelse(Order_OTU2 == '', 'Unknown', Order_OTU2)) %>%
  group_by(Order_OTU1, Order_OTU2) %>% 
  #filter(., interaction_type == 'Positive') %>%
    filter(., interaction_type == 'Negative') %>%
     mutate(num_pos = n()) %>% select(Order_OTU1, Order_OTU2, num_pos) %>% distinct()

print(paste("# negative interactions =", sum(temp$num_pos), sep = ' '))

b <- temp %>% ggplot(., aes(x = Order_OTU1, y = Order_OTU2, fill = log10(as.numeric(num_pos)))) + 
        geom_tile() + 
  theme_cowplot() + geom_text(aes(label = num_pos), color = 'white', size = 6) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_gradientn(colors = pal) +
  labs(title = "- Interactions", 
    fill="# of interactions", x = '', y = '')

plot_grid(a,b, nrow = 2)

ggsave("../figs/s6/s6A_Interactions.png", width = 8, height = 10)
ggsave("../figs/s6/s6A_Interactions.pdf", width = 8, height = 10)

```


How do these interaction networks work when subset by 

Do Env strains bridge interactions between envigo Envs?
```{r}

clustr <- 1
cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>% 
  filter(OTU1Type != 'Env Taxa') %>%
  filter(OTU2Type != 'Env Taxa') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% 
  distinct() %>% 
  mutate(OTU1 = as.numeric(gsub('Otu', '', .$OTU1))) %>% 
  arrange(OTU1)

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
a<-ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) + #swap colors since no negative interactions
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.2), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste("Cluster ", clustr, ': - FMT', sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
a <- a + geom_node_text(aes(label = name), size = 3,  nudge_x = a$data$x * .2, nudge_y = a$data$y * .2, check_overlap=FALSE) 


cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  filter(OTU1Type != 'Recipient Taxa') %>%
  filter(OTU2Type != 'Recipient Taxa') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% 
  distinct() %>% 
  mutate(OTU1 = as.numeric(gsub('Otu', '', .$OTU1))) %>% 
  arrange(OTU1)

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
b<-ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue',  'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.2), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste("Cluster ", clustr, ': Env', sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
b <- b + geom_node_text(aes(label = name), size = 3,  nudge_x = b$data$x * .2, nudge_y = b$data$y * .2, check_overlap=FALSE) 


cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% 
  distinct() %>% 
  mutate(OTU1 = as.numeric(gsub('Otu', '', .$OTU1))) %>% 
  arrange(OTU1)

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
c<-ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue',  'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.2), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste("Cluster ", clustr, ': + FMT', sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
c <- c + geom_node_text(aes(label = name), size = 3,  nudge_x = c$data$x * .2, nudge_y = c$data$y * .2, check_overlap=FALSE) 

leg <- cowplot::get_legend(ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Correlation), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    
temp <- cowplot::plot_grid(a,b,c, nrow = 3)
temp
ggsave("../figs/s6/s6B_InteractionNetworks.png", width = 3,height = 8)
ggsave("../figs/s6/s6B_InteractionNetworks.pdf", width = 3,height = 8)

cowplot::plot_grid(leg)
ggsave("../figs/s6/s6B_InteractionNetworks_leg.png", width = 14,height = 1.5)
ggsave("../figs/s6/s6B_InteractionNetworks_leg.pdf", width = 14,height = 1.5)
cowplot::plot_grid(temp, leg, nrow = 2)


```

What new interactions occur when + Env microbes are introduced
```{r}

clustr <- 1
cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>% 
  filter(OTU1Type != 'Env Taxa') %>%
  filter(OTU2Type != 'Env Taxa') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

minusFMT_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()

clustr <- 1
cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>% 
  filter(OTU1Type != 'Recipient Taxa') %>%
  filter(OTU2Type != 'Recipient Taxa') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

Env_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


clustr <- 1
cluster_network <- PrevalentSets %>%  
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>% 
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

postFMT_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


postFMT_edges %>% anti_join(., minusFMT_edges, by = c('OTU1', 'OTU2')) %>%
                  anti_join(., Env_edges, by = c('OTU1', 'OTU2'))


```

Let's see how much engrafting OTUs are interacting
```{r}

#Label OTUs as engrafted or not
engrafted_Envs <- read.csv("../experiments/2021-06-09_JxE_MaPS02/PrevalentSet_Env2Jax.csv") %>% 
    filter(OTU1Type == 'Env Taxa') %>%
    select(OTU1) %>% distinct() %>% mutate(engrafted = 'engrafted')


#This strategy removes OTUs that appear in engrafted OTUs but not Env particles
engraftment <- read.csv("../experiments/2021-06-09_JxE_MaPS02/PrevalentSet_Env.csv") %>% 
  filter(OTU1Type == 'Env Taxa') %>%
  select(OTU1) %>% distinct() %>% 
  left_join(., engrafted_Envs)

engraftment[is.na(engraftment)] <- 'unengrafted'


```




Does number of interactions correlate with relative abundance?
```{r}

#PrevalentSet$Order_OTU1[which(PrevalentSet$Order_OTU1 == '')] <- 'Undetermined'

temp <- PrevalentSet %>% filter(Significant == T) %>% 
            select(OTU1, Cluster,InstancesOTU1, Order_OTU1) %>% 
            group_by(Cluster, OTU1) %>% 
            mutate(num_interactions = n()) %>% ungroup() %>% distinct() %>%
            #group_by(Cluster) %>% 
            #mutate(InstancesOTU1 = InstancesOTU1/sum(InstancesOTU1)) %>% 
            ungroup() %>%
              filter(Cluster == '1') 


pval <- cor.test(temp$InstancesOTU1, temp$num_interactions, method = c("pearson"))$p.value
cor <- cor(temp$InstancesOTU1, temp$num_interactions, method = c("pearson"))

    
a <- temp %>% arrange(Cluster) %>% mutate(Cluster = as.factor(Cluster)) %>% ggplot(., aes(InstancesOTU1, num_interactions)) + 
    geom_point(aes(color = Order_OTU1)) + 
    theme_cowplot() + 
      scale_color_manual(values = bugColors) +
    ylim(0,15) +
    geom_smooth(method = 'lm') + 
    annotate("text", label = paste("r = ", 
                                    signif(cor, 3), ", p = ", signif(pval, 2),  sep = ''), 
                                x = 70, y = 10, size = 6) +
      labs(x = "OTU instances within particles", 
           y = '# of interactions in cluster', 
           color = 'Order', title = 'Cluster 1') + 
  guides(color=guide_legend(ncol=2)) +
      theme(panel.background = element_blank(),
          axis.text.x = element_text(size=12,color = 'black'), 
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        strip.text = element_text(size = 14), legend.text = element_text(size = 16))#, legend.key.size=unit(1,"cm"))

plotly::ggplotly(a)

#now for all
temp <- PrevalentSet %>% filter(Significant == T) %>% 
            select(OTU1, Cluster,InstancesOTU1, Order_OTU1) %>% 
            group_by(Cluster, OTU1) %>% 
            mutate(num_interactions = n()) %>% ungroup() %>% distinct() %>%
            #group_by(Cluster) %>% 
            #mutate(InstancesOTU1 = InstancesOTU1/sum(InstancesOTU1)) %>% 
            ungroup()

b <- temp %>% arrange(Cluster) %>% mutate(Cluster = as.factor(Cluster)) %>% ggplot(., aes(InstancesOTU1, num_interactions)) + 
    geom_point(aes(color = Order_OTU1)) + 
    theme_cowplot() + 
      ylim(0,15) +
    geom_smooth(method = 'lm') + 
    scale_fill_manual(values = bugColors) +
      labs(x = "OTU instances within particles", 
           y = '# of interactions in cluster', 
           color = 'Cluster') + facet_wrap(~Cluster) +
  theme(strip.background = element_blank(),
          axis.text.x = element_text(size=12,color = 'black'), 
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        strip.text = element_text(size = 14),
        legend.position = 'none')
  
plot_grid(a,b, nrow = 2, rel_heights = c(1,1.5))

ggsave("../figs/s7/S7_InteractionVabundance.png", width = 10, height = 12)
ggsave("../figs/s7/S7_InteractionVabundance.pdf", width = 10, height = 12)


```


Let's see if fold change is correlated with nuber of interactions
```{r}


#Let's subset to things present in at least .1% of particles

#numInteractions
temp <- PrevalentSet %>% filter(Significant == T) %>% 
            select(OTU=OTU2, Order=Order_OTU2) %>% 
            group_by(OTU) %>% 
            mutate(num_interactions = n()) %>% ungroup() %>% 
            distinct() %>% replace(is.na(.), "Undetermined")


temp <- Tax_Table %>% select(OTU, Order) %>% distinct() %>% left_join(., temp) %>% replace(is.na(.), 0) %>% mutate(interactor = ifelse(num_interactions > 1, "Interactor", "NonInteractor")) %>% 
  left_join(., (select(PrevalentSet, OTU=OTU2, OTUType = OTU2Type) %>% distinct())) %>% distinct()

#sample metadata
mock <- data.frame(Sample = c("J1","J2","J3","J4",
            "E5","E6","E7","E8",
            "JE9","JE10","JE11","JE12"),
          SampleType=c('- FMT','- FMT','- FMT','- FMT',
            'Env','Env','Env','Env',
            '+ FMT','+ FMT','+ FMT','+ FMT'))

#$$$ df
OTUfc <- CorrectedData %>% inner_join(., mock) %>% filter(Count > 1) %>%
          group_by(Particle) %>%
          mutate(total_particle_reads = sum(Count),OTU_rel_abd = Count/sum(Count))  %>% 
                                                ungroup() %>%
                                                filter(OTU_rel_abd > .001) %>% 
                                                group_by(Particle) %>% 
                                                mutate(num_OTUs_particle = n()) %>% 
                                                ungroup %>% group_by(Sample) %>% 
                                                mutate(ParticleNumberPerSample = n()) %>% ungroup() %>%
                                                filter(num_OTUs_particle > 3, 
                                                       total_particle_reads > 25) %>% #filter out to select good particles
                                  ungroup() %>% distinct() %>%
                                  select(Particle, OTU, SampleType) %>% 
                                  group_by(SampleType) %>% 
                                      mutate(particle_count = n()) %>%
                                  ungroup() %>%
                                  group_by(SampleType, OTU) %>% 
                                  mutate(OTU_hitsPerSampleType = n(),
                                   prop_OTUhitsPerSampleType = OTU_hitsPerSampleType/particle_count) %>% 
                                  select(SampleType, OTU, 
                                         OTU_hitsPerSampleType, prop_OTUhitsPerSampleType) %>% ungroup() %>%
                                  distinct() %>% mutate(EnvProp = ifelse(SampleType == 'Env',
                                                                           prop_OTUhitsPerSampleType/0.0001166045,
                                                                           .1), #scale to lowest non-zero in SampleType
                                                        noFMTProp = ifelse(SampleType == '- FMT',
                                                                           prop_OTUhitsPerSampleType/0.0007369197,
                                                                           .1), #lowest non-zero
                                                         plusFMTProp = ifelse(SampleType == '+ FMT',
                                                                           prop_OTUhitsPerSampleType/0.0002052967,
                                                                           .1)) %>% #lowest non-zero
         group_by(OTU) %>% mutate(EnvProp = max(EnvProp),
                           noFMTProp = max(noFMTProp),
                           plusFMTProp = max(plusFMTProp)) %>% select(OTU, EnvProp,noFMTProp,plusFMTProp) %>% 
         distinct() %>% ungroup() %>% 
          mutate(FC_Env2plusFMT = log2(plusFMTProp/EnvProp), #calculate fc from 
                 FC_noFMT2plusFMT = log2(plusFMTProp/noFMTProp),
                 FC_EnvDplusFMT = plusFMTProp-EnvProp, #calculate fc from 
                 FC_noFMTDplusFMT = plusFMTProp-noFMTProp) %>% 
        left_join(., temp, by = "OTU") 
           
#interacting vs non, interacting? 
OTUfc %>% #filter(OTUType == 'Env Taxa') %>% 
  ggplot(., aes(FC_noFMT2plusFMT, fill = interactor)) + 
    geom_density(alpha = .5, position = 'identity', fill = NA, aes(color = interactor)) +
    geom_histogram(bins = 10, alpha = .3, position = 'identity', aes(y=..density..)) +
    scale_fill_manual(values = c('navyblue', 'gray70')) +
      scale_color_manual(values = c('navyblue', 'gray30'), guide = 'none') +
   labs(x = '+ FMT : - FMT OTU Abundance', y = 'Density', fill = 'Interactor?') +
    theme_cowplot()
  


```

Can we assign OTUs as Env specific, recipient specific, shared?
```{r}
library(ggsignif)

temp <- CorrectedData %>% inner_join(., mock) %>% filter(Count > 1) %>%
          group_by(Particle) %>%
          mutate(total_particle_reads = sum(Count),OTU_rel_abd = Count/sum(Count))  %>% 
                                                    ungroup() %>%
                                        filter(OTU_rel_abd > .001) %>%
                                        group_by(Particle) %>% 
                                        mutate(num_OTUs_particle = n()) %>% 
                                        ungroup %>% group_by(Sample) %>% 
                                        mutate(ParticleNumberPerSample = n()) %>% ungroup() %>%
                                        filter(num_OTUs_particle > 3, 
                                               total_particle_reads > 25) %>% #filter out to select good particles
                                  ungroup() %>% 
                                  select(Particle, OTU, SampleType) %>% 
                                  group_by(SampleType) %>% 
                                      mutate(particle_count = n()) %>%
                                  ungroup() %>%
                                  group_by(SampleType, OTU) %>% 
                                  mutate(OTU_hitsPerSampleType = n(),
                                   prop_OTUhitsPerSampleType = OTU_hitsPerSampleType/particle_count) %>% 
                                  select(SampleType, OTU, 
                                         OTU_hitsPerSampleType, prop_OTUhitsPerSampleType) %>% ungroup() %>% distinct() %>% 
  filter(prop_OTUhitsPerSampleType > .01 & SampleType != '+ FMT') %>% 
  mutate(recipient_present = ifelse(SampleType == '- FMT', 1, 0),
         Env_present = ifelse(SampleType == 'Env', 1, 0)) %>%
         select(-SampleType) %>% 
         group_by(OTU) %>%
         mutate(OTUType = ifelse(sum(recipient_present > 0), 
                          ifelse(sum(Env_present > 0), 'Shared', 'Recipient Specific'), 'Env Specific')) %>% 
        select(OTU, OTUType) %>% distinct()




a <- OTUfc %>% select(-OTUType) %>% inner_join(., temp) %>% 
  filter(OTUType == 'Env Specific') %>%
  ggplot(., aes(y= plusFMTProp, x = interactor)) + 
  geom_boxplot(outlier.shape = NA, alpha = .4) +
  geom_jitter(aes(color = Order)) +
  #scale_fill_manual(values = c('navyblue', 'gray70'), guide = "none") +
  labs(x = 'OTU type', y = '+ FMT abundance', title = 'Env OTUs') + theme_cowplot() +
    scale_color_manual(values = bugColors, guide = "none") +
  geom_signif(comparisons = list(c("Interactor", "NonInteractor")), 
                         y_position = c(350),
                         map_signif_level=TRUE, #Comment out for p-values
                         test = "wilcox.test")

b <- OTUfc %>% select(-OTUType) %>% inner_join(., temp) %>% 
  filter(OTUType == 'Recipient Specific') %>%
  ggplot(., aes(y= FC_noFMTDplusFMT, x = interactor)) + 
  geom_boxplot(outlier.shape = NA, alpha = .4) +
  geom_jitter(aes(color = Order)) +
  geom_hline(yintercept = 0, linetype = 'dashed') +
  #scale_fill_manual(values = c('navyblue', 'gray70'), guide = "none") +
  labs(x = 'OTU type', y = paste("\u0394", '+ FMT abundance'), title = 'Recipient OTUs') +
  scale_color_manual(values = bugColors) +
  theme_cowplot() +
   geom_signif(comparisons = list(c("Interactor", "NonInteractor")), 
                         y_position = c(100),
                         map_signif_level=TRUE, #Comment out for p-values
                         test = "wilcox.test")

cowplot::plot_grid(a,b, ncol = 2, rel_widths = c(1,2))

```

Does envigo have more positive interactions or not?
```{r}

#PrevalentSet[PrevalentSet == 'Neither'] <- 'Shared Taxa'
#PrevalentSet[PrevalentSet == 'Envigo Specific'] <- 'Env Taxa'
#PrevalentSet[PrevalentSet == 'Jackson Specific'] <- 'Recipient Taxa'

PrevalentSet %>% select(Cluster,OTU1Type,Family_OTU1, Order_OTU1, Significant, Correlation) %>% 
      group_by(Cluster) %>% mutate(num_OTU_cluster = n(), 
                                   interaction_type = ifelse(Correlation > 0, 'Positive', 'Negative')) %>% 
      filter(Significant == TRUE, OTU1Type != '') %>% 
      ggplot(., aes(y=as.factor(Cluster), fill = interaction_type)) + 
        geom_bar(position = 'stack') + 
        facet_wrap(~OTU1Type, nrow = 1) +
        scale_fill_manual(values = c('dodgerblue', 'firebrick2')) +
        labs(x = 'Number of Interactions', y = 'Cluster', fill = 'Interaction Type') +
      theme_clean() +
      theme(axis.text.x = element_text(size=12,color = 'black'), 
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        strip.text = element_text(size = 14),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'bottom')
  

ggsave("../figs/fig5/ClusterInteractions.png",  width = 5.5, height = 4)
ggsave("../figs/fig5/ClusterInteractions.pdf",  width = 5.5, height = 4)

```

Correlations within particles - 

OTU4 & OTU6 highly correlated 

```{}

CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/2021-06-09_JxE_MaPS02/2022-01-12 Miles MaPS-seq/CorrectedDataFrame.csv")
Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/2021-06-09_JxE_MaPS02/2022-01-12 Miles MaPS-seq/Silva Tax_Table.csv")


#Change this for each group, need to run once for samples 1-3

  
fulldataset <- CorrectedData %>% group_by(Particle) %>% 
          mutate(total_particle_reads = sum(Count),OTU_rel_abd = Count/sum(Count))  %>% 
                                                ungroup() %>%
                                                filter(OTU_rel_abd > .001) %>% 
                                                group_by(Particle) %>% 
                                                mutate(num_OTUs_particle = n()) %>% 
                                                ungroup %>% group_by(Sample) %>% 
                                                mutate(ParticleNumberPerSample = n()) %>%
                                                ungroup() %>%
                                                filter(num_OTUs_particle > 2, total_particle_reads > 25) %>%
                                                ungroup() %>% 
                                                left_join(., Tax_Table) 

fulldataset <- fulldataset[!grepl("bulk",fulldataset$Particle),]
#including 4/6, 53/74, 48,82, 10/18 good, 

Otu1 <- "Otu10"
Otu2 <- "Otu18"
  
temp <- full_join(
  (fulldataset %>% filter(OTU == Otu1) %>% select(Particle, OTU1_count=Count)),
  (fulldataset %>% filter(OTU == Otu2) %>% select(Particle, OTU2_count=Count))
) 

temp[is.na(temp)] <- 0

corr <- signif(cor(temp$OTU1_count, temp$OTU2_count, method = 'pearson'), 3)
  
temp %>% ggplot(., aes(OTU1_count, OTU2_count)) + geom_point() + 
  scale_x_log10() + scale_y_log10() + 
  geom_smooth(method = 'lm') + 
  labs(x = paste(Otu1, "count", sep = ' '), y = paste(Otu2, "count", sep = ' ')) + 
  theme_cowplot() + 
  annotate(geom = 'text', label = paste("r = ", corr, sep = ''), x = 5, y = 4000)

```


Network of interactions. - V1
```{}
library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSet$Order_OTU1)))), c(levels(as.factor(PrevalentSet$Order_OTU1))))

#tbl_nodes[unique(tbl_nodes$Order_OTU1) %in% unique(PrevalentSet$Order_OTU1),]
#unique(tbl_nodes$Order_OTU1) %in% unique(PrevalentSet$Order_OTU1)


# Create data frame for edges

clustr <- 0
cluster_network <- PrevalentSet %>% 
    filter(Cluster == clustr, Significant == T)

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
a<- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Significance, edge_color = interaction), alpha =.6) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
    scale_edge_width_continuous(range = c(0,13)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(size = 10, color = 'white') +
    geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')


clustr <- 1
cluster_network <- PrevalentSet %>% 
    filter(Cluster == clustr, Significant == T)

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance) %>% 
    distinct()

#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
b <- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Significance, edge_color = interaction), alpha =.6) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
      scale_edge_width_continuous(range = c(0,13)) +
      geom_node_point(size = 14, aes(color = Order_OTU1)) +
      scale_color_manual(values = bugColors) +
    geom_node_point(size = 10, color = 'white') +
    geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

clustr <- 2
cluster_network <- PrevalentSet %>% 
    filter(Cluster == clustr, Significant == T)

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance) %>% 
    distinct()

#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
c <-ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Significance, edge_color = interaction), alpha =.6) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +  #need to reverse since no negative interactions
      scale_edge_width_continuous(range = c(0,13)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(size = 10, color = 'white') +
    geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = '')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')



leg <- cowplot::get_legend(ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Significance), alpha =.4) +
    scale_edge_width_continuous(range = c(0,12)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    
temp <- cowplot::plot_grid(a,b,c, nrow = 1)
cowplot::plot_grid(temp, leg, nrow = 2)

ggsave("../figs/fig5/5D_InteractionNetworks.png", width = 14, height = 6)
ggsave("../figs/fig5/5D_InteractionNetworks.pdf", width = 14, height = 6)

```









Taxonomic distribution of OTUs in each cluster
```{}

PrevalentSet %>% select(Cluster, Family_OTU1) %>% 
                 group_by(Cluster, Family_OTU1) %>%  #count number of each taxa type
  mutate(num_fam = n()) %>% ungroup %>%
  group_by(Cluster) 

ggplot(PrevalentSet,aes(tidytext::reorder_within(OTU1ColorName, InstancesOTU1, Cluster),y = '', fill=Order_OTU1)) +
  geom_bar(stat = 'count') +
  #scale_fill_gradient2(low="blue", high="darkred",midpoint = 0,limits=c(-1,1)) +
  theme_clean() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  upstartr::scale_x_reordered() +
  upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") #+
  #facet_wrap(~Cluster,scales="free")

```


MaPS-Seq correlation figure for all
```{}
PrevalentSet <- read.table("../experiments/2021-06-09_JxE_MaPS02/OTU Correlation by Cluster more than10 instances each otu.csv", sep = ',', header = T)

corplot_all <- #PrevalentSet %>% filter(InstancesOTU1 > 15 & InstancesOTU2 > 15) %>%
  ggplot(PrevalentSet,aes(tidytext::reorder_within(OTU1ColorName, InstancesOTU1, Cluster),
                                   tidytext::reorder_within(OTU2ColorName, InstancesOTU2, Cluster),
                                   fill=Correlation)) +
  geom_tile() +
  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0,limits=c(-.5,.5)) +
  theme_clean() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  upstartr::scale_x_reordered() +
  upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") +
  geom_point(data=function(x){x[PrevalentSet$Significant == TRUE, ]},size=.75,alpha=.7,color="black",shape=8) +
  facet_wrap(~Cluster,scales="free")

corplot_all
ggsave("../figs/fig5/MaPSSeq_Correlations.pdf",  width = 20, height = 18)
ggsave("../figs/fig5/MaPSSeq_Correlations.png",  width = 20, height = 18)

#Now get family values

corplot_fam <- ggplot(PrevalentSet,aes(tidytext::reorder_within(OTU1ColorName, InstancesOTU1, Cluster),y = '',
                                   fill=Order_OTU1)) +
  geom_tile() +
  #scale_fill_gradient2(low="blue", high="darkred",midpoint = 0,limits=c(-1,1)) +
  theme_clean() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  upstartr::scale_x_reordered() +
  upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") +
  facet_wrap(~Cluster,scales="free")

corplot_fam
ggsave("../figs/fig5/MaPSSeq_order_all.pdf",  width = 24, height = 18)


```

MaPS-Seq correlation figure for cluster 1, using hierarchical clustering
```{}
set.seed(123)

PrevalentSet.cast <- PrevalentSet %>% filter(Cluster == '1') %>%
  filter(OTU1 != 'NA') %>% 
  select(OTU1, OTU2, Correlation) %>% distinct() %>% 
  reshape2::dcast(OTU1~OTU2)

#clustering
PrevalentSet.cast.matrix <- as.matrix(PrevalentSet.cast[, -c(1)])
rownames(PrevalentSet.cast.matrix) <- PrevalentSet.cast$OTU1
PrevalentSet.cast.dendro <- as.dendrogram(hclust(d = dist(x = PrevalentSet.cast.matrix)))

##Heatmap
PrevalentSet.cast.long <- reshape2::melt(PrevalentSet.cast, id = c("OTU1")) %>% distinct()

#reorder
PrevalentSet.cast.order <- order.dendrogram(PrevalentSet.cast.dendro)

temp <- PrevalentSet.cast.long %>% select(OTU1, OTU2=variable, Correlation = 'value') %>% 
  left_join(., 
            (filter(PrevalentSet, Cluster == '1') %>% 
               select(OTU1, OTU2, Significant, Family_OTU1)), 
            by = c("OTU1", "OTU2")) #%>% mutate(OTU1=factor(OTU1, ordered = T), OTU2=factor(OTU2, ordered = T))

temp$OTU1 <- factor(x = temp$OTU1,
                               levels = PrevalentSet.cast$OTU1[PrevalentSet.cast.order], 
                               ordered = TRUE)

#PrevalentSet.cast.long$OTU1 <- factor(x = PrevalentSet.cast.long$OTU1,
#                               levels = PrevalentSet.cast$OTU1[PrevalentSet.cast.order], 
#                               ordered = TRUE)

#PrevalentSet.cast.long$OTU2 <- factor(x = PrevalentSet.cast.long$OTU2,
#                               levels = PrevalentSet.cast$OTU2[PrevalentSet.cast.order], 
#                               ordered = TRUE)

#PrevalentSet.cast.long$OTU2_fac <- factor(PrevalentSet.cast.long$OTU2, ordered = T)

#PrevalentSet.cast.long 
temp %>% ggplot(aes(x = factor(OTU1,levels = PrevalentSet.cast.long$OTU1[PrevalentSet.cast.order]), y = OTU2, fill = Correlation)) +
geom_tile() +
  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0) +#,limits=c(-.5,.5)) +
  theme_clean() +
  scale_y_discrete(limits = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast.order])) +
  scale_x_discrete(limits = rev(PrevalentSet.cast.long$OTU1[PrevalentSet.cast.order])) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  #upstartr::scale_x_reordered() +
  #upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") +
  geom_point(data=function(x){x[temp$Significant == TRUE, ]},size=.75,alpha=.7,color="black",shape=8)
  
```

Also Clusters colored by whether they're recipient ot Env
```{}
clustr <- 1
cluster_network <- PrevalentSet %>% 
  mutate(OTU1 = gsub("Otu", "", .$OTU1),
         OTU2 = gsub("Otu", "", .$OTU2)) %>%
  left_join(., data.frame(OTU1Type = c("Env Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
a<- ggraph(graph) + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue', 'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

b<- ggraph(graph) + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue', 'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
   # geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), color = tbl_nodes$Color, size = 3) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

c<- ggraph(graph) + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue', 'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
    geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$OTU1Type) +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), color = tbl_nodes$Color, size = 3) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

d<- ggraph(graph) + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue', 'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
    geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')


cowplot::plot_grid(a,b,c,d, nrow = 2, labels = 'AUTO')

```
