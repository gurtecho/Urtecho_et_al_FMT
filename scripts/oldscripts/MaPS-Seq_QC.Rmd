---
title: "MaPS-Seq_QC_assessment"
output: html_document
date: "2023-05-12"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(cowplot)
library(Seurat)

source("Null Model for Guillaume.R")


ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")
samples <- c("Post FMT", "Pre FMT", "Donor")
temp <- read.csv("../misc/bugColors_MapsSeq.csv")
bugColors<- setNames(c(scales::hue_pal()(length(unique(temp$X)))), c(levels(as.factor(temp$X)))) 


options(stringsAsFactors = F)
options(scipen = 10000)


#zotu <- read_csv("../seq/zotu.csv") 
#tax <- read_csv("../seq/tax.csv")
meta <- read_csv("../experiments/2021-12-22_JvEPolysaccharideScreen/metadata/metadata.csv")
CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/CorrectedDataFrame.csv") %>% 
  separate(Sample, into = c('Sample', 'waste'), sep = 's', remove = T) %>% 
  filter(!(Sample %in% c('J1', 'J2', 'J3', 'J4', 'E5', 'E6', 'E7', 'E8', 'JE9', 'JE10', 'JE11', 'JE12'))) %>% select(-waste)

#Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/SilvaTax.csv")
Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/tax.csv")

otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/DeSeq_OTU_dynamics.csv")

```

MaPS-Seq Particle processing
```{r}
#set <- samples[1]
  
fulldataset <- CorrectedData %>% group_by(Particle) %>% 
          mutate(total_particle_reads = sum(Count),
                 OTU_rel_abd = Count/sum(Count))  %>% 
                                                ungroup() %>%
                                                filter(OTU_rel_abd > .01) %>% 
                                                group_by(Particle) %>% 
                                                mutate(num_OTUs_particle = n()) %>% 
                                                ungroup %>% group_by(Sample) %>% 
                                                mutate(ParticleNumberPerSample = n()) %>%
                                                ungroup() %>%
                                                filter(
                                                       num_OTUs_particle > 1,
                                                       total_particle_reads > 100,
                                                       total_particle_reads < 10000
                                                ) %>%
                                                ungroup() %>% 
                                                left_join(., Tax_Table) %>% drop_na() %>%
                  semi_join(., otumapping) 


fulldataset <- fulldataset[!grepl("bulk",fulldataset$Particle),]

# fix names
fulldataset$MouseGroup <- str_extract(fulldataset$Particle,"^[:alpha:]{1,2}")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"J","Jax")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"E","Env")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"JE","Env2Jax")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"JaxEnv","Env2Jax")

unique(fulldataset$MouseGroup)

```


Redo fulldataset by selecting same number of particles
```{r}
#how many particles per sample? 20,023 total if swap min for sum here
#swapped MouseGroup for Sample Here
min_particles <- min((fulldataset %>% select(Sample, Particle) %>% 
      group_by(Sample) %>% distinct() %>% mutate(num_particles = n()) %>% ungroup %>%
      select(Sample, num_particles) %>% distinct %>% filter(num_particles > 500))$num_particles)


#Subset min_particles from each group
set.seed(123)
particle_subset <- fulldataset %>% select(Sample, Particle) %>% distinct() %>%
  group_by(Sample) %>% 
  filter(n() >= 500) %>% #remove samples with fewer than 250 particles, 
  slice_sample(n=min_particles, replace = F) %>% ungroup()

fulldataset <- semi_join(fulldataset, particle_subset, by = c('Particle', 'Sample'))


#now subset reads from those particles
#how many particles per sample?
min_reads <- min((fulldataset %>% select(Sample, Count) %>% 
      group_by(Sample) %>% mutate(num_reads = sum(Count)) %>% ungroup %>%
      select(Sample, num_reads) %>% distinct %>%
        filter(num_reads > 200000))$num_reads)


#Subset reads (3766857 each)
set.seed(123)
fulldataset <- fulldataset %>% uncount(Count) %>% group_by(Sample) %>% 
    filter(n() >= 200000) %>%
    slice_sample(n=min_reads, replace = F) %>% ungroup() %>% group_by(Sample, Particle, OTU) %>% mutate(Count = n()) %>% distinct() %>% ungroup



```

How correlated are Jax vs Env v Env2Jax
```{r}

compare <- fulldataset %>% #filter(day == 0 | day == 30) %>%
  select(OTU, MouseGroup, Count) %>% mutate(Count = ifelse(Count >0, 1,0)) %>%
  group_by(MouseGroup, OTU) %>%
  mutate(count = sum(Count)) %>% ungroup() %>% select(-Count) %>% distinct() %>%
  group_by(MouseGroup) %>%
  mutate(relabd=log10(count/sum(count))) %>% filter(relabd > -3) %>%
  ungroup %>% distinct() 


otu_compare <- data.frame(OTU = unique(compare$OTU))
for (i in 1:length(unique(compare$MouseGroup))){

  group = print(unique(compare$MouseGroup)[i])
    temp <- compare %>% filter(MouseGroup == group) %>% 
      select('OTU', 'relabd')  
    names(temp) <- c('OTU', group)
    otu_compare <- left_join(otu_compare, temp)  
  }

otu_compare <- otu_compare %>% column_to_rownames('OTU')

#pairs(otu_compare, panel = panel.smooth)

stat <- signif(cor.test(otu_compare$Env, otu_compare$Jax, method = 'spearman')$estimate, 3)[[1]]

a <- ggplot(otu_compare, aes(Env, Jax)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Jax') + theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$Env, otu_compare$Jax, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
     ylim(-3,-.5) + xlim(-3,-1)

b <- ggplot(otu_compare, aes(Env2Jax,Jax)) + 
        geom_point() + geom_smooth(method = 'lm',) + 
        labs(y = 'Jax', x = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$Env2Jax, otu_compare$Jax, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
        ylim(-3,-.5) + xlim(-3,-1)

c <- ggplot(otu_compare, aes(Env, Env2Jax)) + 
        geom_point() + geom_smooth(method = 'lm') + labs(x = 'Env', y = 'Env2Jax') +
        theme_cowplot() +
  annotate(geom = 'text', label = paste('R=',
    signif(cor.test(otu_compare$Env, otu_compare$Env2Jax, method = 'spearman')$estimate, 3)[[1]], 
    sep = ''), x = -2.5, y = -1) +
         ylim(-3,-.5) + xlim(-3,-1)




plot_grid(c,NULL, a,b, nrow = 2)

ggsave('../figs/fig5/pairwiseOTUcounts.png', width = 6, height = 6)

```


evaluate full dataset
```{r}

ggplotify::plotly(fulldataset %>% select(MouseGroup, family, Count) %>% mutate(Count = ifelse(Count >0, 1,0)) %>%
  ggplot(.,aes(x=MouseGroup, y = Count, fill = family)) + geom_bar(stat = 'identity', position = 'fill'))

#plot correlations between OTUs
b<-fulldataset %>% select(OTU, MouseGroup, Count) %>% mutate(Count = ifelse(Count >0, 1,0)) %>%
  filter(MouseGroup == 'Env') %>% 
  group_by(OTU) %>%
  mutate(env_count = sum(Count)) %>% ungroup() %>% select(-Count) %>% distinct() %>%
  full_join(., fulldataset %>% select(OTU, MouseGroup, Count) %>% mutate(Count = ifelse(Count >0, 1,0)) %>%
              filter(MouseGroup == 'Jax')  %>% group_by(OTU) %>%
  mutate(jax_count = sum(Count)) %>% ungroup() %>% select(-Count) %>% distinct(), by = 'OTU') %>% distinct() %>%
  mutate_all(~replace_na(.$env_count, 0),~replace_na(.$jax_count, 0)) %>% left_join(., Tax_Table) %>%
  ggplot(., aes(env_count, jax_count)) + geom_point(aes(color = Family), size = 3) + theme_cowplot() + scale_x_log10() + scale_y_log10() + theme(legend.position = element_blank()) 

plot_grid(a,b)
#distribution of species counts

fulldataset %>% select(MouseGroup, OTU, Count) %>% group_by(MouseGroup, OTU) %>% 
  mutate(sum_Count = sum(Count)) %>% select(-Count) %>% distinct() %>% left_join(.,Tax_Table) %>%
  ggplot(., aes(OTU,y=sum_Count, fill = Class)) + geom_bar(stat = 'identity') + 
      facet_wrap(~MouseGroup, nrow = 3, scales = 'free_y') + theme_cowplot()

```


Some quick stats...
```{r}

#how many OTUs per group?
fulldataset %>% select(MouseGroup, OTU) %>% distinct() %>% group_by(MouseGroup) %>% mutate(num_OTUs = n()) %>% ungroup %>% select(-OTU) %>% distinct 

#how about if filter for .1% abundance? Much lower for env2jax...
fulldataset %>% select(OTU, MouseGroup, Count) %>% group_by(OTU, MouseGroup) %>% 
  mutate(totalCount = sum(Count)) %>% select(-Count) %>% ungroup %>% distinct %>% 
  group_by(MouseGroup) %>%
  mutate(rel_abd = totalCount/sum(totalCount)) %>% filter(rel_abd > .001) %>% 
  mutate(num_otu = n()) %>% ungroup %>% select(MouseGroup, num_otu) %>% distinct()

#how about if filter for only OTUs that show up in .1% of particles?
fulldataset %>% select(OTU, MouseGroup) %>% group_by(OTU, MouseGroup) %>% 
  mutate(totalparticleObs = n()) %>%  ungroup %>% distinct %>% 
  group_by(MouseGroup) %>%
  mutate(rel_obs = totalparticleObs/sum(totalparticleObs)) %>% filter(rel_obs > .001) %>% 
  mutate(num_otu = n()) %>% ungroup %>% select(MouseGroup, num_otu) %>% distinct()

#num OTUs per particle
a<- fulldataset %>% select(Particle, OTU, MouseGroup) %>% distinct() %>% group_by(Particle, MouseGroup) %>% mutate(num_otus = n()) %>% ungroup %>% select(-OTU) %>% distinct() %>% 
    ggplot(., aes(num_otus, fill = MouseGroup)) + 
    geom_histogram(position = 'dodge') +
    #geom_density(alpha = .2) + 
    #scale_y_log10() + 
  theme_cowplot() + labs (y= "Density", x = "Number of OTUS per particle")
a

a_1 <-fulldataset %>% select(Particle, OTU, MouseGroup) %>% distinct() %>% group_by(Particle, MouseGroup) %>% mutate(num_otus = n()) %>% ungroup %>% select(-OTU) %>% distinct() %>% 
  ggplot(., aes(MouseGroup, num_otus)) + 
    stat_boxplot(geom = "errorbar", width = .1) + 
geom_boxplot(outlier.shape = NA) + geom_jitter(alpha = .2, size = .2) +
  ggsignif::geom_signif(
    comparisons = list(c('Env', 'Env2Jax'), 
                       c('Env2Jax', 'Jax'),
                       c('Env', 'Jax')),
    map_signif_level = T,
        y_position = c(22, 20, 24),
    test = 'wilcox.test') +
    scale_y_continuous(breaks = c(0,10,20,30))+
   theme_cowplot() + labs(x = 'Mouse Group', y = 'Number of OTUs\nper particle')

a_1

ggsave("../figs/s5/5a_OTUsperParticle.png", width = 3.5, height = 3.5)
ggsave("../figs/s5/5a_OTUsperParticle.pdf", width = 3.5, height = 3.5)

fulldataset %>% select(Particle, OTU, MouseGroup) %>% distinct() %>% group_by(Particle, MouseGroup) %>%
    mutate(num_otus = n()) %>% ungroup() %>% select(-OTU) %>% 
    distinct() %>% group_by(MouseGroup) %>% mutate(mean_otus = mean(num_otus)) %>%
    ungroup %>% select(MouseGroup,mean_otus) %>% distinct()


#num Reads per particle
b<-fulldataset %>% select(Particle, MouseGroup, total_particle_reads) %>% distinct() %>%
    #ggplot(., aes(x = MouseGroup, y = total_particle_reads)) + 
    #geom_boxplot() + geom_jitter(alpha = .1) + scale_y_log10() + theme_cowplot() + labs(y="Reads per Particle")
  ggplot(., aes(fill = MouseGroup, x = total_particle_reads)) + geom_density(alpha = .2) + scale_x_log10() + theme_cowplot() + labs(x='Reads per particle', y = 'Density')
b

plot_grid(a,b, nrow = 2, rel_heights = c(.75,1))

#how many particles per sample?
particle_counts <- inner_join(CorrectedData %>% select(Sample, Particle) %>% distinct() %>% group_by(Sample) %>% mutate(num_particles = n()) %>% select(Sample, num_particles) %>% distinct(),
          fulldataset %>% select(Sample, Particle,MouseGroup) %>% distinct() %>% group_by(Sample) %>% mutate(num_particles = n()) %>% select(Sample, num_particles,MouseGroup) %>% distinct(), by = 'Sample')


#Total particles examined
nrow(distinct(fulldataset %>% select(Particle)))

#How many reads per sample? Kind of even really
fulldataset %>% group_by(Sample) %>% mutate(total_counts = sum(Count)) %>% 
  select(Sample, total_counts) %>% distinct() %>% 
  ggplot(., aes(Sample, y = total_counts)) + geom_bar(stat = 'identity')

#How many OTUs per sample?
OTU_counts <- inner_join(CorrectedData %>% select(Sample, OTU) %>% distinct() %>% group_by(Sample) %>% mutate(num_OTUs = n()) %>% select(Sample, num_OTUs) %>% distinct(),
          fulldataset %>% select(Sample, OTU,MouseGroup) %>% distinct() %>% group_by(Sample) %>% mutate(num_OTUs = n()) %>% select(Sample, num_OTUs,MouseGroup) %>% distinct(), by = 'Sample') %>% ungroup


#It's not like there's fewer particles, JE mice have fewer OTUs 

a <- ggplot(OTU_counts, aes(MouseGroup, y = num_OTUs.x)) + geom_bar(stat = 'identity')
b <- ggplot(OTU_counts, aes(MouseGroup, y = num_OTUs.y)) + geom_bar(stat = 'identity')
plot_grid(a,b, nrow = 2)


#compare # of particles after filtering, seems pretty equal to me
a <- ggplot(particle_counts, aes(MouseGroup, y = num_particles.x)) + 
  geom_boxplot() + theme_cowplot()
b <- ggplot(particle_counts, aes(MouseGroup, y = num_particles.y)) + 
  geom_boxplot()+ theme_cowplot()
plot_grid(a,b, nrow = 2)

```


#QUICK abundance calculations
```{r}
#fulldataset %>% select(OTU, MouseGroup, Count, Class, Order, Family) %>% 
#  group_by(OTU, MouseGroup) %>% 
#  mutate(Instances_OTU = sum(Count)) %>% ungroup %>% select(-Count) %>% distinct() %>%
#  group_by(MouseGroup) %>% mutate(prop_OTU = Instances_OTU/sum(Instances_OTU)*100) %>% ungroup() %>% 
#  mutate(alpha = ifelse(prop_OTU > .5, 1, .01)) %>% distinct() %>%
#  write.csv(., "../tables/Instances_MaPS-Seq.csv", row.names = F, quote = F)


#This normalizes read counts in each sample, averages between samples for each group
OTUcounts <- fulldataset %>% select(OTU, MouseGroup, Sample, Count, Class, Order, Family) %>%
  mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
  group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% select(-Count) %>%
  group_by(OTU, MouseGroup) %>% mutate(group_Count = mean(norm_Count),
                                       Instances_OTU = sum(group_Count)) %>%
  ungroup %>% select(OTU, MouseGroup, group_Count, Instances_OTU, Class, Order, Family) %>% distinct() %>%
  group_by(MouseGroup) %>% mutate(prop_OTU = Instances_OTU/sum(Instances_OTU)*100) %>% ungroup() %>% 
  mutate(alpha = ifelse(prop_OTU > .5, 1, .01)) 

write.csv(OTUcounts, "../tables/Instances_MaPS-Seq.csv", row.names = F, quote = F)

OTUcounts %>% select(OTU, MouseGroup) %>% group_by(MouseGroup) %>% distinct() %>% mutate(num_OTUs = n()) %>% select(-OTU) %>% distinct()


OTUcounts %>% filter(prop_OTU > .7) %>% select(OTU, MouseGroup) %>% 
          group_by(MouseGroup) %>% distinct() %>% mutate(num_OTUs = n()) %>% 
        select(-OTU) %>% distinct()

#plot correlations between OTUs
OTUcounts %>% select(OTU, MouseGroup, env_count=group_Count) %>% filter(MouseGroup == 'Env') %>% 
  full_join(., OTUcounts %>% select(OTU, MouseGroup, jax_count=group_Count) %>% 
              filter(MouseGroup == 'Env2Jax'), by = 'OTU') %>% 
  mutate_all(~replace_na(.$env_count, 0),~replace_na(.$jax_count, 0)) %>% 
  ggplot(., aes(env_count, jax_count)) + geom_point() + theme_cowplot() + scale_x_log10() + scale_y_log10()


#plot abundance of species
fulldataset %>% select(OTU, MouseGroup, Count) %>% left_join(., Tax_Table) %>% 
  ggplot(.,aes(x=MouseGroup, y = Count, fill = Class)) + geom_bar(stat = 'identity', position = 'fill')

# Create a data frame with the OTUs for each MouseGroup

# Use group_by and summarize to find the shared OTUs
temp <- OTUcounts %>% select(OTU, MouseGroup)
df_shared <-  temp %>%
  group_by(OTU) %>%
  summarize(n_shared = n_distinct(MouseGroup)) %>%
  filter(n_shared > 1)

# Print the results
cat(paste("Shared OTUs between Env and Jax:", intersect(temp$OTU[temp$MouseGroup == "Env"], temp$OTU[temp$MouseGroup == "Jax"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "Env"],temp$OTU[temp$MouseGroup == "Jax"])

cat(paste("Shared OTUs between Env and Env2Jax:", intersect(temp$OTU[temp$MouseGroup == "Env"],temp$OTU[temp$MouseGroup == "Env2Jax"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "Env"],temp$OTU[temp$MouseGroup == "Env2Jax"])

cat(paste("Shared OTUs between Jax and Env2Jax:", intersect(temp$OTU[temp$MouseGroup == "Jax"],temp$OTU[temp$MouseGroup == "Env2Jax"]), "\n"))
intersect(temp$OTU[temp$MouseGroup == "Jax"],temp$OTU[temp$MouseGroup == "Env2Jax"])


```

How many species per MouseGroup?
```{r}


read.csv("../tables/Instances_MaPS-Seq.csv") %>% #filter(prop_OTU > .1) %>%
  select(OTU, Class, MouseGroup) %>% distinct() %>% 
  group_by(MouseGroup, Class) %>% mutate(num_class = n()) %>% 
  select(-OTU) %>% distinct() %>% 
  write.csv("../tables/MaPS-Seq_ClassCounts.csv", quote = F, row.names = F)

```


Let's look at aggregate measurements for unfiltered data?
```{r}
  
temp <- CorrectedData %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
   #summarise(unique_count = n_distinct(Particle))
# group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, OTU_count) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% filter(log10_prev > -3) %>%
  ungroup %>% select(OTU, Sample, log10_prev) %>% distinct()  

#temp %>% ggplot(., aes(Sample, OTU, fill = log10_prev)) + geom_tile()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~Sample)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) #add fam data

vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
                         levels = c("Jax","Env", "Env2Jax"))

# Heatmap
heatmap.plot <- vendor.long %>% #filter(class == 'Bacteroidia') %>% 
  ggplot(., aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse', fill ='Relative Abundance',
       y = "OTU") +
 # facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/bulk_prevalence_MaPS-Seq.pdf",  width = 9, height = 5)

```



Let's look at bulk measurements? Don't exist... Have to do heat map.
```{r}
  
temp <- fulldataset %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
  filter(Sample != 'J4r2' & Sample != 'E5r2') %>%
    filter(Sample != 'E8r1' & Sample != 'E8r2') %>%
   #summarise(unique_count = n_distinct(Particle))
# group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, MouseGroup, OTU_count,Class, Order, Family) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% filter(log10_prev > -3) %>%
  ungroup %>% select(OTU, Sample,MouseGroup, log10_prev) %>% distinct()  

#temp %>% ggplot(., aes(Sample, OTU, fill = log10_prev)) + geom_tile()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~Sample)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) %>% #add family data
    left_join(., (select(temp, Sample, MouseGroup) %>% distinct()), by = c('variable'='Sample')) #add vendor data
vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
                         levels = c("Jax","Env", "Env2Jax"))

# Heatmap
heatmap.plot <- ggplot(data = vendor.long, aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse', fill ='Relative Abundance',
       y = "OTU") +
  facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = Class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/bulk_prevalence_MaPS-Seq.pdf",  width = 9, height = 5)

```



Just Jax and Env heat map?
Let's look at bulk measurements? Don't exist... Have to do heat map.
```{r}
  
temp <- fulldataset %>% #mutate(Count = ifelse(Count >0, 1,0)) %>% #Binarize counts here
   #summarise(unique_count = n_distinct(Particle))
# group_by(Sample) %>% mutate(norm_Count = Count/sum(Count)) %>% ungroup() %>% 
  #filter(MouseGroup != 'Env2Jax') %>%
  #select(-Count) %>%
  group_by(OTU, Sample) %>% mutate(OTU_count = sum(Count)) %>% ungroup() %>% 
  select(OTU, Sample, MouseGroup, OTU_count,Class, Order, Family) %>% distinct() %>% 
  group_by(Sample) %>% 
  mutate(log10_prev = log10(OTU_count/sum(OTU_count))) %>% 
  ungroup %>% select(OTU, Sample,MouseGroup, log10_prev) %>%
  distinct() %>% group_by(OTU, MouseGroup) %>% mutate(median_prev = mean(log10_prev)) %>% ungroup %>%
  select(MouseGroup, OTU, median_prev) %>% distinct()

temp %>% filter(log10_prev > -2) %>% select(OTU) %>% distinct()


library('ggdendro')
library('grid')

set.seed(123)


vendor.scaled <- reshape2::dcast(temp, OTU~MouseGroup)
vendor.scaled[is.na(vendor.scaled)] <- -5

#clustering
vendor.matrix <- as.matrix(vendor.scaled[, -c(1)])
rownames(vendor.matrix) <- vendor.scaled$OTU
vendor.dendro <- as.dendrogram(hclust(d = dist(x = vendor.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = vendor.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


##Heatmap
vendor.long <- reshape2::melt(vendor.scaled, id = c("OTU"))
vendor.order <- order.dendrogram(vendor.dendro) #reorder
vendor.long <- left_join(vendor.long, Tax_Table) %>% #add family data
    left_join(., (select(temp, MouseGroup) %>% distinct()), by = c('variable'='MouseGroup')) #add vendor data
vendor.long$OTU <- factor(x = vendor.long$OTU,
                               levels = vendor.scaled$OTU[vendor.order], 
                               ordered = TRUE)

#order vendors for plot
#vendor.long$MouseGroup <- factor(vendor.long$MouseGroup,      # Reordering group factor levels
#                         levels = c("Jax","Env", "Env2Jax"))

# Heatmap
heatmap.plot <- ggplot(data = vendor.long, aes(x = variable, y = OTU)) +
  geom_tile(aes(fill = value), color = 'white') +
  scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = -2.5) +
  #scale_fill_gradientn(colours = pal) + 
  labs(x='Mouse (N = 10 / Vendor)', fill ='Relative Abundance',
       y = "OTU") +
 # facet_wrap(~MouseGroup, scales = 'free_x', ncol = 4) +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
            #  axis.text.y = element_blank(), 
             # axis.text.x = element_blank(),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
        legend.position = 'bottom',
        strip.background = element_blank()) 

fam <- ggplot(data = vendor.long, aes(x = '', y = OTU)) + 
    geom_tile(aes(fill = Class), color = 'white') +
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.2))
#ggsave("../figs/fig1/Vendor16S.png",  width = 5, height = 5)
ggsave("../figs/fig5/old_fig5/SampleHeatmaps.svg",  width = 5, height = 5)

```

