---
title: "fig5_PolysaccharideMuribac"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(cowplot)
source("CompteSpearmanCorrelationAndMelt.R")


ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")
samples <- c("Post FMT", "Pre FMT", "Donor")

options(stringsAsFactors = F)
options(scipen = 10000)

#zotu <- read_csv("../seq/zotu.csv") 
#tax <- read_csv("../seq/tax.csv")
meta <- read_csv("../experiments/2021-12-22_JvEPolysaccharideScreen/metadata/metadata.csv")
CorrectedData <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/CorrectedDataFrame.csv") %>% 
  separate(Sample, into = c('Sample', 'waste'), sep = 's', remove = T) %>% 
  filter(!(Sample %in% c('J1', 'J2', 'J3', 'J4', 'E5', 'E6', 'E7', 'E8', 'JE9', 'JE10', 'JE11', 'JE12'))) %>% select(-waste)

Tax_Table <- data.table::fread("~/Dropbox/fmt/experiments/2022-09-13 Guillaume FMT r3/SilvaTax.csv")
otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/DeSeq_OTU_dynamics.csv")

```

MaPS-Seq Particle processing
```{r}
#set <- samples[1]
  
fulldataset <- CorrectedData %>% group_by(Particle) %>% 
          mutate(total_particle_reads = sum(Count),OTU_rel_abd = Count/sum(Count))  %>% 
                                                ungroup() %>%
                                                filter(OTU_rel_abd > .01) %>% 
                                                group_by(Particle) %>% 
                                                mutate(num_OTUs_particle = n()) %>% 
                                                ungroup %>% group_by(Sample) %>% 
                                                mutate(ParticleNumberPerSample = n()) %>%
                                                ungroup() %>%
                                                filter(num_OTUs_particle > 2,
                                                       total_particle_reads > 50) %>%
                                                ungroup() %>% 
                                                left_join(., Tax_Table) %>% na.omit %>% 
                  semi_join(., otumapping)

fulldataset <- fulldataset[!grepl("bulk",fulldataset$Particle),]

# fix names
fulldataset$MouseGroup <- str_extract(fulldataset$Particle,"^[:alpha:]{1,2}")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"JE","Post FMT")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"J","Pre FMT")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"E","Donor")

#filter for different
#fulldataset <- fulldataset %>% filter(MouseGroup == set)

unique(fulldataset$MouseGroup)
```

Identify OTUs abundance per sample type

NOW USE DESEQ_MAPS-SEQ
```{}
set <- c('Donor', 'Pre FMT', 'Post FMT')

for (i in 1:length(set)) {
     print(set[i])
   group <- set[i]
   
temp <- filter(fulldataset, MouseGroup == group) %>% group_by(Sample) %>% 
     mutate(Count = (Count/sum(Count)), sample_Count = sum(Count)) %>% #normalize reads per Sample
     ungroup() %>% 
     group_by(Sample, OTU) %>% mutate(rel_abd = sum(Count)/sample_Count) %>% ungroup %>%
    select(Sample, OTU, MouseGroup, rel_abd) %>% distinct() %>% group_by(OTU, MouseGroup) %>% 
    mutate(group_rel_abd = mean(rel_abd)) %>% ungroup() %>% filter(group_rel_abd > .005) %>% 
    select(-rel_abd, -Sample) %>% distinct() %>% select(OTU) %>% mutate(present = 'y')


assign(group, temp)

}

otumapping <- full_join(Donor, `Pre FMT`, by = 'OTU') %>% 
        mutate(present.x = replace_na(present.x, 'n'),
        present.y = replace_na(present.y, 'n')) %>% 
  mutate(OTUType = ifelse(present.x =='y' & present.y == 'n', 'Donor Taxa', 
                   ifelse(present.y =='y' & present.x == 'n', 'Recipient Taxa', 'Shared Taxa'))) %>% 
                          select(OTU, OTUType) %>% 
  mutate(OTUcolor = ifelse(OTUType == 'Donor Taxa', 
                        paste("<b style='color:#377EB8'>", OTU, sep =''), #env specific
                    ifelse(OTUType == 'Recipient Taxa', 
                        paste("<b style='color:#E41A1C'>", OTU, sep =''), #jax specific
                        paste("<b style='color:#828382'>", OTU, sep ='')))) #shared

anti_join(`Post FMT`, otumapping) %>% select(OTU) %>% mutate(OTUType = 'Post Taxa',
                                                             OTUcolor = paste("<b ")) 

write.csv(otumapping, "../experiments/2022-09-13 Guillaume FMT r3/otumapping.csv", quote = F, row.names = F)

```

Fig 5A - MaPS-Seq Clustering
```{r}

library(Seurat)

set.seed(1337)

#Create metadata
METADATA <- as.matrix(select(fulldataset, Particle,Sample,MouseGroup,total_particle_reads,num_OTUs_particle))
row.names(METADATA) <- fulldataset$Particle
METADATA <- as.data.frame(METADATA) %>% distinct()

#add phylogenetic counts per cluster

#Lactobacillaceae

lacto <- fulldataset %>% filter(Family == 'Lactobacillaceae') %>%
         group_by(Particle) %>%
         mutate(Lactobacillaceae=log10(sum(Count))) %>%
         select(Particle, Lactobacillaceae)%>% distinct() #lactobacillaceae

lachno <- fulldataset %>% filter(Family == 'Lachnospiraceae') %>%
  group_by(Particle) %>%
  mutate(Lachnospiraceae=log10(sum(Count))) %>%
  select(Particle, Lachnospiraceae) %>% distinct()  #Lachnospiraceae

Muribac <- fulldataset %>% filter(Family == 'Muribaculaceae') %>% 
  group_by(Particle) %>%
  mutate(Muribaculaceae=log10(sum(Count))) %>%
  select(Particle, Muribaculaceae) %>% distinct() #Muribaculaceae

bacter <- fulldataset %>% filter(Family == 'Bacteroidaceae') %>%
  group_by(Particle) %>%
  mutate(Bacteroidaceae=log10(sum(Count))) %>%
  select(Particle, Bacteroidaceae)%>% distinct() #Bacteroidaceae

erys <- fulldataset %>% filter(Family == 'Erysipelotrichaceae') %>% 
  group_by(Particle) %>%
  mutate(Erysipelotrichaceae=log10(sum(Count))) %>%
  select(Particle, Erysipelotrichaceae) %>% distinct() #Erysipelotrichaceae

temp <- full_join(lacto, lachno) %>% full_join(., Muribac) %>% full_join(., erys) %>% full_join(., bacter) %>% replace(is.na(.), 0) %>% distinct()

METADATA<- left_join(METADATA, temp) %>% replace(is.na(.), 0)
row.names(METADATA) <- METADATA$Particle



# make the dataframe for seurat
casted <- fulldataset %>% select(Particle, OTU, Count) %>% 
  reshape2::dcast(Particle~OTU) %>% 
  mutate_all(~replace(., is.na(.), 0))

castmat <- as.matrix(casted[,2:ncol(casted)])
row.names(castmat) <- casted$Particle

# load into seurat
pbmc <- CreateSeuratObject(counts = t(castmat), 
                           project = "maps", 
                           min.cells = 3, 
                           min.features = 2,
                           meta.data = METADATA)

# normalize data with log + 10000
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)
#pbmc@assays$RNA@counts@

# look at variable features
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# scale the data and run PCA
all.particles <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.particles)
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))

# compute clusters and neighbors
pbmc <- FindNeighbors(pbmc, dims = 1:15)
pbmc <- FindClusters(pbmc, resolution = 0.5)

# actually run umap
pbmc <- RunUMAP(pbmc, dims = 1:15)


#PLOT

Plot1 <- DimPlot(pbmc, reduction = "umap") +
  ggtitle("Cluster")

a<- FeaturePlot(object = pbmc, features = "Lactobacillaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

b<- FeaturePlot(object = pbmc, features = "Bacteroidaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

c<- FeaturePlot(object = pbmc, features = "Lachnospiraceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

d<- FeaturePlot(object = pbmc, features = "Erysipelotrichaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())
                                                                                

#Plot figures 5a here
fxf <- plot_grid(a,b,c,d, ncol = 2)
fxf
ggsave(paste("../figs/fig5/Family_UMAP_labels.pdf", sep = ''), width = 5, height = 4)
#save projection 
Plot1
ggsave(paste("../figs/fig5/Cluster_UMAP.pdf", sep = ''), width = 4.5, height = 3.5)

plot_grid(Plot1, fxf, nrow = 1)
ggsave(paste("../figs/fig5/5a_UMAPs_labels.pdf", sep = ''), width = 9, height = 4)

#Plot supplementary fig while we here
Plot1 <- DimPlot(pbmc, reduction = "umap") +
  ggtitle("Cluster")
Plot2 <- DimPlot(pbmc, reduction = "umap",
                 group.by='MouseGroup')
Plot2.1 <- DimPlot(pbmc, reduction = "umap",
                   group.by='Sample')

Plot3 <- Plot1 + Plot2 + Plot2.1

ggsave("../figs/fig5/Side by Side UMAP balanced_10_20.pdf",Plot3,width=19,height=5)
ggsave("../figs/fig5/Side by Side UMAP balanced_10_20.png",Plot3,width=19,height=5)

```

```{r}
# extract the cluster identities
seuratnorm <- t(as.matrix(pbmc@assays$RNA@data))

clusteres <- data.table(pbmc@meta.data)
clusteres$Sample <- factor(clusteres$Sample)

plotframe <- clusteres[,.(NumberParticles=length(unique(Particle))),by=.(Sample,seurat_clusters,MouseGroup)] 


names(plotframe)[2] <- c("Cluster")

plotframe[, TotalParticleCluster:=sum(NumberParticles) , by=.(Cluster)]
plotframe$ClusterProportion <- plotframe$NumberParticles/plotframe$TotalParticleCluster

# calculate stats by mouse group
plotframe[,ParticlesMouseGroupCluster:=sum(NumberParticles),by=.(Cluster,MouseGroup)]
plotframe$ClusterProportionMouseGroup <- plotframe$ParticlesMouseGroupCluster/plotframe$TotalParticleCluster

# add necessary data and calculate some more things

plotframe <- merge(plotframe,distinct(select(fulldataset, Sample, ParticleNumberPerSample)),by="Sample") %>%
    filter(TotalParticleCluster > 100)

plotframe$ParticleNumberPerSample <- as.numeric(plotframe$ParticleNumberPerSample)
plotframe$SampleProportion <- plotframe$NumberParticles/plotframe$ParticleNumberPerSample

# kruskal test for each cluster (to get significance)
Kruskals <- NA
for(i in unique(plotframe$Cluster)){
  testframe <- plotframe[Cluster==i]
  res <- kruskal.test(list(testframe$ClusterProportion,testframe$SampleProportion))
  Kruskals <- rbind(Kruskals,cbind(rbind(res),i))
}
Kruskals <- data.table(Kruskals)
Kruskals2 <- data.table(cbind(unlist(Kruskals$p.value),unlist(Kruskals$statistic),unlist(Kruskals$i)))
names(Kruskals2) <- c("pvalue","statistic","Cluster")
Kruskals2 <- Kruskals2[-1,]
Kruskals2$AdjustedP <- p.adjust(Kruskals2$pvalue,"fdr")


# subset associations

# get particle clustering identity and subset
ComparisonClusters <- merge(fulldataset,clusteres[,.(Particle, seurat_clusters)],by="Particle") #%>% 
    #group_by(seurat_clusters, OTU) %>% mutate(cluster_rel_abd = mean(OTU_rel_abd)) %>% 
    #filter(cluster_rel_abd > .1) %>% ungroup()

#allocate blank data
AllSpearRes <- data.table(NA)

# calculate the association for each subset
for(i in unique(ComparisonClusters$seurat_clusters)){
  pal <- i
  print(pal)
  
  # subset by cluster, cast to otu table
  #ClusterSub <- ComparisonClusters[ComparisonClusters$seurat_clusters == pal]
  ClusterSub <- filter(ComparisonClusters, seurat_clusters == pal)
  ClusterCast <- reshape2::dcast(ClusterSub,Particle~OTU,value.var = "Count")
  setnafill(ClusterCast,fill=0, cols=2:ncol(ClusterCast))
  
  # get otu table for computation
  ClusterCastMat <- (scale(as.matrix(ClusterCast[,2:ncol(ClusterCast)])))
  #ClusterCastMat[is.na(ClusterCastMat)] <- -3 #pseudocount 
  row.names(ClusterCastMat) <- ClusterCast$Particle
  
  # calculate the associations
  SpearRes <- data.table(Compute_Spearman_Correlation_And_Melt(ClusterCastMat,i,NA))
  
  # add important metadata
  SpearRes$Cluster <- pal 
  
  # calculate prevalence of each otu in the cluster
  OTUFrame <- ClusterSub %>% filter(Count > 1) %>% group_by(OTU) %>% mutate(InstancesOTU = n())
#  OTUFrame <- ClusterSub[,.(InstancesOTU=length(Count > 1)) ,by=.(OTU)]
  OTUFrame$ParticlesInCluster <- sum(OTUFrame$InstancesOTU)
  OTUFrame$ProportionOfInstancesPerCluster <- OTUFrame$InstancesOTU/OTUFrame$ParticlesInCluster
  
  # add it to the spearman results
  SpearRes$InstancesOTU1 <- OTUFrame$InstancesOTU[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$InstancesOTU2 <- OTUFrame$InstancesOTU[match(SpearRes$OTU2,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU1 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU2 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU2,OTUFrame$OTU)]
  
  AllSpearRes <- rbind(AllSpearRes,SpearRes,fill=T)
}

# clean up result
AllSpearRes$V1 <- NULL
AllSpearRes <- AllSpearRes[complete.cases(AllSpearRes)]

```

PrevalentSet Processing
```{r}
#look at OTUs with sufficient prevalence
PrevalentSet <- AllSpearRes[InstancesOTU1 > 10 & InstancesOTU2 > 10]

# add significance
PrevalentSet$Significant <- PrevalentSet$SpearmanAdjustedP < .05

# order the plot
PrevalentSet$Cluster <- factor(PrevalentSet$Cluster,levels=0:max(as.numeric(PrevalentSet$Cluster)))

#subset, and rename to differentiate

#OTU1Frame <- unique(fulldataset[,.(OTU,Phylum,Class,Order,Family)])
OTU1Frame <- distinct(select(fulldataset, OTU,Phylum,Class,Order,Family))
names(OTU1Frame)[1] <- "OTU1"
names(OTU1Frame)[2:ncol(OTU1Frame)] <- paste(names(OTU1Frame)[2:ncol(OTU1Frame)],"OTU1",sep="_")

OTU2Frame <- distinct(select(fulldataset, OTU,Phylum,Class,Order,Family))
names(OTU2Frame)[1] <- "OTU2"
names(OTU2Frame)[2:ncol(OTU2Frame)] <- paste(names(OTU2Frame)[2:ncol(OTU2Frame)],"OTU2",sep="_")

# add the order to the otu names
OTU1Frame$OTU1WithOrder <- paste(OTU1Frame$OTU1,OTU1Frame$Order_OTU1,sep="_")
OTU2Frame$OTU2WithOrder <- paste(OTU2Frame$OTU2,OTU2Frame$Order_OTU2,sep="_")

# merge them
PrevalentSet <- merge(PrevalentSet,OTU1Frame,by="OTU1")
PrevalentSet <- merge(PrevalentSet,OTU2Frame,by="OTU2")

# add color for plotting

#otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/otumapping.csv") 

#OTU type was determined from Analysis.R file
PrevalentSet$OTU1ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU2,otumapping$OTU)]
PrevalentSet$OTU1Type <- otumapping$OTUType[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2Type <- otumapping$OTUType[match(PrevalentSet$OTU2,otumapping$OTU)]
PrevalentSet$OTU1emergence <- otumapping$emergence[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2emergence <- otumapping$emergence[match(PrevalentSet$OTU2,otumapping$OTU)]

PrevalentSet <- PrevalentSet[!is.na(PrevalentSet$OTU1Type),]
PrevalentSet <- PrevalentSet[!is.na(PrevalentSet$OTU2Type),]

PrevalentSet %>% 
      write.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet.csv", quote = F, row.names = F)
plotframe %>% na.omit() %>% 
    write.csv("../experiments/2022-09-13 Guillaume FMT r3/plotframe.csv", quote = F, row.names = F)

```




Write out Prevalent sets 
```{ END OF PROCESSING}

write.csv(PrevalentSet, paste("../experiments/2021-06-09_JxE_MaPS02/PrevalentSet_", set, ".csv", sep = ''))

```



Now let's generate associations for each sample group


Fig 5A - MaPS-Seq Clustering
```{r}
samples <- c("Post FMT","Donor", 'Pre FMT')
#FOR SOME REASon, pre FMT stops after generating associations, just keep running last few lines

for (i in 1:length(samples)) {
  
  print(samples[i])
  
    set <- samples[i]
    subdataset <- filter(fulldataset, MouseGroup == set)

    set.seed(1337)

#Create metadata
METADATA <- as.matrix(select(subdataset, Particle,Sample,MouseGroup,total_particle_reads,num_OTUs_particle))
row.names(METADATA) <- subdataset$Particle
METADATA <- as.data.frame(METADATA) %>% distinct()

#add phylogenetic counts per cluster

#Lactobacillaceae

lacto <- subdataset %>% filter(Family == 'Lactobacillaceae') %>%
         group_by(Particle) %>%
         mutate(Lactobacillaceae=log10(sum(Count))) %>%
         select(Particle, Lactobacillaceae)%>% distinct() #lactobacillaceae

lachno <- subdataset %>% filter(Family == 'Lachnospiraceae') %>%
  group_by(Particle) %>%
  mutate(Lachnospiraceae=log10(sum(Count))) %>%
  select(Particle, Lachnospiraceae) %>% distinct()  #Lachnospiraceae

Muribac <- subdataset %>% filter(Family == 'Muribaculaceae') %>% 
  group_by(Particle) %>%
  mutate(Muribaculaceae=log10(sum(Count))) %>%
  select(Particle, Muribaculaceae) %>% distinct() #Muribaculaceae

bacter <- subdataset %>% filter(Family == 'Bacteroidaceae') %>%
  group_by(Particle) %>%
  mutate(Bacteroidaceae=log10(sum(Count))) %>%
  select(Particle, Bacteroidaceae)%>% distinct() #Bacteroidaceae

erys <- subdataset %>% filter(Family == 'Erysipelotrichaceae') %>% 
  group_by(Particle) %>%
  mutate(Erysipelotrichaceae=log10(sum(Count))) %>%
  select(Particle, Erysipelotrichaceae) %>% distinct() #Erysipelotrichaceae

temp <- full_join(lacto, lachno) %>% full_join(., Muribac) %>% full_join(., erys) %>% full_join(., bacter) %>% replace(is.na(.), 0) %>% distinct()

METADATA<- left_join(METADATA, temp) %>% replace(is.na(.), 0)
row.names(METADATA) <- METADATA$Particle



# make the dataframe for seurat
casted <- subdataset %>% select(Particle, OTU, Count) %>% 
  reshape2::dcast(Particle~OTU) %>% 
  mutate_all(~replace(., is.na(.), 0))

castmat <- as.matrix(casted[,2:ncol(casted)])
row.names(castmat) <- casted$Particle

# load into seurat
pbmc <- CreateSeuratObject(counts = t(castmat), 
                           project = "maps", 
                           min.cells = 3, 
                           min.features = 2,
                           meta.data = METADATA)

# normalize data with log + 10000
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)
#pbmc@assays$RNA@counts@

# look at variable features
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# scale the data and run PCA
all.particles <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.particles)
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))

# compute clusters and neighbors
pbmc <- FindNeighbors(pbmc, dims = 1:15)
pbmc <- FindClusters(pbmc, resolution = 0.5)

# actually run umap
pbmc <- RunUMAP(pbmc, dims = 1:15)


#PLOT

Plot1 <- DimPlot(pbmc, reduction = "umap") +
  ggtitle("Cluster")

a<- FeaturePlot(object = pbmc, features = "Lactobacillaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

b<- FeaturePlot(object = pbmc, features = "Bacteroidaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

c<- FeaturePlot(object = pbmc, features = "Lachnospiraceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

d<- FeaturePlot(object = pbmc, features = "Erysipelotrichaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())
                                                                                

#Plot figures 5a here
fxf <- plot_grid(a,b,c,d, ncol = 2)
fxf
ggsave(paste("../figs/fig5/", set, "/Family_UMAP_labels.pdf", sep = ''), width = 5, height = 4)
#save projection 
Plot1
ggsave(paste("../figs/fig5/", set, "/Cluster_UMAP.pdf", sep = ''), width = 4.5, height = 3.5)

plot_grid(Plot1, fxf, nrow = 1)
ggsave(paste("../figs/fig5/", set, "/5a_UMAPs_labels.pdf", sep = ''), width = 9, height = 4)

# extract the cluster identities
seuratnorm <- t(as.matrix(pbmc@assays$RNA@data))

clusteres <- data.table(pbmc@meta.data)
clusteres$Sample <- factor(clusteres$Sample)

plotframe <- clusteres[,.(NumberParticles=length(unique(Particle))),by=.(Sample,seurat_clusters,MouseGroup)] 


names(plotframe)[2] <- c("Cluster")

plotframe[, TotalParticleCluster:=sum(NumberParticles) , by=.(Cluster)]
plotframe$ClusterProportion <- plotframe$NumberParticles/plotframe$TotalParticleCluster

# calculate stats by mouse group
plotframe[,ParticlesMouseGroupCluster:=sum(NumberParticles),by=.(Cluster,MouseGroup)]
plotframe$ClusterProportionMouseGroup <- plotframe$ParticlesMouseGroupCluster/plotframe$TotalParticleCluster

# add necessary data and calculate some more things

plotframe <- merge(plotframe,distinct(select(subdataset, Sample, ParticleNumberPerSample)),by="Sample") %>%
    filter(TotalParticleCluster > 100)

plotframe$ParticleNumberPerSample <- as.numeric(plotframe$ParticleNumberPerSample)
plotframe$SampleProportion <- plotframe$NumberParticles/plotframe$ParticleNumberPerSample

# kruskal test for each cluster (to get significance)
Kruskals <- NA
for(i in unique(plotframe$Cluster)){
  testframe <- plotframe[Cluster==i]
  res <- kruskal.test(list(testframe$ClusterProportion,testframe$SampleProportion))
  Kruskals <- rbind(Kruskals,cbind(rbind(res),i))
}
Kruskals <- data.table(Kruskals)
Kruskals2 <- data.table(cbind(unlist(Kruskals$p.value),unlist(Kruskals$statistic),unlist(Kruskals$i)))
names(Kruskals2) <- c("pvalue","statistic","Cluster")
Kruskals2 <- Kruskals2[-1,]
Kruskals2$AdjustedP <- p.adjust(Kruskals2$pvalue,"fdr")


# subset associations

# get particle clustering identity and subset
ComparisonClusters <- merge(subdataset,clusteres[,.(Particle, seurat_clusters)],by="Particle") #%>% 
    #group_by(seurat_clusters, OTU) %>% mutate(cluster_rel_abd = mean(OTU_rel_abd)) %>% 
    #filter(cluster_rel_abd > .1) %>% ungroup()

#allocate blank data
AllSpearRes <- data.table(NA)

# calculate the association for each subset
for(i in unique(ComparisonClusters$seurat_clusters)){
  pal <- i
  print(pal)
  
  # subset by cluster, cast to otu table
  #ClusterSub <- ComparisonClusters[ComparisonClusters$seurat_clusters == pal]
  ClusterSub <- filter(ComparisonClusters, seurat_clusters == pal)
  ClusterCast <- reshape2::dcast(ClusterSub,Particle~OTU,value.var = "Count")
  setnafill(ClusterCast,fill=0, cols=2:ncol(ClusterCast))
  
  # get otu table for computation
  ClusterCastMat <- (scale(as.matrix(ClusterCast[,2:ncol(ClusterCast)])))
  #ClusterCastMat[is.na(ClusterCastMat)] <- -3 #pseudocount 
  row.names(ClusterCastMat) <- ClusterCast$Particle
  #Try to log transform w/pseudocount & switch to pearson corr
  #log10(ClusterCastMat+1)
  
  # calculate the associations
  SpearRes <- data.table(Compute_Spearman_Correlation_And_Melt(ClusterCastMat,i,NA))
  
  # add important metadata
  SpearRes$Cluster <- pal 
  
  # calculate prevalence of each otu in the cluster
  OTUFrame <- ClusterSub %>% filter(Count > 1) %>% group_by(OTU) %>% mutate(InstancesOTU = n())
#  OTUFrame <- ClusterSub[,.(InstancesOTU=length(Count > 1)) ,by=.(OTU)]
  OTUFrame$ParticlesInCluster <- sum(OTUFrame$InstancesOTU)
  OTUFrame$ProportionOfInstancesPerCluster <- OTUFrame$InstancesOTU/OTUFrame$ParticlesInCluster
  
  # add it to the spearman results
  SpearRes$InstancesOTU1 <- OTUFrame$InstancesOTU[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$InstancesOTU2 <- OTUFrame$InstancesOTU[match(SpearRes$OTU2,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU1 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU2 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU2,OTUFrame$OTU)]
  
  AllSpearRes <- rbind(AllSpearRes,SpearRes,fill=T)
}

# clean up result
try(AllSpearRes <- AllSpearRes %>% select(-one_of("V1")))
AllSpearRes <- AllSpearRes[complete.cases(AllSpearRes)]



#PrevalentSet Processing

#look at OTUs with sufficient prevalence
PrevalentSet <- AllSpearRes[InstancesOTU1 > 10 & InstancesOTU2 > 10]

# add significance
PrevalentSet$Significant <- PrevalentSet$SpearmanAdjustedP < .05

# order the plot
PrevalentSet$Cluster <- factor(PrevalentSet$Cluster,levels=0:max(as.numeric(PrevalentSet$Cluster)))

#subset, and rename to differentiate

#OTU1Frame <- unique(fulldataset[,.(OTU,Phylum,Class,Order,Family)])
OTU1Frame <- distinct(select(subdataset, OTU,Phylum,Class,Order,Family))
names(OTU1Frame)[1] <- "OTU1"
names(OTU1Frame)[2:ncol(OTU1Frame)] <- paste(names(OTU1Frame)[2:ncol(OTU1Frame)],"OTU1",sep="_")

OTU2Frame <- distinct(select(subdataset, OTU,Phylum,Class,Order,Family))
names(OTU2Frame)[1] <- "OTU2"
names(OTU2Frame)[2:ncol(OTU2Frame)] <- paste(names(OTU2Frame)[2:ncol(OTU2Frame)],"OTU2",sep="_")

# add the order to the otu names
OTU1Frame$OTU1WithOrder <- paste(OTU1Frame$OTU1,OTU1Frame$Order_OTU1,sep="_")
OTU2Frame$OTU2WithOrder <- paste(OTU2Frame$OTU2,OTU2Frame$Order_OTU2,sep="_")

# merge them
PrevalentSet <- merge(PrevalentSet,OTU1Frame,by="OTU1")
PrevalentSet <- merge(PrevalentSet,OTU2Frame,by="OTU2")

# add color for plotting

#otumapping <- read.csv("../experiments/2022-09-13 Guillaume FMT r3/DeSeq_OTU_dynamics.csv") 

#OTU type was determined from Analysis.R file
PrevalentSet$OTU1ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU2,otumapping$OTU)]
PrevalentSet$OTU1Type <- otumapping$OTUType[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2Type <- otumapping$OTUType[match(PrevalentSet$OTU2,otumapping$OTU)]
PrevalentSet$OTU1emergence <- otumapping$emergence[match(PrevalentSet$OTU1,otumapping$OTU)]
PrevalentSet$OTU2emergence <- otumapping$emergence[match(PrevalentSet$OTU2,otumapping$OTU)]


PrevalentSet <- PrevalentSet[!is.na(PrevalentSet$OTU1Type),]
PrevalentSet <- PrevalentSet[!is.na(PrevalentSet$OTU2Type),]



write.csv(PrevalentSet, 
          paste("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_", set, ".csv", sep = ''))
}

```



MaPS-Seq correlation figure for all
```{r}
set <- c('Donor', 'Pre FMT', 'Post FMT')

for (i in 1:length(set)) {
     print(set[i])
   group <- set[i]

PrevalentSet <- read.csv(
     paste("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_",group, ".csv", sep = ''))

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSet$Order_OTU1)))), c(levels(as.factor(PrevalentSet$Order_OTU1))))

PrevalentSet[PrevalentSet == 'Neither'] <- 'Shared Taxa'
PrevalentSet[PrevalentSet == 'Envigo Specific'] <- 'Donor Taxa'
PrevalentSet[PrevalentSet == 'Jackson Specific'] <- 'Recipient Taxa'

corplot_all <- ggplot(PrevalentSet, aes(tidytext::reorder_within(OTU1ColorName, InstancesOTU1, Cluster),
                                   tidytext::reorder_within(OTU2ColorName, InstancesOTU2, Cluster),
                                   fill=Correlation)) +
  geom_tile() +
  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0,limits=c(-.5,.5)) +
  theme_clean() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  upstartr::scale_x_reordered() +
  upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") +
  geom_point(data=function(x){x[PrevalentSet$Significant == TRUE, ]},size=.75,alpha=.7,color="black",shape=8) +
  facet_wrap(~Cluster,scales="free")

corplot_all

ggsave(paste("../figs/fig5/", group, "/MaPSSeq_Correlations_", group, ".pdf",sep = ''), width = 20, height = 18)
ggsave(paste("../figs/fig5/", group, "/MaPSSeq_Correlations_", group, ".png",sep = ''), width = 20, height = 18)

#Now get family values

corplot_fam <- PrevalentSet %>%
  ggplot(.,aes(OTU1ColorName, 1, fill=Order_OTU1)) +
  geom_tile() +
  theme_clean() +
  scale_fill_manual(values = bugColors) +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10)) +
  labs(fill = "Order", x = "OTU 1") +
  facet_wrap(~Cluster,scales="free")

corplot_fam

ggsave(paste("../figs/fig5/", group, "/MaPSSeq_order_", group, ".pdf",sep = ''), width = 20, height = 18)

}

```







Read in all PrevalentSets
```{r}

PrevalentSets <- rbind((read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Post FMT.csv") %>% 
  mutate(MouseGroup = 'Post FMT')),
(read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Pre FMT.csv") %>% 
  mutate(MouseGroup = 'Pre FMT')),
(read.csv("../experiments/2022-09-13 Guillaume FMT r3/PrevalentSet_Donor.csv") %>% 
  mutate(MouseGroup = 'Donor'))) %>% select(-X) %>% mutate(MouseGroup = as.factor(MouseGroup))
                
```



OTU composition of each cluster
```{r}
 
PrevalentSets %>% select(Cluster, OTU1ColorName, Order_OTU1, MouseGroup) %>% 
  distinct() %>% 
  ggplot(.,aes(x=Cluster, fill=Order_OTU1)) +
  geom_bar() +
  theme_cowplot() +
  scale_x_continuous(breaks = seq(0,16,1)) +
  scale_fill_manual(values = bugColors) +
  #scale_fill_distiller(palette = "Paired") +
  theme(
    axis.text = element_text(size = 14),
    strip.background = element_blank(),
    strip.text = element_text(size = 14)) +
  labs(fill = "Order", x = "Cluster", y = '# of OTUs') + 
  facet_wrap(~factor(MouseGroup, levels = c('Pre FMT', 'Post FMT', 'Donor')), nrow = 3, scales = 'free_x', strip.position = 'right') 

ggsave(paste("../figs/fig5/TaxComposition_all.pdf",sep = ''), width = 7, height = 12)
ggsave(paste("../figs/fig5/TaxComposition_all.png",  sep = ''), width = 7, height = 12)

```

Number of counts per clusters
```{r}

PrevalentSets %>% select(Cluster, MouseGroup) %>% 
  ggplot(.,aes(x=Cluster)) +
  geom_bar(stat = 'count', fill = 'dodgerblue', color = 'black') +
  theme_cowplot() +
  scale_x_continuous(breaks = seq(0,16,1)) +
  theme(
    axis.text = element_text(size = 14),
    strip.background = element_blank(),
    strip.text = element_text(size = 14)) +
  labs(fill = "Order", x = "Cluster", y = '# of Particles') + 
  facet_wrap(~factor(MouseGroup, levels = c('Pre FMT', 'Post FMT', 'Donor')), nrow = 3, scales = 'free_x', strip.position = 'right') 

ggsave(paste("../figs/fig5/ClusterCounts_all.pdf",sep = ''), width = 4.5, height = 12)
ggsave(paste("../figs/fig5/ClusterCounts_all.png",  sep = ''), width = 4.5, height = 12)

```


Interactions per cluster

```{r}

PrevalentSets %>% 
      select(Cluster,OTU1,OTU2, Correlation, Significant, MouseGroup) %>%    
      filter(Significant == TRUE) %>%
      mutate(interaction_type = ifelse(Correlation > 0, '+', '-')) %>%
      group_by(Cluster, MouseGroup, interaction_type) %>% 
  mutate(num_interactions_cluster = n()/2) %>% ungroup %>%
  select(Cluster, interaction_type, MouseGroup, num_interactions_cluster) %>% 
  distinct() %>%
      ggplot(., aes(x=as.factor(Cluster), y = num_interactions_cluster, fill = interaction_type)) + 
        geom_bar(position = 'stack', stat='identity') + 
        facet_wrap(~OTU1Type, nrow = 1) +
        scale_fill_manual(values = c('dodgerblue', 'firebrick2')) +
        labs(y = 'Number of Interactions', x = 'Cluster', fill = 'Interaction Type') +
      #scale_y_continuous(breaks = seq(5,50, 5)) +
      theme_cowplot() +
      theme(axis.text = element_text(size=14,color = 'black'), 
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        strip.text = element_text(size = 14),
        strip.background = element_blank(),
        legend.text = element_text(size=12,color = 'black'),
        legend.title = element_text(size = 14, hjust = .5,color = 'black'),
        legend.position = 'right') + 
      facet_wrap(~factor(MouseGroup, levels = c('Pre FMT', 'Post FMT', 'Donor')), 
             nrow = 3, scales = 'free', strip.position = 'right') 

ggsave("../figs/fig5/ClusterInteractions.png",  width = 6, height = 12)
ggsave("../figs/fig5/ClusterInteractions.pdf",  width = 6, height = 12)

```


Cool cluster data! So what kind of interactions are happening now?

Lets look at dominant OG cluster first
```{r}
library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Order_OTU1)))), c(levels(as.factor(PrevalentSets$Order_OTU1))))


# Create data frame for edges

#Pre FMT dominant cluster
clustr <- 0
sample <- 'Pre FMT'

cluster_network <- PrevalentSets %>%
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  filter(MouseGroup == sample) %>%
    filter(Cluster == clustr, Significant == TRUE) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>% 
    #filter(Significant == TRUE) %>% #to only show significant edges
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
a<- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
   # scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.8)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
   # geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), nudge_y = .1) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, ";", sample, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

clustr <- 0
sample <- 'Post FMT'

cluster_network <- PrevalentSets %>%
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  filter(MouseGroup == sample) %>%
    filter(Cluster == clustr, Significant == TRUE) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>% 
    #filter(Significant == TRUE) %>% #to only show significant edges
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
b<- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
   # scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.8)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
   # geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), nudge_y = .1) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, ";", sample, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

plot_grid(a,b)

```


What about if we do cluster-independent?

Lets look at dominant OG cluster first
```{r}
library(ggraph)
library(igraph)

bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSets$Order_OTU1)))), c(levels(as.factor(PrevalentSets$Order_OTU1))))


# Create data frame for edges

#Pre FMT dominant cluster
sample <- 'Pre FMT'

cluster_network <- PrevalentSets %>%
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  filter(MouseGroup == sample) %>% 
    filter(Significant == TRUE) %>% #only significant interactions
  group_by(OTU1, OTU2) %>% mutate(num_interacts = n(),
                                  InstancesOTU1 = mean(InstancesOTU1)) %>% 
  ungroup() %>% distinct()
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>% 
    #filter(Significant == TRUE) %>% #to only show significant edges
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% group_by(OTU1) %>% 
  mutate(InstancesOTU1=mean(InstancesOTU1)) %>% ungroup() %>%
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
a<- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
   # scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.8)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
    geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), nudge_y = .1) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste( sample, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

sample <- 'Post FMT'

cluster_network <- PrevalentSets %>%
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  filter(MouseGroup == sample) %>% 
    filter(Significant == TRUE) %>% #only significant interactions
  group_by(OTU1, OTU2) %>% mutate(num_interacts = n(),
                                     mean_interaction = mean(Correlation)) %>% 
  ungroup() %>% distinct()

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>% 
    #filter(Significant == TRUE) %>% #to only show significant edges
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% group_by(OTU1) %>% 
  mutate(InstancesOTU1=mean(InstancesOTU1)) %>% ungroup() %>%
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% distinct()

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
b<- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
   # scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.8)) +
    scale_size_continuous(range = c(0, 10)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.5), color = 'white') +
   geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    geom_node_text(aes(label = name), nudge_y = .1) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste(sample, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

plot_grid(a,b)

```






