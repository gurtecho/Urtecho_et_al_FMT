---
title: "Fig5_GrowthFigs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("~/Dropbox/fmt/scripts/")
library(tidyverse)
library(wesanderson)
library(ggthemes)
library(data.table)
library(tidytext)
library(cowplot)


ven <- c('#FAAF40',"#1B75BB","#37B34A", "#F05A28")
pal <- wes_palette("Zissou1", 100, type = "continuous")
bugColors <- read.csv('../tables/bugColors.csv')$x


options(stringsAsFactors = F)
options(scipen = 10000)

zotu <- read_csv("../seq/zotu.csv") 
tax <- read_csv("../seq/tax.csv")
meta <- read_csv("../experiments/2021-12-22_JvEPolysaccharideScreen/metadata/metadata.csv")

#bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSet$Order_OTU1)))), c(levels(as.factor(PrevalentSet$Order_OTU1))))

```


FIgure 5E - Polysaccharide Growth reader assay 

Read in growth data/metadata
```{r}

meta_growth <- read_csv("../experiments/2021-09-25_Ope_JvE_polysaccharide_screen/data/polysacc_growth_metadata.csv")

data <- read_csv("../experiments/2021-09-25_Ope_JvE_polysaccharide_screen/data/polysacc_growth_data.csv") %>%
  filter(well %in% meta_growth$well) %>% # filter the data to those wells in the metadata
  left_join(meta_growth, by="well") 
  
   
# Define Order I want to plot polysaccharides in, to be used as levels (i.e. plot order)
polysacc.order <-c("Water", "Glucose", "Inulin","Arabinan", "Cellobiose","Arabino-galactan", 
                   "Mucin", "Pectin", "Amylopectin", "MGAM")

# Compute the bg growth from the OD600 of the water wells
bg <- data %>%
  filter(polysacc == "Water") %>%
  group_by(time_mins, sample_type) %>%
  summarise(bg = mean(OD600))


# Add bg data to the actual data
data <- data %>%
  left_join(bg, by=c("time_mins", "sample_type")) %>%
  mutate(norm_OD600 = OD600/bg,  # Compute OD600 normalized against water controls
         corr_OD600 = OD600-bg, # Compute the OD600 corrected against water controls
         #sample_type = factor(data$sample_type, levels = c("Jax", "Envigo", "J"))
         sample_type = factor(data$sample_type, levels = c("- FMT", "Donor", "+ FMT")), # convert sample type to factor with levels ordered [would sepcify order here eg. jax, envigo, both]
         polysacc = factor(data$polysacc, levels = polysacc.order), # convert polysaccharide to factor, levels in order I want to plot
         replicate = factor(data$replicate, levels=as.character(unique(data$replicate)))) #Order replicates

# Create averaged out data
avg.data <- data %>%
  group_by(polysacc, sample_type, time_mins) %>%
  summarise(OD600 = mean(OD600), bg= mean(bg))

# Compute OD600 normalized against water controls
avg.data$norm_OD600 <- avg.data$OD600 / avg.data$bg

# Compute the OD600 corrected against water controls
avg.data$corr_OD600 <- avg.data$OD600 - avg.data$bg
  

# Plot averaged out data
avg.viz <- avg.data  %>%
  filter(polysacc != "Water", polysacc != "Mucin", polysacc != "Amylopectin", polysacc != "Pectin") %>% #remove carbohydrate sources too-dense to measure growth of
   # filter(polysacc != "Water") %>%
  group_by(polysacc) %>% mutate(Nmax = norm_OD600/max(norm_OD600)) %>%
  ungroup() %>% 
  ggplot() +
  #geom_line(aes(x=time_mins/60, y=Nmax, color=sample_type)) +
  stat_smooth(aes(x=time_mins/60, y=Nmax, color=sample_type), method = "loess", span = 0.2) +
  scale_color_manual(values = c('#f6921e','#26a9e0','#1b75bb')) +
  facet_wrap(~factor(polysacc, levels = polysacc.order), nrow = 3, scales = 'free') + 
  scale_x_continuous(breaks = c(0,12,24,36), limits = c(0,42)) +
  labs(x="Time (hrs)", y = 'Normalized OD600', color = 'Fecal Source') +
  theme_clean() +
  scale_y_continuous(breaks = c(.25,.5,.75,1), limits = c(.15,1)) +
  # theme... used for the theme of the graph
  theme(
    axis.title.x = element_text(size = 14),
    axis.text.x = element_text(size=12),
    axis.title.y = element_text(size = 14),
    axis.text.y = element_text(size=12),
    legend.title = element_text(size=14),
    legend.text = element_text(size=14),
    strip.text.x = element_text(size=12),
    strip.text.y = element_text(size=12),
    strip.text.y.right = element_text(angle = 0))

avg.viz

ggsave("../figs/fig5/5E_Polysaccharide Growth.png", width = 6, height = 5)
ggsave("../figs/fig5/5E_Polysaccharide Growth.pdf", width = 6, height = 5)

```


Filter read counts and calculate normalized reads to absolute abd


***Should we normalize to OD at all?*** No b/c they all reach saturation and we use same amount of volume. 


```{r}


# Check read counts
read.counts <- zotu %>%
  rowwise(seqid) %>%
  mutate(numreads = rowSums(across(where(is.numeric)))) %>%
  ungroup() %>%
  select(seqid, numreads)

# Pull out samples w/ >10k reads
samples.to.keep <- read.counts %>%
  filter(numreads > 1000) %>%
  select(seqid) %>%
  as_vector()

# Drop <1k read samples from zotu table
zotu <- zotu %>%
  filter(seqid %in% samples.to.keep)

# make tidy data
# Convert to relative abundance

zotu <- zotu %>%
  pivot_longer(!seqid, names_to="OTU", values_to="reads") %>%
  group_by(seqid) %>%
  mutate(reads = reads/sum(reads)*30000) %>%  #normalize to number of reads per sample
  inner_join(meta, ., by="seqid")


#Dataframe with normalization values
normalizer <- zotu %>% filter(OTU == "Otu1") %>% 
                      mutate(norm_factor_sporo = (reads/min(reads)),   #calculate normalization factor for sporo
                     # norm_factor_pellet = (sample_weight/min(sample_weight))
                     ) %>% #calculate normalization factor for pellet
                      select(seqid, norm_factor_sporo)

#shared scaling factors so values appear somewhat normal
med_sporo <- median(normalizer$norm_factor_sporo) 
#med_sample_weight <- median(normalizer$norm_factor_pellet)

norm_zotu <- inner_join(zotu, normalizer, by = 'seqid') %>% 
        mutate(abs_reads = ifelse(reads==0, 0, 
                ((reads/norm_factor_sporo)*med_sporo))) %>% #normalize here
      filter(OTU != 'Otu1') %>%   #Remove sporosarcina going forward
      group_by(seqid) %>%
      mutate(abs_rel_abundance = abs_reads/sum(abs_reads)) %>% ungroup()


#quick renames
norm_zotu[norm_zotu == "envigo_control"] <- "Envigo Control"
norm_zotu[norm_zotu == "jax_control"] <- "Jax Control"
norm_zotu[norm_zotu == "jax_envigo_mix"] <- "Jax Cohoused"

```


Filter OTUs below abundance threshold

```{r pressure, echo=FALSE}

otus.to.keep <- norm_zotu %>%
  group_by(OTU, polysacc, mouse_type) %>%
  summarise(avg_abd = mean(abs_rel_abundance)) %>%
  filter(avg_abd > .05) %>% ungroup() %>%
  select(OTU) %>% distinct() %>%
  as_vector() 


# Drop OTUs not at least .5% abd
norm_zotu <- norm_zotu %>%
  filter(OTU %in% otus.to.keep)

# calc log10 OTU abd
norm_zotu <- norm_zotu %>%
  mutate(log10abs_rel_abundance = if_else(abs_rel_abundance == 0, -5, log10(abs_rel_abundance)),
         log10absl_abundance = if_else(abs_reads == 0, -1, log10(abs_reads)))


gtable <- tax %>%
  select(OTU, genus, family)

norm_zotu <- norm_zotu %>%
  left_join(gtable, by="OTU") %>%
  mutate(otu_genus = paste(OTU, genus, sep="_"))


```

heatmap of polysaccharide levels

```{r}

library('ggdendro')
library('grid')

set.seed(123)

jax.cohoused <- norm_zotu %>% #filter(mouse_type == 'JE') %>%
    group_by(polysacc, OTU) %>% filter(OTU != 'Otu1') %>% 
    summarise(mean_log10absl_abundance = mean(log10absl_abundance)) %>% 
  select(OTU, polysacc, mean_log10absl_abundance) %>% distinct() %>% reshape2::dcast(OTU~polysacc)


jax.cohoused.scaled <- jax.cohoused
#jax.cohoused.scaled[, c(2:ncol(jax.cohoused.scaled)-1)] <- (jax.cohoused.scaled[, 2:6]) #don't scale here actually

#clustering
jax.cohoused.matrix <- as.matrix(jax.cohoused.scaled[, -c(1)])
rownames(jax.cohoused.matrix) <- jax.cohoused.scaled$OTU
jax.cohoused.dendro <- as.dendrogram(hclust(d = dist(x = jax.cohoused.matrix)))

# Create dendro
dendro.plot <- ggdendrogram(data = jax.cohoused.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot)


#reorder
jax.cohoused.order <- order.dendrogram(jax.cohoused.dendro)
#jax.cohoused.long <- left_join(jax.cohoused.long, gtable)
norm_zotu$OTU <- factor(x = norm_zotu$OTU,
                               levels = jax.cohoused.scaled$OTU[jax.cohoused.order], 
                               ordered = TRUE)




bugColors <- setNames(c(scales::hue_pal()(length(unique(norm_zotu$family)))), c(levels(as.factor(norm_zotu$family))))

norm_zotu[norm_zotu == 'EC'] <- "Env"
norm_zotu[norm_zotu == 'JC'] <- "Jax"
norm_zotu[norm_zotu == 'JE'] <- "Env2Jax"



heatmap.plot <- norm_zotu %>% group_by(polysacc, mouse_type, OTU) %>%
  summarise(mean_log10absl_abundance = mean(log10absl_abundance)) %>%
  distinct() %>%
  ggplot() +
  #geom_tile(aes(x=factor(mouse_type, levels = c("No FMT", "Post FMT", "Donor")), y=OTU, fill=mean_log10abs_rel_abundance)) + 
  #facet_grid(~factor(polysacc, 
#            levels = c("mGAM", "glucose", "arabinan", "arabinogalactan", "inulin", "cellobiose", "apple_pectin", "mucin"))) +
  geom_tile(aes(x=factor(polysacc, 
          levels = c("mGAM", "glucose", "arabinan", "arabinogalactan", "inulin", "cellobiose", "apple_pectin", "mucin")), 
          y=OTU, fill=mean_log10absl_abundance), color = 'white') + 
  facet_grid(~factor(mouse_type, levels = c("Jax", "Env2Jax", "Env"))) +
    scale_fill_gradient2(high = 'firebrick3', mid = 'white', low = '#1357a6', midpoint = 1.5) +
    #scale_fill_gradientn(colours = pal, limits = c(-1,5)) + 
  labs(x='Day', fill ='Relative Abundance') +
  theme(strip.text.y.right = element_text(angle = 0),
        panel.background = element_rect(fill = "white"), 
              axis.ticks = element_blank(), 
              axis.title.y = element_blank(),
 #             axis.text.y = element_blank(), 
              axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
              strip.text = element_text(size = 10),
              panel.spacing = unit(0.05, "lines"),
            strip.background = element_blank(),
        legend.position = 'bottom') 

fam <- ggplot(data = norm_zotu, aes(x = '', y = OTU)) +
    geom_tile(aes(fill = family), color = 'white') + 
    labs(fill = 'Family') +
    theme(strip.text.y.right = element_text(angle = 0),
              panel.background = element_blank(), 
              axis.ticks = element_blank(), 
              axis.text.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.x = element_blank(), 
              axis.title.x = element_blank(),
              strip.text = element_blank(),
              panel.spacing = unit(0.05, "lines"))

cowplot::plot_grid(heatmap.plot, fam, ncol =2, rel_widths = c(.6,.4))

ggsave("../figs/s7/s7_polysacc_FMT.png",  width = 14, height = 5)
ggsave("../figs/s7/s7_polysacc_FMT.pdf",  width = 14, height = 5)

```

Are the ones that grow just the donor engrafted bugs? Or do recipient taxa gain the ability to grow too now?
```{r}

otu_origins <- read.csv('../tables/otu_origins.csv')

test <- norm_zotu %>% filter(mouse_type == 'Post FMT') %>%  
  group_by(polysacc, mouse_type, OTU) %>%
  summarise(mean_log10abs_rel_abundance = mean(log10absl_abundance)) %>%
  distinct() %>% ungroup %>% 
  #inner_join(., otu_origins) %>% 
  left_join(., otu_origins) #%>% 
  group_by(polysacc, mouse_type, class) %>% 
  mutate(abundance_class = 10^sum(mean_log10abs_rel_abundance)) %>% 
  select(-OTU, -mean_log10abs_rel_abundance) %>% ungroup() %>% distinct() %>%
  ggplot(., aes(polysacc, y=abundance_class, fill = class)) + 
  geom_bar(stat = 'identity',position = 'fill') +
  theme_cowplot() +
   theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 16),
        axis.text.y = element_text(size=16, color = 'black'),
        axis.title.x.bottom = element_text(size = 16,color = 'black'),
        axis.title.y.left = element_text(size = 16,color = 'black'),
        legend.position = 'top')

  
#also try with 2ndary

  
```


```{r}
# Pull out OTUs at least 1% abd in either jax or envigo controls
jax.otus.to.keep <-  norm_zotu %>%
  group_by(seqid) %>% mutate(rel_abd = reads/sum(reads)) %>% 
  ungroup() %>%
  filter(mouse_type == "No FMT") %>%
  group_by(OTU, polysacc) %>%
  summarise(avg_abd = mean(rel_abd)) %>%
  filter(avg_abd > .5) %>%
  select(OTU) %>%
  as_vector()

envigo.otus.to.keep <- norm_zotu %>%
  group_by(seqid) %>% mutate(rel_abd = reads/sum(reads)) %>% 
  ungroup() %>%
  filter(mouse_type == "Donor") %>%
  group_by(OTU, polysacc) %>%
  summarise(avg_abd = mean(rel_abd)) %>%
  filter(avg_abd > .5) %>%
  select(OTU) %>%
  as_vector()

otus.jax.Specific <- setdiff(jax.otus.to.keep, envigo.otus.to.keep) %>%
                  cbind('Recipient') %>% as.data.frame() 

names(otus.jax.Specific) <- c("OTU", "class")

otus.envigo.Specific <- setdiff(envigo.otus.to.keep, jax.otus.to.keep) %>% 
  cbind('Donor') %>% as.data.frame() 

names(otus.envigo.Specific) <- c("OTU", "class")


otus.shared.Specific <- intersect(jax.otus.to.keep, envigo.otus.to.keep) %>%
    cbind('Shared') %>% as.data.frame()

names(otus.shared.Specific) <- c("OTU", "class")


otu_labels <- rbind(otus.envigo.Specific, otus.jax.Specific, otus.shared.Specific)


```


```{r}
labz <- data.frame(polysacc =c('glucose', 'arabinan', 'arabinogalactan', 'inulin', 'cellobiose', 'mGAM'), media =c('MM+Glucose', 'MM+Arabinan', 'MM+Arabinogalactan', 'MM+Inulin', 'MM+Cellobiose', 'mGAM'))

test <- norm_zotu %>% #filter(mouse_type == 'Post FMT') %>%  
  group_by(polysacc, mouse_type, OTU) %>%
  summarise(mean_log10abs_rel_abundance = mean(log10absl_abundance)) %>%
  distinct() %>% ungroup %>% 
  inner_join(., otu_labels) %>% 
  group_by(polysacc, mouse_type, class) %>% 
  mutate(abundance_class = sum(10^mean_log10abs_rel_abundance)) %>% 
  select(-OTU, -mean_log10abs_rel_abundance) %>% 
  ungroup() %>% distinct() %>% inner_join(.,  labz) %>%
  ggplot(., aes(factor(media, levels = c('MM+Glucose', 'MM+Arabinan', 'MM+Arabinogalactan', 'MM+Inulin', 'MM+Cellobiose', 'mGAM')), y=abundance_class, fill = class)) + 
  geom_bar(stat = 'identity',position = 'stack') + 
  scale_fill_manual(values = c('#1e90ff','#ffa500','grey')) +
  scale_y_continuous(breaks = c(0,1)) +
  #scale_x_discrete(limits = c('glucose', 'arabinan', 'arabinogalactan', 'inulin', 'cellobiose', 'mGAM')) +
  theme_cowplot() +
  labs(x = 'Carbohydrate Supplement', y = 'Proportion of post FMT\n Cultured Biomass', fill = '') +
   theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 12),
        axis.text.y = element_text(size=12, color = 'black'),
        axis.title.x.bottom = element_text(size = 14,color = 'black'),
        axis.title.y.left = element_text(size = 14,color = 'black'),
        legend.position = 'right', legend.text = element_text(size = 10)) + facet_wrap(~mouse_type)
test

ggsave("../figs/s7/S7_PolysaccGrowthidentities.pdf", width = 4, height = 3.5)

```


```{r}


```