---
title: "FMT_Split_Associations"
output: html_document
date: "2022-07-26"
---

```{r setup, include=FALSE}
#setwd("C:/Users/mipzr/Dropbox/SPMap/2022-01-12 Mouse FMT")
setwd("~/Dropbox/fmt/experiments/2021-06-09_JxE_MaPS02/2022-01-12 Miles MaPS-seq/")

# load required packages
library(data.table)
library(ggplot2)
library(stringr)
library(dplyr)
library(cowplot)
source("../../../scripts/CompteSpearmanCorrelationAndMelt.R")

theme_set(theme_bw())

# load data
CorrectedData <- fread("CorrectedDataFrame.csv")
Tax_Table <- fread("Silva Tax_Table.csv")

#merge it
fulldataset <- merge(CorrectedData,Tax_Table)
fulldataset$Particle <- as.character(fulldataset$Particle)

unique(fulldataset$Sample)

# fix names
fulldataset$MouseGroup <- str_extract(fulldataset$Particle,"^[:alpha:]{1,2}")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"JE","Post FMT")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"J","Pre FMT")
fulldataset$MouseGroup <- str_replace(fulldataset$MouseGroup,"E","Donor")

unique(fulldataset$MouseGroup)

# make bulk name
fulldataset$Bulk <- "Particle"
fulldataset$Bulk[str_which(fulldataset$Sample,"jxe")] <- "Bulk"

table(fulldataset$Bulk)


```


```{r}
#fwrite(fulldataset,"fulldataset.csv")

# read distributions by sample
SamplesToLoop <- unique(fulldataset[Bulk == "Particle"]$Sample)
LoopDataset <- fulldataset[, sum(Count), by = .(Particle,Sample)]
SampleCounts <- fulldataset[, sum(Count), by = .(Sample)]
SampleAllData <- data.table(NA)
for(SAMPLE in SamplesToLoop){
  df <- LoopDataset[Sample == SAMPLE]
  MaxRead <- SampleCounts[Sample == SAMPLE]$V1
  ReadCountsToSample <- exp(seq(log(1), log(MaxRead), length.out = 100))
  AllData <- data.table(NA)
  for(i in ReadCountsToSample){
    ParticleNames <- sample(df$Particle, i, prob=df$Count,replace = T)
    NumberOfParticles <- length(unique(ParticleNames))
    TableRes <- table(ParticleNames)
    MedianParticleReadCount <- median(TableRes)
    MaxReadCount <- max(TableRes)
    MinReadCount <- min(TableRes)
    GreaterThan10 <- sum(TableRes > 10)
    MatchingPair <- cbind(i,NumberOfParticles,MedianParticleReadCount,
                          MaxReadCount,MinReadCount,
                          GreaterThan10)
    AllData <- rbind(AllData,MatchingPair,fill=T)
  }
  AllData <- data.table(AllData)
  AllData <- AllData[-1,]
  AllData$Sample <- SAMPLE
  
  SampleAllData <- rbind(SampleAllData,AllData,fill=T)
}

# get mouse groups
SampleAllData$MouseGroup <- str_extract(SampleAllData$Sample,"[:alpha:]{1,2}")

# save it
#saveRDS(SampleAllData,"allsamplerarefaction.rds")

SampleAllData$V1 <- NULL
```


  
  
```{r}
# get comparable sets
ParticleSet <- fulldataset[Bulk == "Particle"]

ParticleSet[, ParticleNumberPerSample:=length(unique(Particle)), by = .(Sample)]
unique(ParticleSet[,.(Sample,ParticleNumberPerSample)])

OTUSumsBySample <- ParticleSet[, sum(Count), by = .(Sample,MouseGroup,OTU)]
ParticleSumsBySample <- ParticleSet[, sum(Count), by = .(Sample,MouseGroup,Particle)]

ParticleSet[, ParticleSum:=sum(Count), by = .(Particle)]
ParticleSet[,OTUsPerParticle := length(unique(OTU)),by=.(Particle)]
ParticleSet[,SampleReadSum := sum(Count),by=.(Sample)]

ParticleSet$ParticleRelativeAbundance <- ParticleSet$Count/ParticleSet$ParticleSum

ParticleSet[ParticleRelativeAbundance > 0.01,OTUsPerParticle01 := length(unique(OTU)),by=.(Particle)]
ParticleSet[ParticleRelativeAbundance > 0.1,OTUsPerParticle1 := length(unique(OTU)),by=.(Particle)]
ParticleSet[ParticleRelativeAbundance > 0.005,OTUsPerParticle005 := length(unique(OTU)),by=.(Particle)]

ParticleSet$ParticleFractionLibrary <- ParticleSet$ParticleSum/ParticleSet$SampleReadSum

ParticleSetSub <- fulldataset[Bulk == "Particle"]
# particles dropped
length(unique(ParticleSetSub$Particle))/length(unique(ParticleSet$Particle))



ParticleSumSet <- unique(ParticleSet[,
                                     .(ReadCount=sum(Count),
                                       ParticleNumberPerSample,
                                       Efficiency=length(unique(ParticleSum)>100)),
                                     by=.(Sample,MouseGroup)])
ParticleSumSet$ReadsPerParticle <- ParticleSumSet$ReadCount/ParticleSumSet$ParticleNumberPerSample
ParticleSumSet$ReadsPerGreater100 <- ParticleSumSet$ReadCount/ParticleSumSet$Efficiency
ParticleSumSet$EfficiencyPercent <- ParticleSumSet$Efficiency/ParticleSumSet$ParticleNumberPerSample

ParticleSumSet2 <- unique(ParticleSet[,.(Sample,MouseGroup,ParticleSum,ParticleNumberPerSample,OTUsPerParticle005)])

```



```{r}

#subset data

fulldataset[, ParticleSum:=sum(Count), by = .(Particle)]

ParticleSet <- fulldataset[ParticleSum > 100]

ParticleSet[, ParticleSum:=sum(Count), by = .(Particle)]
ParticleSet[,OTUsPerParticle := length(unique(OTU)),by=.(Particle)]
ParticleSet$ParticleRelativeAbundance <- ParticleSet$Count/ParticleSet$ParticleSum
ParticleSet[ParticleRelativeAbundance > 0.01,OTUsPerParticle005 := length(unique(OTU)),by=.(Particle)]
qplot(log10(ParticleSet$ParticleRelativeAbundance))

# subset and calculate things
ParticleCutoffDataset <- ParticleSet[(ParticleSum>500 | OTUsPerParticle005 > 6) & ParticleRelativeAbundance > 0.005,]
ParticleCutoffDataset[,NumberParticlesPresent005:=(length(Count) > 1) ,by=.(Sample,OTU)]
ParticleCutoffDataset[, ParticleNumberPerSampleCutoff:=length(unique(Particle)), by = .(Sample)]
ParticleCutoffDataset$OTUPresenceProportion <- ParticleCutoffDataset$NumberParticlesPresent005/ParticleCutoffDataset$ParticleNumberPerSampleCutoff

# look at the number of particle per sample
unique(ParticleCutoffDataset[Bulk == "Particle",.(Sample,ParticleNumberPerSampleCutoff)])
```

Split Seurat
```{r}
# seurat
library(Seurat)

set.seed(1337)

# subset the data
ParticleComparison <- ParticleCutoffDataset[Bulk == "Particle"]
ParticleComparison[, ParticleNumberPerSample:=length(unique(Particle)), by = .(Sample)]

# make metadata for seurat
METADATA <- as.matrix(ParticleComparison[,.(Particle,Sample,MouseGroup,ParticleSum,OTUsPerParticle005)])
row.names(METADATA) <- ParticleComparison$Particle
METADATA <- as.data.frame(METADATA) %>% distinct() 
METADATA <- METADATA[!is.na(METADATA$OTUsPerParticle005),] 


#add phylogenetic counts per cluster

#Lactobacillaceae

lacto <- ParticleSetSub %>% filter(Family == 'Lactobacillaceae') %>%
         group_by(Particle) %>%
         mutate(Lactobacillaceae=log10(sum(Count))) %>%
         #mutate(Lactobacillaceae=(sum(Count))) %>%
         select(Particle, Lactobacillaceae)%>% distinct() #lactobacillaceae

lachno <- ParticleSetSub %>% filter(Family == 'Lachnospiraceae') %>%
  group_by(Particle) %>%
  mutate(Lachnospiraceae=log10(sum(Count))) %>%
  #mutate(Lachnospiraceae=(sum(Count))) %>%
  select(Particle, Lachnospiraceae) %>% distinct()  #Lachnospiraceae

Muribac <- ParticleSetSub %>% filter(Family == 'Muribaculaceae') %>% 
  group_by(Particle) %>%
  mutate(Muribaculaceae=log10(sum(Count))) %>%
  #mutate(Muribaculaceae=(sum(Count))) %>%
  select(Particle, Muribaculaceae) %>% distinct() #Muribaculaceae

bacter <- ParticleSetSub %>% filter(Family == 'Bacteroidaceae') %>%
  group_by(Particle) %>%
  mutate(Bacteroidaceae=log10(sum(Count))) %>%    
  #mutate(Bacteroidaceae=(sum(Count))) %>%
  select(Particle, Bacteroidaceae)%>% distinct() #Bacteroidaceae

erys <- ParticleSetSub %>% filter(Family == 'Erysipelotrichaceae') %>% 
  group_by(Particle) %>%
  mutate(Erysipelotrichaceae=log10(sum(Count))) %>%
  #mutate(Erysipelotrichaceae=sum(Count)) %>%
  select(Particle, Erysipelotrichaceae) %>% distinct() #Erysipelotrichaceae

temp <- full_join(lacto, lachno) %>% full_join(., Muribac) %>% 
        full_join(., erys) %>% full_join(., bacter) %>% 
  replace(is.na(.), 0) %>% 
  distinct()

#METADATA
METADATA <- left_join(METADATA, temp) %>% 
  #replace(is.na(.), 0) %>% 
  #filter(OTUsPerParticle005 > 0) %>%
  distinct()

row.names(METADATA) <- METADATA$Particle

# make the dataframe for seurat
casted <- dcast.data.table(ParticleComparison,Particle~OTU,value.var = "Count")
setnafill(casted,fill=0, cols=2:ncol(casted))

castmat <- as.matrix(casted[,2:ncol(casted)])
row.names(castmat) <- casted$Particle

# load into seurat
pbmc <- CreateSeuratObject(counts = t(castmat), 
                           project = "maps", 
                           min.cells = 3, 
                           min.features = 2,
                           meta.data = METADATA)

# normalize data with log + 10000
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize", scale.factor = 10000)

# look at variable features
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(pbmc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(pbmc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = F)

#ggsave("Variable Features with Label.pdf",plot2,height=5,width=7)

# scale the data and run PCA
all.genes <- rownames(pbmc)
pbmc <- ScaleData(pbmc, features = all.genes)
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))

# compute clusters and neighbors
pbmc <- FindNeighbors(pbmc, dims = 1:15)
pbmc <- FindClusters(pbmc, resolution = 0.5)

# actually run umap
pbmc <- RunUMAP(pbmc, dims = 1:15)

```

Plot UMAP
```{r}

# note that you can set `label = TRUE` or use the LabelClusters function to help label
# individual clusters
Plot1 <- DimPlot(pbmc, reduction = "umap") +
  ggtitle("Cluster")
Plot2 <- DimPlot(pbmc, reduction = "umap",
                 group.by='MouseGroup', )
Plot2.1 <- DimPlot(pbmc, reduction = "umap",
                   group.by='Sample')
#
a<- FeaturePlot(object = pbmc, features = "Lactobacillaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

b<- FeaturePlot(object = pbmc, features = "Bacteroidaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

c<- FeaturePlot(object = pbmc, features = "Lachnospiraceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())

d<- FeaturePlot(object = pbmc, features = "Erysipelotrichaceae",reduction = "umap", order = T, combine = T) +
  scale_color_gradientn(colors = c('Gray90', '#3300ff'),limits = c(0,5)) + 
  theme(axis.title = element_blank(), axis.text = element_blank())
                                                                                

#Plot figures 5a here
fxf <- cowplot::plot_grid(a,b,c,d, ncol = 2)
fxf
ggsave("../../../figs/fig5/Family_UMAP_labels.pdf", width = 5, height = 4)
#save projection 
Plot1
ggsave( "../../../figs/fig5/Cluster_UMAP.pdf", width = 4.5, height = 3.5)

cowplot::plot_grid(Plot1, fxf, nrow = 1)
ggsave("../../../figs/fig5/5a_UMAPs_labels.pdf", width = 9, height = 4)


# plot them all together and save
Plot3 <- Plot1 + Plot2 + Plot2.1

#ggsave("Side by Side UMAP balanced.pdf",Plot3,width=19,height=5)
#ggsave("Side by Side UMAP balanced.png",dpi = 800,type="cairo-png",Plot3,width=19,height=5)



```


Now do individual associations

```{r}
#define subset here, 'Pre FMT', 'Donor', 'Post FMT'
#sample_subset <- 'Donor'
#sample_subset <- 'Pre FMT'
sample_subset <- 'Post FMT'


  
ParticleComparison_subset <- filter(ParticleComparison, MouseGroup == sample_subset)

#ParticleComparison_subset <- ParticleComparison   #if want to make plotframe for whole dataset

# extract the cluster identities
clusteres <- data.table(pbmc@meta.data)
clusteres$Sample <- factor(clusteres$Sample)

plotframe <- clusteres[,.(NumberParticles=length(unique(Particle))),by=.(Sample,seurat_clusters,MouseGroup)]

# tabulare the sum
#plotframe <- reshape2::melt(table(clusteres$Sample,clusteres$seurat_clusters))

# rename to improve legibility
names(plotframe)[2] <- c("Cluster")

#plotframe$Var2 <- as.character(plotframe$Cluster)
#plotframe$Var2 <- factor(plotframe$Var2,levels=0:max(as.numeric(plotframe$Var2)))
plotframe[, TotalParticleCluster:=sum(NumberParticles) , by=.(Cluster)]
plotframe$ClusterProportion <- plotframe$NumberParticles/plotframe$TotalParticleCluster

# calculate stats by mouse group
plotframe[,ParticlesMouseGroupCluster:=sum(NumberParticles),by=.(Cluster,MouseGroup)]
plotframe$ClusterProportionMouseGroup <- plotframe$ParticlesMouseGroupCluster/plotframe$TotalParticleCluster

# add necessary data and calculate some more things
plotframe <- merge(plotframe,unique(ParticleComparison[,.(Sample,ParticleNumberPerSample)]),by="Sample")
plotframe$ParticleNumberPerSample <- as.numeric(plotframe$ParticleNumberPerSample)
plotframe$SampleProportion <- plotframe$NumberParticles/plotframe$ParticleNumberPerSample


#remove this if not splitting
#plotframe <- filter(plotframe, MouseGroup == sample_subset)

# kruskal test for each cluster (to get significance)
Kruskals <- NA
for(i in unique(plotframe$Cluster)){
  testframe <- plotframe[Cluster==i]
  res <- kruskal.test(list(testframe$ClusterProportion,testframe$SampleProportion))
  Kruskals <- rbind(Kruskals,cbind(rbind(res),i))
}
Kruskals <- data.table(Kruskals)
Kruskals2 <- data.table(cbind(unlist(Kruskals$p.value),unlist(Kruskals$statistic),unlist(Kruskals$i)))
names(Kruskals2) <- c("pvalue","statistic","Cluster")
Kruskals2 <- Kruskals2[-1,]
Kruskals2$AdjustedP <- p.adjust(Kruskals2$pvalue,"fdr")

# subset associations

# get particle clustering identity and subset
ComparisonClusters <- merge(ParticleComparison_subset,clusteres[,.(Particle, seurat_clusters)],by="Particle")

#filter out clusters with nt enough observations
ComparisonClusters <- ComparisonClusters %>% group_by(seurat_clusters) %>% 
  mutate(num_particles = n()) %>% filter(num_particles > 10) %>% ungroup() %>% select(-num_particles)

#allocate blank data
AllSpearRes <- data.table(NA)

# calculate the association for each subset
for(i in unique(ComparisonClusters$seurat_clusters)){
  # subset by cluster, cast to otu table
  ClusterSub <-  filter(ComparisonClusters, seurat_clusters == i) %>% as.data.table()
  ClusterCast <- dcast.data.table(ClusterSub,Particle~OTU,value.var = "Count")
  setnafill(ClusterCast,fill=0, cols=2:ncol(ClusterCast))
  
  # get otu table for computation
  ClusterCastMat <- as.matrix(ClusterCast[,2:ncol(ClusterCast)])
  row.names(ClusterCastMat) <- ClusterCast$Particle
  
  # calculate the associations
  SpearRes <- data.table(Compute_Spearman_Correlation_And_Melt(ClusterCastMat,i,NA))
  
  # add important metadata
  SpearRes$Cluster <- i
  
  # calculate prevalence of each otu in the cluster
  OTUFrame <- ClusterSub[,.(InstancesOTU=length(Count > 1)) ,by=.(OTU)]
  OTUFrame$ParticlesInCluster <- sum(OTUFrame$InstancesOTU)
  OTUFrame$ProportionOfInstancesPerCluster <- OTUFrame$InstancesOTU/OTUFrame$ParticlesInCluster
  
  # add it to the spearman results
  SpearRes$InstancesOTU1 <- OTUFrame$InstancesOTU[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$InstancesOTU2 <- OTUFrame$InstancesOTU[match(SpearRes$OTU2,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU1 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU1,OTUFrame$OTU)]
  SpearRes$ProportionOfInstancesPerClusterOTU2 <- OTUFrame$ProportionOfInstancesPerCluster[match(SpearRes$OTU2,OTUFrame$OTU)]
  
  AllSpearRes <- rbind(AllSpearRes,SpearRes,fill=T)

}

# clean up result
AllSpearRes$V1 <- NULL
AllSpearRes <- AllSpearRes[complete.cases(AllSpearRes)]


#look at OTUs with sufficient prevalence
PrevalentSet <- AllSpearRes[InstancesOTU1 > 10 & InstancesOTU2 > 10]

#PrevalentSet Processing

#look at OTUs with sufficient prevalence
PrevalentSet <- AllSpearRes[InstancesOTU1 > 10 & InstancesOTU2 > 10]

# add significance
PrevalentSet$Significant <- PrevalentSet$SpearmanAdjustedP < .05

# order the plot
PrevalentSet$Cluster <- factor(PrevalentSet$Cluster,levels=0:max(as.numeric(PrevalentSet$Cluster)))

#subset, and rename to differentiate

#OTU1Frame <- unique(fulldataset[,.(OTU,Phylum,Class,Order,Family)])
OTU1Frame <- distinct(select(fulldataset, OTU,Phylum,Class,Order,Family))
names(OTU1Frame)[1] <- "OTU1"
names(OTU1Frame)[2:ncol(OTU1Frame)] <- paste(names(OTU1Frame)[2:ncol(OTU1Frame)],"OTU1",sep="_")

OTU2Frame <- distinct(select(fulldataset, OTU,Phylum,Class,Order,Family))
names(OTU2Frame)[1] <- "OTU2"
names(OTU2Frame)[2:ncol(OTU2Frame)] <- paste(names(OTU2Frame)[2:ncol(OTU2Frame)],"OTU2",sep="_")

# add the order to the otu names
OTU1Frame$OTU1WithOrder <- paste(OTU1Frame$OTU1,OTU1Frame$Order_OTU1,sep="_")
OTU2Frame$OTU2WithOrder <- paste(OTU2Frame$OTU2,OTU2Frame$Order_OTU2,sep="_")

# merge them
PrevalentSet <- merge(PrevalentSet,OTU1Frame,by="OTU1")
PrevalentSet <- merge(PrevalentSet,OTU2Frame,by="OTU2")

# add color for plotting

otumapping <- read.csv("../../../experiments/2021-06-09_JxE_MaPS02/2022-01-12 Miles MaPS-seq/OTU_Color_Mapping.csv") %>% select(-X)

#OTU type was determined from Analysis.R file
PrevalentSet$OTU1ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU1,otumapping$OTU1)]
PrevalentSet$OTU2ColorName <- otumapping$OTUcolor[match(PrevalentSet$OTU2,otumapping$OTU1)]
PrevalentSet$OTU1Type <- otumapping$OTU1Type[match(PrevalentSet$OTU1,otumapping$OTU1)]
PrevalentSet$OTU2Type <- otumapping$OTU1Type[match(PrevalentSet$OTU2,otumapping$OTU1)]



#name PrevalentSet & filter out OTUs that are specific to other host
assign(paste("PrevalentSet_", sample_subset, sep = ''), PrevalentSet)

#PrevalentSet <- paste("PrevalentSet_", sample_subset, sep = '')
assign(paste("PrevalentSet_", sample_subset, sep = ''),PrevalentSet)

PrevalentSet$batch <- sample_subset

#Filter out OTUs frp, 
PrevalentSet <- PrevalentSet %>% 
  filter(OTU1Type != ifelse(batch == 'Pre FMT', 'Envigo Specific', 0)) %>%
  filter(OTU2Type != ifelse(batch == 'Pre FMT', 'Envigo Specific', 0)) %>%
  filter(OTU1Type != ifelse(batch == 'Donor', 'Jackson Specific', 0)) %>%
  filter(OTU2Type != ifelse(batch == 'Donor', 'Jackson Specific', 0))

```


MaPS-Seq correlation figure for all
```{r}


#PrevalentSet <- read.table("../experiments/2021-06-09_JxE_MaPS02/OTU Correlation by Cluster more than10 instances each otu.csv", sep = ',', header = T)
#PrevalentSet$Order_OTU1[PrevalentSet$Order_OTU1 == ''] <- "zUndetermined" #replace blanks
#PrevalentSet$Order_OTU1[PrevalentSet$Order_OTU2 == ''] <- "zUndetermined"
PrevalentSet[PrevalentSet == 'Neither'] <- 'Shared Taxa'
PrevalentSet[PrevalentSet == 'Envigo Specific'] <- 'Donor Taxa'
PrevalentSet[PrevalentSet == 'Jackson Specific'] <- 'Recipient Taxa'

corplot_all <- #PrevalentSet %>% filter(InstancesOTU1 > 15 & InstancesOTU2 > 15) %>%
  ggplot(PrevalentSet,aes(tidytext::reorder_within(OTU1ColorName, InstancesOTU1, Cluster),
                                   tidytext::reorder_within(OTU2ColorName, InstancesOTU2, Cluster),
                                   fill=Correlation)) +
  geom_tile() +
#  scale_fill_gradient2(low="blue", high="darkred",midpoint = 0,limits=c(-.5,.5)) +
    scale_fill_gradient2(low="blue", high="darkred",midpoint = 0) +
  theme_cowplot() +
  theme(
    axis.text.x = ggtext::element_markdown(angle = 90, vjust = 0.35, hjust=1, size = 10),
    axis.text.y = ggtext::element_markdown()) +
  upstartr::scale_x_reordered() +
  upstartr::scale_y_reordered() +
  labs(fill = "Correlation")  +
  xlab("OTU 1") +
  ylab("OTU 2") +
  geom_point(data=function(x){x[PrevalentSet$Significant == TRUE, ]},size=.75,alpha=.7,color="black",shape=8) +
  facet_wrap(~Cluster,scales="free")

corplot_all
ggsave(paste("../../../figs/fig5/", sample_subset, "/MaPSSeq_corr_all.png", sep = ''), 
       width = 20, height = 18)
ggsave(paste("../../../figs/fig5/", sample_subset, "/MaPSSeq_corr_all.pdf", sep = ''),  
       width = 20, height = 18)


ggsave(paste("../../../figs/fig5/", sample_subset, "/MaPSSeq_order_all.pdf", sep = ''),  width = 24, height = 18)

```


Figure 5E) Network of interactions. - V1

Now lets look at how how interactions change between clusters
```{r}

library(ggraph)
library(igraph)

PrevalentSet_master <- PrevalentSets

#create master interaction set
#PrevalentSet_master <- rbind(mutate(`PrevalentSet_Post FMT`, interaction_set = "+FMT"),
#                             mutate(`PrevalentSet_Pre FMT`, interaction_set = "-FMT"),
#                             mutate(`PrevalentSet_Donor`, interaction_set = "Donor"))  

#if you don't want to rerun everything
#PrevalentSet_master <- read.csv("PrevalentSet_master.csv")
#write.csv(PrevalentSet_master, "PrevalentSet_master.csv", quote = F, row.names = F)

#PrevalentSet_master[PrevalentSet_master == 'Neither'] <- 'Shared Taxa'
#PrevalentSet_master[PrevalentSet_master == 'Envigo Specific'] <- 'Donor Taxa'
#PrevalentSet_master[PrevalentSet_master == 'Jackson Specific'] <- 'Recipient Taxa'

#bugColors <- setNames(c(scales::hue_pal()(length(unique(PrevalentSet_master$Order_OTU1)))), c(levels(as.factor(PrevalentSet_master$Order_OTU1))))

#define cluster
clustr <- 0

#Get OTUs and node info
cluster_network <- PrevalentSet_master %>%  
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
  group_by(OTU1) %>% mutate(total_instances = sum(InstancesOTU1)) %>% 
  ungroup() %>%
  filter(Cluster == clustr) #all interactions
  
#Make dummy edges
tbl_edges_all <- cluster_network %>% 
    select(OTU1, OTU2) %>% 
    mutate(interaction = 1) %>% 
    distinct()


#create node information
tbl_nodes_all <- cluster_network %>% 
  select(OTU1, Order_OTU1, total_instances, Color) %>% 
  distinct() %>%
  arrange(OTU1)


# - FMT

#Get nodes found in -FMT
tbl_nodes <- PrevalentSet_master %>% filter(MouseGroup == 'Pre FMT') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1) %>% distinct() %>%
  mutate(alpha = 1) %>% left_join(tbl_nodes_all, .) %>% replace(is.na(.), .1)


#Now layer edges for -FMT
tbl_edges<- cluster_network %>% filter(MouseGroup == 'Pre FMT') %>%
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = T)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') + 
  geom_node_point(aes(color = Order_OTU1, size = total_instances*.3, alpha = alpha)) +
  geom_node_point(aes(size = total_instances*.2), color = 'white') +
      scale_size_continuous(range = c(0, 7)) +
  labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste("MouseGroup == 'Pre FMT': Cluster", clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

a <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .2, nudge_y = nodes$data$y * .2, check_overlap=FALSE)

# Donor

#Get nodes found in Donor
tbl_nodes <- PrevalentSet_master %>% filter(MouseGroup == 'Donor') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1) %>% distinct() %>%
  mutate(alpha = 1) %>% left_join(tbl_nodes_all, .) %>% replace(is.na(.), .1)


#Now layer edges for Donor
tbl_edges<- cluster_network %>% filter(MouseGroup == "Donor") %>%
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    filter(Significant == T) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = FALSE)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue','firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
  geom_node_point(aes(color = Order_OTU1, size = total_instances*.3, alpha = alpha)) +
  geom_node_point(aes(size = total_instances*.2), color = 'white') +
      scale_size_continuous(range = c(0, 7)) +
  labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Donor: Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

b <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .2, nudge_y = nodes$data$y * .2, check_overlap=FALSE)


# +FMT

#Get nodes found in +FMT
tbl_nodes <- PrevalentSet_master %>% filter(MouseGroup == 'Post FMT') %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1)) %>% select(OTU1) %>% distinct() %>%
  mutate(alpha = 1) %>% left_join(tbl_nodes_all, .) %>% replace(is.na(.), .1)


#Now layer edges for Donor
tbl_edges<- cluster_network %>% filter(MouseGroup == "Post FMT") %>%
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    filter(Significant == T) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = FALSE)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') +
   geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
  geom_node_point(aes(color = Order_OTU1, size = total_instances*.3, alpha = alpha)) +
  geom_node_point(aes(size = total_instances*.2), color = 'white') +
      scale_size_continuous(range = c(0, 7)) +
  labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Post FMT: Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none') 

c <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .2, nudge_y = nodes$data$y * .2, check_overlap=FALSE)



leg <- cowplot::get_legend(ggraph(graph_nodes, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Correlation), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    
temp <- cowplot::plot_grid(a,b,c, nrow = 1)
temp

```







#merge node and edge data
graph_nodes <- graph_from_data_frame(tbl_edges_all, tbl_nodes_all, directed = FALSE)

#graph just nodes
nodes <- ggraph(graph_nodes, layout = 'circle') + 
  geom_node_point(aes(color = Order_OTU1, size = total_instances*.3)) +
  geom_node_point(aes(size = total_instances*.2), color = 'white') +
    geom_node_point(aes(size = total_instances), color = 'white', alpha = .4) +  #add white overlay
  labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

nodes <- nodes + geom_node_text(aes(label = name), size = 3,  nudge_x = nodes$data$x * .2, nudge_y = nodes$data$y * .2, check_overlap=FALSE)







a<- ggraph(graph_nodes, layout = 'circle') + 
    #geom_edge_link(aes(edge_width = abs(Correlation), 
    #                   alpha = Significance, 
    #                   edge_color = interaction)) +
    scale_edge_color_manual(values = c('firebrick', 'navyblue')) +
    scale_edge_width_continuous(range = c(0,5)) +
    #geom_node_point(aes(color = Order_OTU1, size = total_instances*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = total_instances*.2), color = 'white') +
    labs(color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
a <- a + geom_node_text(aes(label = name), size = 3,  nudge_x = a$data$x * .2, nudge_y = a$data$y * .2, check_overlap=FALSE) 


clustr <- 1
cluster_network <- PrevalentSet %>%  
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% 
  distinct() %>% 
  mutate(OTU1 = as.numeric(gsub('Otu', '', .$OTU1))) %>% 
  arrange(OTU1)

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)

#graph
b<-ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c('navyblue',  'firebrick')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.2), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
b <- b + geom_node_text(aes(label = name), size = 3,  nudge_x = b$data$x * .2, nudge_y = b$data$y * .2, check_overlap=FALSE) 


clustr <- 2

cluster_network <- PrevalentSet %>%  
  left_join(., data.frame(OTU1Type = c("Donor Taxa", 'Recipient Taxa', 'Shared Taxa'), 
                            Color = c('#377Ebb', '#E41A1C','#828382'))) %>%
  mutate(OTU1 = gsub('Otu', '', .$OTU1),
         OTU2 = gsub('Otu', '', .$OTU2)) %>%
    filter(Cluster == clustr, Significant == T) #only significant interactions
    #filter(Cluster == clustr)  #All OTUs regardless of if significant

tbl_edges<- cluster_network %>% 
    mutate(interaction = ifelse(Correlation > 0, 'Positive', 'Negative'),
           Significance=log10(1/Significance)) %>%
    select(OTU1, OTU2, interaction, Significance, Correlation) %>% 
    distinct()


#create node information
tbl_nodes <- cluster_network %>% 
  select(OTU1, Order_OTU1, InstancesOTU1, Color) %>% 
  distinct() %>% 
  mutate(OTU1 = as.numeric(gsub('Otu', '', .$OTU1))) %>% 
  arrange(OTU1)

#merge node and edge data
graph <- graph_from_data_frame(tbl_edges, tbl_nodes, directed = TRUE)
#graph
c <- ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = abs(Correlation), 
                       alpha = Significance, 
                       edge_color = interaction)) +
    scale_edge_color_manual(values = c( 'firebrick', 'navyblue')) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(aes(color = Order_OTU1, size = InstancesOTU1*.3)) +
    scale_size_continuous(range = c(0, 7)) +
    scale_color_manual(values = bugColors) +
    geom_node_point(aes(size = InstancesOTU1*.2), color = 'white') +
    #geom_node_point(aes(size = InstancesOTU1*.5), color = tbl_nodes$Color) +
    #geom_node_text(aes(label = name)) +
    labs(fill = 'Interaction Significance', color = 'Order', 
         title = paste('Cluster', clustr, sep = ' ')) +
    theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'none')

#add labels radially
c <- c + geom_node_text(aes(label = name), size = 3,  nudge_x = c$data$x * .2, nudge_y = c$data$y * .2, check_overlap=FALSE) 

leg <- cowplot::get_legend(ggraph(graph, layout = 'circle') + 
    geom_edge_link(aes(edge_width = Correlation), alpha =.4) +
    scale_edge_width_continuous(range = c(0,5)) +
    geom_node_point(size = 14, aes(color = Order_OTU1)) +
    scale_color_manual(values = bugColors) +labs(color = 'Order') +
      theme(panel.background = element_blank(),
          legend.text = element_text(size = 12),
          plot.title = element_text(hjust = 0.5, size = 16),
          legend.key = element_blank(),
          legend.position = 'bottom'))
    
temp <- cowplot::plot_grid(a,b,c, nrow = 1)
temp
```


```





